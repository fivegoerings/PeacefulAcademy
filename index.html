<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Peaceful Academy — Kansas City, Missouri</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#0b1226">
<style>
:root{--bg:#0f172a;--card:#0b1226;--ink:#e5e7eb;--muted:#94a3b8;--border:#1f2937;--accent:#22c55e;--accent2:#06b6d4;--danger:#ef4444;--ok:#10b981}
*{box-sizing:border-box}html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:1100px;margin:0 auto;padding:24px}
.topbar{position:sticky;top:0;z-index:3;background:rgba(15,23,42,.86);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
nav{display:flex;gap:.5rem;flex-wrap:wrap}
nav a{padding:.5rem .8rem;border-radius:999px;border:1px solid var(--border);background:#0a1123;color:inherit;text-decoration:none}
nav a.active{background:linear-gradient(135deg,#1e293b,#0b1226)}
h1{font-size:1.4rem;margin:.6rem 0 .2rem} h2{font-size:1.15rem;margin:.2rem 0 .6rem;color:#d1d5db}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1rem}
.grid{display:grid;gap:1rem}.two{grid-template-columns:1fr 1fr}.three{grid-template-columns:repeat(3,1fr)}@media(max-width:800px){.two,.three{grid-template-columns:1fr}}
label{font-weight:600}.row{display:flex;gap:1rem;flex-wrap:wrap;align-items:center}
input,select,textarea,button{font:inherit;color:inherit}
input,select,textarea{width:100%;background:#0b1226;border:1px solid var(--border);border-radius:10px;padding:.55rem .7rem}
button{border:1px solid var(--border);background:#0a1123;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
button.primary{background:linear-gradient(135deg,#0ea5e9,#22c55e);border:none;color:white}
button.ghost{background:transparent;border:1px dashed var(--border)}
button.danger{background:var(--danger);border:none;color:white}
table{width:100%;border-collapse:collapse}th,td{padding:.5rem;border-bottom:1px solid var(--border);text-align:left}tr:hover td{background:#0c142a}
.right{text-align:right}.muted{color:var(--muted)}.hide{display:none !important}.num{font-weight:800;font-size:1.6rem}
.bar{height:10px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:#0a1123}.bar>span{display:block;height:100%;background:linear-gradient(90deg,#22c55e,#06b6d4)}
.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}.tile{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#0a1123}
.pill{padding:.25rem .5rem;border-radius:999px;border:1px solid var(--border)}
footer{margin:3rem 0 2rem;color:var(--muted);text-align:center}
.diploma-page{background:linear-gradient(180deg,#ffffff,#f8fafc);color:#111827;border:8px double #d1d5db;border-radius:12px;padding:48px;position:relative}
.watermark{position:absolute;inset:0;opacity:0.06;background:url('assets/icon.svg') center/60% no-repeat;pointer-events:none}
@media print{ nav,.no-print{display:none !important} .diploma-page{box-shadow:none} body{background:white}}
</style>
</head>
<body>
<header class="topbar">
  <div class="wrap">
    <h1>Peaceful Academy • Kansas City, MO</h1>
    <nav id="nav">
      <a href="#dashboard" class="active">Dashboard</a>
      <a href="#students">Students</a>
      <a href="#courses">Courses</a>
      <a href="#log">Log Hours</a>
      <a href="#portfolio">Portfolio</a>
      <a href="#reports">Reports</a>
      <a href="#database">Database</a>
      <a href="#transcript">Transcript</a>
      <a href="#diploma">Diploma</a>
      <a href="#settings">Settings</a>
      <a href="#help">Help</a>
    </nav>
  </div>
</header>

<form name="log-entry" data-netlify="true" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" /><input type="text" name="student" /><input type="text" name="course" /><input type="text" name="subject" /><input type="text" name="date" /><input type="text" name="hours" /><input type="text" name="location" /><input type="text" name="notes" />
</form>
<form name="student" data-netlify="true" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" /><input type="text" name="name" /><input type="text" name="dob" /><input type="text" name="grade" /><input type="text" name="startYear" /><input type="text" name="notes" />
</form>
<form name="course" data-netlify="true" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" /><input type="text" name="title" /><input type="text" name="subject" /><input type="text" name="description" />
</form>
<form name="portfolio-upload" data-netlify="true" enctype="multipart/form-data" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" /><input type="text" name="student" /><input type="text" name="course" /><input type="text" name="date" /><input type="text" name="title" /><input type="text" name="tags" /><input type="text" name="description" /><input type="file" name="file" />
</form>

<main class="wrap">
  <section id="view-dashboard" class="view">
    <div class="card"><h2>Welcome</h2>Quick KPIs and Quick Add are in the full version; this build focuses on database health and core tracking to keep things compact for the demo.</div>
  </section>

  <section id="view-students" class="view hide">
    <div class="card"><h2>Students</h2>
      <div class="grid two">
        <div class="card">
          <div class="grid two">
            <div><label>Name</label><input id="stName"></div>
            <div><label>DOB</label><input type="date" id="stDob"></div>
            <div><label>Grade</label><input id="stGrade"></div>
            <div><label>Start Year</label><input id="stStart" placeholder="e.g., 2024"></div>
          </div>
          <label>Notes</label><textarea id="stNotes" rows="3"></textarea>
          <div class="row" style="margin-top:.6rem"><button class="primary" id="stSave">Add Student</button></div>
        </div>
        <div><table id="stTable"><thead><tr><th>Name</th><th>DOB</th><th>Grade</th><th>Start</th></tr></thead><tbody></tbody></table></div>
      </div>
    </div>
  </section>

  <section id="view-courses" class="view hide">
    <div class="card"><h2>Courses</h2>
      <div class="grid two">
        <div class="card">
          <div class="grid two">
            <div><label>Course Title</label><input id="coTitle"></div>
            <div><label>Subject</label>
              <select id="coSubject">
                <option>Language Arts</option><option>Reading</option><option>Mathematics</option><option>Science</option><option>Social Studies</option><option>Elective</option>
              </select>
            </div>
          </div>
          <label>Description</label><textarea id="coDesc" rows="3"></textarea>
          <div class="row" style="margin-top:.6rem"><button class="primary" id="coSave">Add Course</button></div>
        </div>
        <div><table id="coTable"><thead><tr><th>Course</th><th>Subject</th><th>Description</th></tr></thead><tbody></tbody></table></div>
      </div>
    </div>
  </section>

  <section id="view-database" class="view hide">
    <div class="card">
      <h2>Database</h2>
      <div class="grid two">
        <div class="card">
          <h3 style="margin-top:0">Connection Health</h3>
          <div class="row">
            <button id="dbHealthBtn" class="primary">Run health check</button>
            <span class="pill">Browser: <span id="dbNetState">unknown</span></span>
          </div>
          <div id="dbHealthOut" style="margin-top:.8rem" class="muted">Not checked yet.</div>
        </div>
        <div class="card">
          <h3 style="margin-top:0">Row Counts</h3>
          <div class="row"><button id="dbStatsBtn">Refresh counts</button></div>
          <table id="dbStatsTbl" style="margin-top:.8rem">
            <thead><tr><th>Table</th><th class="right">Rows</th></tr></thead>
            <tbody>
              <tr><td>students</td><td class="right" id="c_students">—</td></tr>
              <tr><td>courses</td><td class="right" id="c_courses">—</td></tr>
              <tr><td>logs</td><td class="right" id="c_logs">—</td></tr>
              <tr><td>portfolio</td><td class="right" id="c_portfolio">—</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <section id="view-transcript" class="view hide">
    <div class="card"><h2>Transcript (Print)</h2><div class="muted">Use the full build to auto-calc from logs. This minimal build focuses on DB health demo.</div></div>
  </section>

  <section id="view-diploma" class="view hide">
    <div class="card"><h2>Diploma</h2><div class="muted">Included in full build. This demo keeps the essentials.</div></div>
  </section>

  <section id="view-settings" class="view hide">
    <div class="card"><h2>Settings</h2>
      <div class="grid two">
        <div class="card">
          <div class="grid two">
            <div><label>School Name</label><input id="scName" value="Peaceful Academy of Kansas City, Missouri"></div>
            <div><label>Year Starts</label><select id="scYearStart"><option value="07-01" selected>July 1</option></select></div>
          </div>
          <div class="row" style="margin-top:.6rem"><button class="primary" id="scSave">Save</button></div>
        </div>
      </div>
    </div>
  </section>

  <section id="view-help" class="view hide"><div class="card">
    <h2>Help & Missouri Notes</h2>
    <ul>
      <li>Track at least 1,000 hours with 600 core and 400 core at home.</li>
      <li>Plan book (log), portfolio, and evaluation notes are supported.</li>
      <li>Works offline (PWA), mirrors to Netlify Forms, writes to Neon via Netlify Functions.</li>
    </ul>
  </div></section>
</main>

<footer>© <span id="yearNow"></span> Peaceful Academy • Kansas City, MO</footer>

<script>
if ('serviceWorker' in navigator) { window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js')); }

const $ = s=>document.querySelector(s), $$ = s=>Array.from(document.querySelectorAll(s));
const todayISO = ()=> new Date().toISOString().slice(0,10);
const fmt = new Intl.NumberFormat();

function show(view){ $$('.view').forEach(v=>v.classList.add('hide')); $('#view-'+view).classList.remove('hide'); $$('#nav a').forEach(a=>a.classList.remove('active')); $(`#nav a[href="#${view}"]`)?.classList.add('active'); }
window.addEventListener('hashchange', ()=>{ const v=(location.hash||'#dashboard').slice(1); show(v); if(v==='database') renderDatabase(); if(v==='students') renderStudents(); if(v==='courses') renderCourses(); });

/* Simple IndexedDB for demo (students & courses only) */
let db; (function openDB(){ const req=indexedDB.open('peacefulAcademyDB',1); req.onupgradeneeded=e=>{const d=e.target.result; d.createObjectStore('students',{keyPath:'id',autoIncrement:true}); d.createObjectStore('courses',{keyPath:'id',autoIncrement:true});}; req.onsuccess=()=>{db=req.result; init();}; })();
function tx(names,mode='readonly'){ return db.transaction(names,mode); }
const DB={ add:(s,o)=>new Promise((res,rej)=>{const r=tx([s],'readwrite').objectStore(s).add(o); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error)}), all:(s)=>new Promise((res,rej)=>{const r=tx([s]).objectStore(s).getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=()=>rej(r.error)}) };

async function netlifySubmit(formName, data){ try{ const encode=d=>Object.keys(d).map(k=> encodeURIComponent(k)+'='+encodeURIComponent(d[k])).join('&'); await fetch('/', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: encode(Object.assign({'form-name': formName, 'bot-field':''}, data)) }); } catch(e){} }

/* Neon helpers */
async function saveToNeon(kind, data){
  try{ await fetch('/.netlify/functions/db', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ action: kind + '.insert', data }) }); }
  catch(e){ console.warn('Neon save failed', e); }
}
async function safeJSON(res){
  try { return await res.json(); } catch(e){
    const t = await res.text().catch(()=>'');
    throw new Error(`Invalid JSON (status ${res.status}): ${t.slice(0,200)}`);
  }
}
async function dbHealth(){
  try{
    const r = await fetch('/.netlify/functions/api/health', { method:'GET' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await safeJSON(r);
  }catch(e){
    const r2 = await fetch('/.netlify/functions/db?action=health', { method:'GET' });
    if (!r2.ok) throw new Error(`HTTP ${r2.status}`);
    return await safeJSON(r2);
  }
}
async function dbStats(){
  try{
    const r = await fetch('/.netlify/functions/api/stats', { method:'GET' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await safeJSON(r);
  }catch(e){
    const r2 = await fetch('/.netlify/functions/db?action=stats', { method:'GET' });
    if (!r2.ok) throw new Error(`HTTP ${r2.status}`);
    return await safeJSON(r2);
  }
}


/* Views */
async function renderStudents(){ const s=await DB.all('students'); const tb=$('#stTable tbody'); tb.innerHTML=''; s.forEach(x=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${x.name}</td><td>${x.dob||''}</td><td>${x.grade||''}</td><td>${x.startYear||''}</td>`; tb.appendChild(tr); }); }
async function renderCourses(){ const s=await DB.all('courses'); const tb=$('#coTable tbody'); tb.innerHTML=''; s.forEach(x=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${x.title}</td><td>${x.subject||''}</td><td>${x.description||''}</td>`; tb.appendChild(tr); }); }

async function renderDatabase(){
  const setNet=()=>{ const el=document.getElementById('dbNetState'); if(el) el.textContent = navigator.onLine? 'online' : 'offline'; };
  setNet(); window.addEventListener('online', setNet); window.addEventListener('offline', setNet);

  const out=document.getElementById('dbHealthOut'); if(out) out.textContent='Checking…';
  try{
    const h=await dbHealth();
    if(h && h.ok){ out.textContent=`OK • server time: ${h.now} • ${h.version}`; } else { out.textContent='Health check failed: '+(h && h.error || 'unknown'); }
  }catch(e){ out.textContent='Health check error: '+e.message; }

  try{
    const s=await dbStats(); const st=s && s.stats ? s.stats : {};
    const set = (id,v)=>{ const el=document.getElementById(id); if(el) el.textContent = (v!=null? v : '0'); };
    set('c_students', st.students); set('c_courses', st.courses); set('c_logs', st.logs); set('c_portfolio', st.portfolio);
  }catch(e){}

  document.getElementById('dbHealthBtn')?.addEventListener('click', async()=>{
    const out=document.getElementById('dbHealthOut'); if(out) out.textContent='Checking…';
    try{ const h=await dbHealth(); if(h && h.ok){ out.textContent=`OK • server time: ${h.now} • ${h.version}`; } else { out.textContent='Health failed: '+(h && h.error || 'unknown'); } }catch(e){ out.textContent='Health error: '+e.message; }
  });
  document.getElementById('dbStatsBtn')?.addEventListener('click', async()=>{
    try{ const s=await dbStats(); const st=s.stats||{}; const set=(id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=(v!=null? v : '0'); }; set('c_students', st.students); set('c_courses', st.courses); set('c_logs', st.logs); set('c_portfolio', st.portfolio); }catch(e){}
  });
}

/* Events */
$('#stSave')?.addEventListener('click', async()=>{
  const obj={ name:$('#stName').value.trim(), dob:$('#stDob').value||'', grade:$('#stGrade').value.trim(), startYear:$('#stStart').value.trim(), notes:$('#stNotes').value.trim() };
  if(!obj.name) return alert('Name required');
  await DB.add('students', obj);
  await netlifySubmit('student', {name:obj.name, dob:obj.dob, grade:obj.grade, startYear:String(obj.startYear), notes:obj.notes});
  await saveToNeon('student', obj);
  $('#stName').value=''; $('#stDob').value=''; $('#stGrade').value=''; $('#stStart').value=''; $('#stNotes').value='';
  renderStudents();
});

async function init(){ if(!location.hash) location.hash='#database'; document.getElementById('yearNow').textContent=new Date().getFullYear(); const v=(location.hash||'#database').slice(1); show(v); if(v==='database') renderDatabase(); }
</script>
</body>
</html>
