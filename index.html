<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Peaceful Academy — Kansas City, Missouri</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Missouri-compliant homeschool hours, courses, portfolio tracker with Netlify Forms, Neon DB, and PWA." />
    <meta name="theme-color" content="#0b1226" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="./manifest.webmanifest">

<!-- Favicons -->
<link rel="icon" href="./favicon.svg" type="image/svg+xml" />
<link rel="icon" href="./favicon.ico" sizes="any" />
<link rel="apple-touch-icon" href="./apple-touch-icon.png" />
<style>
:root{--bg:#0f172a;--card:#0b1226;--ink:#e5e7eb;--muted:#94a3b8;--border:#1f2937;--accent:#22c55e;--accent2:#06b6d4;--danger:#ef4444;--ok:#10b981}
*{box-sizing:border-box}html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:1100px;margin:0 auto;padding:24px}
.topbar{position:sticky;top:0;z-index:3;background:rgba(15,23,42,.86);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
.topbar .wrap{display:flex;justify-content:space-between;align-items:center}
.hamburger{display:none;flex-direction:column;gap:4px;background:none;border:none;cursor:pointer;padding:8px}
.hamburger span{width:24px;height:3px;background:var(--ink);border-radius:2px;transition:all 0.3s ease}
.hamburger.active span:nth-child(1){transform:rotate(45deg) translate(6px,6px)}
.hamburger.active span:nth-child(2){opacity:0}
.hamburger.active span:nth-child(3){transform:rotate(-45deg) translate(6px,-6px)}
nav{display:flex;gap:.5rem;flex-wrap:wrap}
nav a{padding:.5rem .8rem;border-radius:999px;border:1px solid var(--border);background:#0a1123;color:inherit;text-decoration:none;transition:all 0.2s ease}
nav a.active{background:linear-gradient(135deg,#1e293b,#0b1226)}
nav a.admin-link{background:linear-gradient(135deg,#dc2626,#b91c1c);color:white;border-color:#dc2626}
nav a.admin-link:hover{background:linear-gradient(135deg,#b91c1c,#991b1b)}
@media(max-width:768px){
  .hamburger{display:flex}
  nav{position:absolute;top:100%;left:0;right:0;background:rgba(15,23,42,.95);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);flex-direction:column;padding:1rem;transform:translateY(-100%);opacity:0;visibility:hidden;transition:all 0.3s ease}
  nav.active{transform:translateY(0);opacity:1;visibility:visible}
  nav a{border-radius:8px;margin-bottom:0.5rem}
}
h1{font-size:1.4rem;margin:.6rem 0 .2rem} h2{font-size:1.15rem;margin:.2rem 0 .6rem;color:#d1d5db}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1rem}
.grid{display:grid;gap:1rem}.two{grid-template-columns:1fr 1fr}.three{grid-template-columns:repeat(3,1fr)}.four{grid-template-columns:repeat(4,1fr)}@media(max-width:800px){.two,.three,.four{grid-template-columns:1fr}}
label{font-weight:600}.row{display:flex;gap:1rem;flex-wrap:wrap;align-items:center}
input,select,textarea,button{font:inherit;color:inherit}
input,select,textarea{width:100%;background:#0b1226;border:1px solid var(--border);border-radius:10px;padding:.55rem .7rem}
button{border:1px solid var(--border);background:#0a1123;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
button.primary{background:linear-gradient(135deg,#0ea5e9,#22c55e);border:none;color:white}
button.ghost{background:transparent;border:1px dashed var(--border)}
button.danger{background:var(--danger);border:none;color:white}
.admin-button:hover{background:linear-gradient(135deg,#b91c1c,#991b1b) !important;transform:translateY(-1px);box-shadow:0 4px 12px rgba(220,38,38,0.3)}
table{width:100%;border-collapse:collapse}th,td{padding:.5rem;border-bottom:1px solid var(--border);text-align:left}tr:hover td{background:#0c142a}
.right{text-align:right}.muted{color:var(--muted)}.hide{display:none !important}.num{font-weight:800;font-size:1.6rem}
.bar{height:10px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:#0a1123}.bar>span{display:block;height:100%;background:linear-gradient(90deg,#22c55e,#06b6d4)}
.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}.tile{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#0a1123}
.pill{padding:.25rem .5rem;border-radius:999px;border:1px solid var(--border)}
footer{margin:3rem 0 2rem;color:var(--muted);text-align:center}
.diploma-page{background:linear-gradient(180deg,#ffffff,#f8fafc);color:#111827;border:8px double #d1d5db;border-radius:12px;padding:48px;position:relative}
.watermark{position:absolute;inset:0;opacity:0.06;background:url('assets/icon.svg') center/60% no-repeat;pointer-events:none}
@media print{ nav,.no-print{display:none !important} .diploma-page{box-shadow:none} body{background:white}}
</style>
</head>
<body>
<header class="topbar">
  <div class="wrap">
    <h1>Peaceful Academy • Kansas City, MO</h1>
    <button class="hamburger" id="hamburger" aria-label="Toggle menu">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <nav id="nav">
      <a href="#dashboard" class="active">Dashboard</a>
      <a href="#students">Students</a>
      <a href="#courses">Courses</a>
      <a href="#log">Log Hours</a>
      <a href="#portfolio">Portfolio</a>
      <a href="#reports">Reports</a>
      <a href="#transcript">Transcript</a>
      <a href="#diploma">Diploma</a>
      <a href="#settings">Settings</a>
      <a href="#help">Help</a>
      <a href="./admin/index.html" target="_blank" class="admin-link">Admin</a>
    </nav>
  </div>
</header>

<!-- Netlify hidden forms to enable Netlify Forms UI -->
<form name="log-entry" data-netlify="true" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" /><input type="text" name="student" /><input type="text" name="course" /><input type="text" name="subject" /><input type="text" name="date" /><input type="text" name="hours" /><input type="text" name="location" /><input type="text" name="notes" />
</form>
<form name="student" data-netlify="true" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" /><input type="text" name="name" /><input type="text" name="dob" /><input type="text" name="grade" /><input type="text" name="startYear" /><input type="text" name="notes" />
</form>
<form name="course" data-netlify="true" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" /><input type="text" name="title" /><input type="text" name="subject" /><input type="text" name="description" />
</form>
<form name="portfolio-upload" data-netlify="true" enctype="multipart/form-data" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" /><input type="text" name="student" /><input type="text" name="course" /><input type="text" name="date" /><input type="text" name="title" /><input type="text" name="tags" /><input type="text" name="description" /><input type="file" name="file" />
</form>

<main class="wrap">
  <section id="view-dashboard" class="view">
    <div class="grid two">
      <div class="card">
        <h2>Progress</h2>
        <div class="row">
          <div style="flex:1" class="card"><div class="muted">Total Hours (1000)</div><div class="num" id="kpiTotal">0</div><div class="bar"><span id="barTotal" style="width:0%"></span></div></div>
          <div style="flex:1" class="card"><div class="muted">Core (600)</div><div class="num" id="kpiCore">0</div><div class="bar"><span id="barCore" style="width:0%"></span></div></div>
          <div style="flex:1" class="card"><div class="muted">Core @ Home (400)</div><div class="num" id="kpiHome">0</div><div class="bar"><span id="barHome" style="width:0%"></span></div></div>
          <div style="flex:1" class="card"><div class="muted">Non-Core</div><div class="num" id="kpiNonCore">0</div><div class="bar"><span id="barNonCore" style="width:0%"></span></div></div>
        </div>
        <div class="row" style="margin-top:1rem">
          <div style="flex:1" class="card"><div class="muted">Avg Daily Hours</div><div class="num" id="kpiAvgDaily">0</div><div class="bar"><span id="barAvgDaily" style="width:0%"></span></div></div>
          <div style="flex:1" class="card"><div class="muted">Days Attended</div><div class="num" id="kpiDaysAttended">0</div><div class="bar"><span id="barDaysAttended" style="width:0%"></span></div></div>
        </div>
        <div class="row" style="margin-top:1rem">
          <div style="flex:1"><label>Student</label><select id="dashStudent"></select></div>
          <div style="flex:1"><label>Academic Year</label><select id="dashYear"></select></div>
        </div>
        <table id="recentTable" style="margin-top:.8rem"><thead><tr><th>Date</th><th>Course</th><th class="right">Hours</th><th>Loc</th><th>Notes</th></tr></thead><tbody></tbody></table>
        <div class="row" style="margin-top:1rem">
          <button class="admin-button" onclick="window.open('./admin/index.html', '_blank')" style="background:linear-gradient(135deg,#dc2626,#b91c1c);border:none;color:white;padding:.75rem 1.5rem;border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.2s ease;">
            <span style="margin-right:8px;">⚙️</span>Open Admin Panel
          </button>
        </div>
      </div>
      <div class="card">
        <h2>Quick Add</h2>
        <div class="grid two">
          <div><label>Student</label><select id="qaStudent"></select></div>
          <div><label>Course</label><select id="qaCourse"></select></div>
          <div><label>Date</label><input type="date" id="qaDate"></div>
          <div><label>Hours</label><input type="number" step="0.25" min="0" id="qaHours"></div>
          <div><label>Location</label><select id="qaLocation"><option value="home">Home</option><option value="offsite">Offsite</option></select></div>
          <div><label>Notes</label><input id="qaNotes" placeholder="Lesson, lab, trip…"></div>
        </div>
        <div class="row" style="margin-top:.6rem"><button class="primary" id="qaAdd">Add Hours</button><button class="ghost" id="qaToday">Today</button></div>
      </div>
    </div>
  </section>

  <section id="view-students" class="view hide">
    <div class="card"><h2>Students</h2>
      <div class="grid two">
        <div class="card">
          <div class="grid two">
            <div><label>Name</label><input id="stName"></div>
            <div><label>DOB</label><input type="date" id="stDob"></div>
            <div><label>Grade</label><input id="stGrade"></div>
            <div><label>Start Year</label><select id="stStart"></select></div>
          </div>
          <label>Notes</label><textarea id="stNotes" rows="3"></textarea>
          <div class="row" style="margin-top:.6rem"><button class="primary" id="stSave">Add Student</button><button class="ghost" id="stClear">Clear</button></div>
        </div>
        <div><table id="stTable"><thead><tr><th>Name</th><th>DOB</th><th>Grade</th><th>Start</th><th></th></tr></thead><tbody></tbody></table></div>
      </div>
    </div>
  </section>

  <section id="view-courses" class="view hide">
    <div class="card"><h2>Courses & Subjects</h2>
      <div class="grid two">
        <div class="card">
          <div class="grid two">
            <div><label>Course Title</label><input id="coTitle"></div>
            <div><label>Subject</label>
              <select id="coSubject">
                <option>Language Arts</option><option>Reading</option><option>Mathematics</option><option>Science</option><option>Social Studies</option><option>Elective</option>
              </select>
            </div>
          </div>
          <label>Description</label><textarea id="coDesc" rows="3" placeholder="Objectives, materials… (plan book)"></textarea>
          <div class="row" style="margin-top:.6rem"><button class="primary" id="coSave">Add Course</button><button class="ghost" id="coClear">Clear</button></div>
        </div>
        <div><table id="coTable"><thead><tr><th>Course</th><th>Subject</th><th>Description</th><th></th></tr></thead><tbody></tbody></table></div>
      </div>
      <div class="muted">Core subjects (Missouri): Reading, Language Arts, Mathematics, Science, Social Studies.</div>
    </div>
  </section>

  <section id="view-log" class="view hide">
    <div class="card"><h2>Daily Log</h2>
      <div class="grid three">
        <div><label>Student</label><select id="lgStudent"></select></div>
        <div><label>Course</label><select id="lgCourse"></select></div>
        <div><label>Date</label><input type="date" id="lgDate"></div>
        <div><label>Hours</label><input type="number" step="0.25" min="0" id="lgHours"></div>
        <div><label>Location</label><select id="lgLocation"><option value="home">Home</option><option value="offsite">Offsite</option></select></div>
        <div><label>Notes</label><input id="lgNotes" placeholder="Activity details"></div>
      </div>
      <div class="row" style="margin-top:.6rem"><button class="primary" id="lgAdd">Add Entry</button><button class="ghost" id="lgToday2">Today</button></div>

      <div class="row" style="margin-top:1rem">
        <div style="flex:1"><label>Filter Year</label><select id="lgYearFilter"></select></div>
        <div style="flex:1"><label>Filter Student</label><select id="lgStudentFilter"></select></div>
        <div style="flex:1"><label>Filter Subject</label>
          <select id="lgSubjectFilter">
            <option value="">All</option><option>Language Arts</option><option>Reading</option><option>Mathematics</option><option>Science</option><option>Social Studies</option><option>Elective</option>
          </select>
        </div>
        <div class="row"><button id="exportCSV">Export CSV</button><button id="exportJSON">Backup (JSON)</button><label class="pill muted">Import JSON <input id="importJSON" type="file" accept="application/json" style="display:none"></label></div>
      </div>
      <table id="lgTable"><thead><tr><th>Date</th><th>Student</th><th>Course</th><th>Subject</th><th class="right">Hours</th><th>Loc</th><th>Notes</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="view-portfolio" class="view hide">
    <div class="card"><h2>Portfolio: Work Samples</h2>
      <div class="grid two">
        <div class="card">
          <div class="grid two">
            <div><label>Student</label><select id="pfStudent"></select></div>
            <div><label>Course</label><select id="pfCourse"></select></div>
            <div><label>Date</label><input type="date" id="pfDate"></div>
            <div><label>File</label><input type="file" id="pfFile" accept="image/*,application/pdf"></div>
            <div><label>Title</label><input id="pfTitle" placeholder="Essay, lab, test…"></div>
            <div><label>Tags</label><input id="pfTags" placeholder="draft, test, project"></div>
          </div>
          <label>Description</label><textarea id="pfDesc" rows="3"></textarea>
          <div class="row" style="margin-top:.6rem"><button class="primary" id="pfSave">Add to Portfolio</button><button class="ghost" id="pfClear">Clear</button></div>
          <div class="muted">Files stored locally; metadata also saved to Netlify Forms and Neon.</div>
        </div>
        <div>
          <div class="row">
            <div style="flex:1"><label>Filter Year</label><select id="pfYearFilter"></select></div>
            <div style="flex:1"><label>Filter Student</label><select id="pfStudentFilter"></select></div>
            <div style="flex:1"><label>Filter Subject</label><select id="pfSubjectFilter"><option value="">All</option><option>Language Arts</option><option>Reading</option><option>Mathematics</option><option>Science</option><option>Social Studies</option><option>Elective</option></select></div>
          </div>
          <div id="pfGallery" class="gallery" style="margin-top:12px"></div>
        </div>
      </div>
    </div>
  </section>

  <section id="view-reports" class="view hide">
    <div class="card"><h2>Annual Compliance Report</h2>
      <div class="grid three">
        <div><label>Student</label><select id="rpStudent"></select></div>
        <div><label>Academic Year</label><select id="rpYear"></select></div>
        <div><label>Group By</label><select id="rpGroupBy"><option value="subject">Subject</option><option value="course">Course</option><option value="month">Month</option></select></div>
      </div>
              <div id="rpSummary" class="grid four" style="margin-top:12px"></div>
      <table id="rpTable" style="margin-top:12px"><thead><tr><th>Group</th><th class="right">Hours</th><th class="right">Home (core)</th><th class="right">Non-Core</th></tr></thead><tbody></tbody></table>
      <div class="row" style="margin-top:12px"><button id="rpPrint">Print Report</button></div>
    </div>
  </section>

  <section id="view-transcript" class="view hide">
    <div class="card"><h2>High School Transcript (Printable)</h2>
      <div class="grid three">
        <div><label>Student</label><select id="trStudent"></select></div>
        <div><label>Include Years</label><select id="trYears" multiple size="4"></select></div>
        <div><label>Scale</label><select id="trScale"><option value="120">Carnegie (120 hrs = 1.0 credit)</option><option value="135">Block (135 hrs)</option></select></div>
      </div>
      <div class="grid two" style="margin-top:12px">
        <div><label>Administrator Name</label><input id="trAdmin" placeholder="Administrator / Parent"></div>
        <div><label>Issue Date</label><input type="date" id="trIssue"></div>
      </div>
      <div class="row" style="margin-top:12px"><button id="trBuild" class="primary">Build Transcript</button><button id="trPrint">Print Transcript</button></div>
      <div id="trOut" style="margin-top:16px"></div>
    </div>
  </section>

  <section id="view-diploma" class="view hide">
    <div class="card"><h2>Diploma Generator (Printable)</h2>
      <div class="grid two">
        <div><label>Student</label><select id="dpStudent"></select></div>
        <div><label>Graduation Date</label><input type="date" id="dpDate"></div>
        <div><label>City, State</label><input id="dpPlace" value="Kansas City, Missouri"></div>
        <div><label>Administrator Title</label><input id="dpTitleA" value="Administrator"></div>
        <div><label>Second Title</label><input id="dpTitleB" value="Parent/Guardian"></div>
      </div>
      <div class="row" style="margin-top:12px"><button id="dpPreview" class="primary">Preview</button><button id="dpPrint">Print Diploma</button></div>
      <div id="dpOut" style="margin-top:16px"></div>
    </div>
  </section>

  <section id="view-settings" class="view hide">
    <div class="card"><h2>Settings & Backups</h2>
      <div class="grid two">
        <div class="card">
          <div class="grid two">
            <div><label>School Name</label><input id="scName" value="Peaceful Academy of Kansas City, Missouri"></div>
            <div><label>Phone</label><input id="scPhone"></div>
            <div><label>Address</label><input id="scAddress" placeholder="Street, Kansas City, MO"></div>
            <div><label>Year Starts</label><select id="scYearStart"><option value="07-01" selected>July 1</option><option value="08-01">August 1</option><option value="09-01">September 1</option></select></div>
          </div>
          <div class="row" style="margin-top:.6rem"><button class="primary" id="scSave">Save</button><button class="ghost" id="scReset">Reset</button></div>
        </div>
        <div class="card">
          <h3 style="margin-top:0">Data</h3>
          <div class="row">
            <button id="scExportAll">Export ALL (JSON)</button>
            <label class="pill muted">Import ALL <input type="file" id="scImportAll" accept="application/json" style="display:none"></label>
            <button class="danger" id="scWipe">Erase Everything</button>
            <button id="scExportNeon" title="Push all local data to Neon (upsert)">Export to Neon</button>
            <button id="scImportNeon" title="Replace local data with Neon data">Import from Neon</button>
            <button id="scBackupNeon" title="Save a full JSON snapshot into Neon backups">Backup to Neon</button>
            <button id="scRestoreNeon" title="Replace local data with the latest Neon backup">Restore from Neon</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="view-help" class="view hide"><div class="card">
    <h2>Help & Missouri Notes</h2>
    <ul>
      <li>Track at least <strong>1,000</strong> hours per student, with <strong>600 core</strong> in Reading/Language Arts/Math/Social Studies/Science and <strong>400 core @ home</strong>.</li>
      <li>Maintain a plan book/diary (Daily Log), a portfolio of work (Portfolio), and evaluations/assessments (attach notes/files).</li>
      <li>School year defaults to <strong>July 1 – June 30</strong>. Adjust in Settings if needed.</li>
      <li>This app works offline (PWA), mirrors to Netlify Forms, and writes to Neon Postgres via Netlify Functions.</li>
      <li><a href="/admin/console.html" target="_blank">Open Log Console</a> to see recent app messages/errors.</li>
    </ul>
  </div></section>
</main>

<footer>© <span id="yearNow"></span> Peaceful Academy • Kansas City, MO</footer>

<script>
if ('serviceWorker' in navigator) { window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js')); }

const $ = s=>document.querySelector(s), $$ = s=>Array.from(document.querySelectorAll(s));
const fmt = new Intl.NumberFormat(undefined,{maximumFractionDigits:2});

// Log console sink shared with Admin Console
const LOG_STORAGE_KEY = 'pa_log_console_v1';
function appendLog(level, parts){
  try{
    const now=new Date().toISOString();
    const entry={ ts:now, level, msg: (parts||[]).map(p=>{ try{ return typeof p==='string'? p : JSON.stringify(p); }catch(_){ return String(p);} }).join(' ') };
    const arr=JSON.parse(localStorage.getItem(LOG_STORAGE_KEY)||'[]');
    arr.push(entry);
    if(arr.length>2000) arr.splice(0, arr.length-2000);
    localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(arr));
  }catch(_){/* ignore */}
}
['log','info','warn','error'].forEach(l=>{ const orig=console[l]; console[l]=function(){ try{ appendLog(l, Array.from(arguments)); }catch(_){ } return orig.apply(console, arguments); }; });
window.addEventListener('error', e=>{ appendLog('error', [e.message||'error', e.filename||'', String(e.lineno||''), String(e.colno||'')]); });
window.addEventListener('unhandledrejection', e=>{ appendLog('error', ['unhandledrejection', String(e.reason&&e.reason.message||e.reason||'')]); });

// Fix timezone handling for dates
const todayISO = ()=> {
  const now = new Date();
  // Use local timezone to avoid date shifting issues
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

// Enhanced date validation
const isValidDate = (dateString) => {
  if (!dateString) return false;
  const date = new Date(dateString);
  return !isNaN(date.getTime()) && date <= new Date();
};

const CORE = new Set(['Reading','Language Arts','Mathematics','Science','Social Studies']);

// Cache for object URLs to prevent memory leaks
const objectUrlCache = new Map();

// Input validation helpers
function validateHours(hours) {
  const num = Number(hours);
  return !isNaN(num) && num >= 0.25 && num <= 24;
}

function validateDate(date) {
  return isValidDate(date);
}

function validateRequired(value) {
  return value && value.trim().length > 0;
}

// Enhanced validation for student data
function validateStudentData(data) {
  const errors = [];
  if (!validateRequired(data.name)) errors.push('Student name is required');
  if (data.dob && !validateDate(data.dob)) errors.push('Invalid date of birth');
  if (data.dob) {
    const dob = new Date(data.dob);
    const today = new Date();
    const age = today.getFullYear() - dob.getFullYear();
    if (age < 3 || age > 25) errors.push('Student age seems unrealistic');
  }
  return errors;
}

/* Settings & year helpers */
function getSettings(){ return Object.assign({name:'Peaceful Academy of Kansas City, Missouri',phone:'',address:'',yearStart:'07-01'}, JSON.parse(localStorage.getItem('pa_settings')||'{}'));}
function setSettings(v){ localStorage.setItem('pa_settings', JSON.stringify(v)); renderSettings(); }
function yearForDate(d){ const [Y,M,D]=d.split('-').map(Number); const s=getSettings().yearStart; const anchor=new Date(Y, Number(s.slice(0,2))-1, Number(s.slice(3,5))); const dt=new Date(d+'T12:00:00'); return dt>=anchor?Y:Y-1; }
function yearLabel(y){ return y+'–'+(y+1); }
function currentAcademicStart(){ return yearForDate(todayISO()); }

/* IndexedDB */
let db; 
(function openDB(){ 
  const req=indexedDB.open('peacefulAcademyDB',2); 
  req.onupgradeneeded=e=>{
    const d=e.target.result; 
    // Create stores with better error handling
    if (!d.objectStoreNames.contains('students')) {
      d.createObjectStore('students',{keyPath:'id',autoIncrement:true}); 
    }
    if (!d.objectStoreNames.contains('courses')) {
      d.createObjectStore('courses',{keyPath:'id',autoIncrement:true}); 
    }
    if (!d.objectStoreNames.contains('logs')) {
      d.createObjectStore('logs',{keyPath:'id',autoIncrement:true}); 
    }
    if (!d.objectStoreNames.contains('portfolio')) {
      d.createObjectStore('portfolio',{keyPath:'id',autoIncrement:true}); 
    }
    if (!d.objectStoreNames.contains('files')) {
      d.createObjectStore('files',{keyPath:'id',autoIncrement:true}); 
    }
  }; 
  req.onsuccess=()=>{db=req.result; init();}; 
  req.onerror=(e)=>{
    console.error('IndexedDB error:', e);
    // Fallback: continue without IndexedDB (will use localStorage-based DB)
    db=null;
    init();
  }; 
})();
function tx(names,mode='readonly'){ return db.transaction(names,mode); }
// LocalStorage fallback helpers
function lsKey(s){ return 'pa_store_'+s; }
function lsCounterKey(s){ return 'pa_store_'+s+'_id'; }
function lsRead(s){ try{ return JSON.parse(localStorage.getItem(lsKey(s))||'[]'); }catch(_){ return []; } }
function lsWrite(s, arr){ localStorage.setItem(lsKey(s), JSON.stringify(arr)); }
function lsNextId(s){ const k=lsCounterKey(s); const v=Number(localStorage.getItem(k)||'0')+1; localStorage.setItem(k, String(v)); return v; }
const DB={ 
  add:(s,o)=>new Promise((res,rej)=>{
    try {
      if (db) {
        const r=tx([s],'readwrite').objectStore(s).add(o); 
        r.onsuccess=()=>res(r.result); 
        r.onerror=(e)=>{console.error('DB add error:', e); rej(r.error);} 
      } else {
        const arr=lsRead(s);
        const obj=Object.assign({}, o);
        if (obj.id==null) obj.id=lsNextId(s);
        arr.push(obj);
        lsWrite(s, arr);
        res(obj.id);
      }
    } catch(e) {
      console.error('DB add exception:', e);
      rej(e);
    }
  }), 
  put:(s,o)=>new Promise((res,rej)=>{
    try {
      if (db) {
        const r=tx([s],'readwrite').objectStore(s).put(o); 
        r.onsuccess=()=>res(r.result); 
        r.onerror=(e)=>{console.error('DB put error:', e); rej(r.error);} 
      } else {
        const arr=lsRead(s);
        const idx=arr.findIndex(it=>String(it.id)===String(o.id));
        if (idx>=0) arr[idx]=Object.assign({}, o); else arr.push(Object.assign({}, o));
        lsWrite(s, arr);
        res(o.id);
      }
    } catch(e) {
      console.error('DB put exception:', e);
      rej(e);
    }
  }), 
  get:(s,k)=>new Promise((res,rej)=>{
    try {
      if (db) {
        const r=tx([s]).objectStore(s).get(k); 
        r.onsuccess=()=>res(r.result); 
        r.onerror=(e)=>{console.error('DB get error:', e); rej(r.error);} 
      } else {
        const arr=lsRead(s);
        const v=arr.find(it=>String(it.id)===String(k));
        // Provide safe placeholder for files without blobs
        if (s==='files' && v && !v.blob) {
          v.blob=new Blob([], { type: v.type||'application/octet-stream' });
        }
        res(v||null);
      }
    } catch(e) {
      console.error('DB get exception:', e);
      rej(e);
    }
  }), 
  all:(s)=>new Promise((res,rej)=>{
    try {
      if (db) {
        const r=tx([s]).objectStore(s).getAll(); 
        r.onsuccess=()=>res(r.result || []); 
        r.onerror=(e)=>{console.error('DB all error:', e); rej(r.error);} 
      } else {
        res(lsRead(s));
      }
    } catch(e) {
      console.error('DB all exception:', e);
      rej(e);
    }
  }), 
  del:(s,k)=>new Promise((res,rej)=>{
    try {
      if (db) {
        const r=tx([s],'readwrite').objectStore(s).delete(k); 
        r.onsuccess=()=>res(); 
        r.onerror=(e)=>{console.error('DB delete error:', e); rej(r.error);} 
      } else {
        const arr=lsRead(s).filter(it=>String(it.id)!==String(k));
        lsWrite(s, arr);
        res();
      }
    } catch(e) {
      console.error('DB delete exception:', e);
      rej(e);
    }
  }) 
};

// Clean up object URLs to prevent memory leaks
function cleanupObjectUrls() {
  for (const [key, url] of objectUrlCache.entries()) {
    URL.revokeObjectURL(url);
  }
  objectUrlCache.clear();
}

// Get or create object URL with caching
function getObjectUrl(fileId, blob) {
  if (objectUrlCache.has(fileId)) {
    return objectUrlCache.get(fileId);
  }
  const url = URL.createObjectURL(blob);
  objectUrlCache.set(fileId, url);
  return url;
}

/* Netlify forms */
function encode(data){ return Object.keys(data).map(k=> encodeURIComponent(k)+'='+encodeURIComponent(data[k])).join('&'); }
async function netlifySubmit(formName, data){ 
  try{ 
    await fetch('/', { 
      method:'POST', 
      headers:{'Content-Type':'application/x-www-form-urlencoded'}, 
      body: encode(Object.assign({'form-name': formName, 'bot-field':''}, data)) 
    }); 
  } catch(e){ 
    console.warn('Netlify submit failed', e);
  } 
}
async function netlifySubmitFormData(formName, fd){ 
  try{ 
    fd.append('form-name', formName); 
    fd.append('bot-field',''); 
    await fetch('/', { 
      method:'POST', 
      body:fd 
    }); 
  } catch(e){ 
    console.warn('Netlify file submit failed', e);
  } 
}

// Enhanced notification system
function showNotification(message, type = 'info') {
  try{ appendLog(type==='error'?'error':type==='warning'?'warn':'info', [message]); }catch(_){}
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 1000;
    animation: slideIn 0.3s ease-out;
    ${type === 'success' ? 'background: var(--ok);' : ''}
    ${type === 'error' ? 'background: var(--danger);' : ''}
    ${type === 'warning' ? 'background: #f59e0b;' : ''}
    ${type === 'info' ? 'background: var(--accent2);' : ''}
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Add notification animations
const notificationStyle = document.createElement('style');
notificationStyle.textContent = `
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(notificationStyle);

/* Neon helper */
async function saveToNeon(kind, data){ try{ await fetch('/.netlify/functions/db', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ action: kind + '.insert', data }) }); } catch(e){ console.warn('Neon save failed', e); }}

/* Lists & renders */
async function listStudents(){ return await DB.all('students'); }
async function listCourses(){ return await DB.all('courses'); }
async function listLogs(){ return await DB.all('logs'); }
async function listPortfolio(){ return await DB.all('portfolio'); }

function show(view){ $$('.view').forEach(v=>v.classList.add('hide')); $('#view-'+view).classList.remove('hide'); $$('#nav a').forEach(a=>a.classList.remove('active')); $(`#nav a[href="#${view}"]`)?.classList.add('active'); }
window.addEventListener('hashchange', ()=>{ const v=(location.hash||'#dashboard').slice(1); show(v); if(v==='dashboard') renderDashboard(); if(v==='students') renderStudents(); if(v==='courses') renderCourses(); if(v==='log') renderLogsTable(); if(v==='portfolio') renderPortfolio(); if(v==='reports') renderReports(); if(v==='settings') renderSettings(); });

async function renderStudents(){
  const students = await listStudents();
  const tb = $('#stTable tbody'); if(tb){ tb.innerHTML=''; students.forEach(s=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${s.name}</td><td>${s.dob||''}</td><td>${s.grade||''}</td><td>${s.startYear||''}</td><td class="right"><button class="stDel" data-id="${s.id}">Delete</button></td>`; tb.appendChild(tr); });}
  const opts = students.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  ['dashStudent','qaStudent','lgStudent','lgStudentFilter','pfStudent','pfStudentFilter','rpStudent','trStudent','dpStudent'].forEach(id=>{ const el=$('#'+id); if(!el) return; const prev=el.value; el.innerHTML=(id.endsWith('Filter')?'<option value="">All</option>':'')+opts; if(prev) el.value=prev; });
}
async function renderCourses(){
  const courses=await listCourses(); const tb=$('#coTable tbody'); if(tb){ tb.innerHTML=''; courses.forEach(c=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.title}</td><td>${c.subject}</td><td class="muted">${c.description||''}</td><td class="right"><button class="coDel" data-id="${c.id}">Delete</button></td>`; tb.appendChild(tr);});}
  const opts=courses.map(c=>`<option value="${c.id}">${c.title}</option>`).join(''); ['qaCourse','lgCourse','pfCourse'].forEach(id=>{ const el=$('#'+id); if(el){ const prev=el.value; el.innerHTML=opts; if(prev) el.value=prev; }});
}
function academicYears(logs){ const ys=new Set(logs.map(l=>yearForDate(l.date))); if(!ys.size) ys.add(currentAcademicStart()); return Array.from(ys).sort((a,b)=>b-a); }
async function renderYearSelectors(){
  const logs=await listLogs(); const years=academicYears(logs);
  const set=(id,all=false)=>{ const el=$('#'+id); if(!el) return; const prev=el.value; el.innerHTML=(all?'<option value="">All</option>':'')+years.map(y=>`<option value="${y}">${yearLabel(y)}</option>`).join(''); el.value=prev||years[0]; };
  set('dashYear'); set('lgYearFilter', true); set('pfYearFilter', true); set('rpYear'); const stStart=$('#stStart'); if(stStart){ stStart.innerHTML=years.slice().reverse().map(y=>`<option value="${y}">${yearLabel(y)}</option>`).join(''); } const trYears=$('#trYears'); if(trYears){ trYears.innerHTML=years.map(y=>`<option value="${y}" selected>${yearLabel(y)}</option>`).join(''); }
}
async function renderDashboard(){
  const [logs,courses,students]=await Promise.all([listLogs(), listCourses(), listStudents()]); await renderYearSelectors(); await renderStudents(); await renderCourses();
  const sId=Number($('#dashStudent').value || (students[0]?.id||0)); $('#dashStudent').value=sId||''; const yStart=Number($('#dashYear').value)||currentAcademicStart();
  const filtered=logs.filter(l=> Number(l.studentId)===sId && yearForDate(l.date)===yStart); const cMap=new Map(courses.map(c=>[c.id,c]));
  let total=0, core=0, home=0, nonCore=0; filtered.forEach(l=>{ const subj=cMap.get(Number(l.courseId))?.subject; const hrs=Number(l.hours)||0; total+=hrs; if(CORE.has(subj)){ core+=hrs; if(l.location==='home') home+=hrs; } else { nonCore+=hrs; }});
  
  // Calculate average daily hours and days attended
  const uniqueDays = new Set(filtered.map(l => l.date));
  const daysAttended = uniqueDays.size;
  const avgDailyHours = daysAttended > 0 ? total / daysAttended : 0;
  
  $('#kpiTotal').textContent=fmt.format(total); $('#kpiCore').textContent=fmt.format(core); $('#kpiHome').textContent=fmt.format(home); $('#kpiNonCore').textContent=fmt.format(nonCore);
  $('#kpiAvgDaily').textContent=fmt.format(avgDailyHours); $('#kpiDaysAttended').textContent=daysAttended;
  
  $('#barTotal').style.width=Math.min(100,(total/1000)*100)+'%'; $('#barCore').style.width=Math.min(100,(core/600)*100)+'%'; $('#barHome').style.width=Math.min(100,(home/400)*100)+'%'; $('#barNonCore').style.width=Math.min(100,(nonCore/400)*100)+'%';
  $('#barAvgDaily').style.width=Math.min(100,(avgDailyHours/8)*100)+'%'; $('#barDaysAttended').style.width=Math.min(100,(daysAttended/180)*100)+'%';
  
  const recent = filtered.slice().sort((a,b)=>b.date.localeCompare(a.date)).slice(0,10); const tb=$('#recentTable tbody'); tb.innerHTML=''; recent.forEach(r=>{ const c=cMap.get(Number(r.courseId)); const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.date}</td><td>${c?.title||''}</td><td class="right">${fmt.format(r.hours)}</td><td>${r.location==='home'?'Home':'Offsite'}</td><td class="muted">${r.notes||''}</td>`; tb.appendChild(tr); });
  $('#qaStudent').value=sId||''; $('#qaCourse').value=courses[0]?.id||''; $('#qaDate').value=todayISO();
}
async function renderLogsTable(){
  const [logs,courses,students]=await Promise.all([listLogs(), listCourses(), listStudents()]);
  const subjF=$('#lgSubjectFilter').value; const y=$('#lgYearFilter').value; const s=$('#lgStudentFilter').value; const cMap=new Map(courses.map(c=>[c.id,c])); const sMap=new Map(students.map(x=>[x.id,x]));
  const filtered=logs.filter(l=> (!y||yearForDate(l.date)==Number(y)) && (!s||l.studentId==Number(s)) && (!subjF||cMap.get(l.courseId)?.subject===subjF)).sort((a,b)=>b.date.localeCompare(a.date));
  const tb=$('#lgTable tbody'); tb.innerHTML=''; filtered.forEach(l=>{ const c=cMap.get(Number(l.courseId)), st=sMap.get(Number(l.studentId)); const tr=document.createElement('tr'); tr.innerHTML=`<td>${l.date}</td><td>${st?.name||''}</td><td>${c?.title||''}</td><td>${c?.subject||''}</td><td class="right">${fmt.format(l.hours)}</td><td>${l.location==='home'?'Home':'Offsite'}</td><td class="muted">${l.notes||''}</td><td class="right"><button class="lgDel" data-id="${l.id}">Delete</button></td>`; tb.appendChild(tr); });
}
async function renderPortfolio(){
  // Clean up previous object URLs to prevent memory leaks
  cleanupObjectUrls();
  
  const [items,courses,students]=await Promise.all([listPortfolio(), listCourses(), listStudents()]); const y=$('#pfYearFilter').value, s=$('#pfStudentFilter').value, subj=$('#pfSubjectFilter').value; const cMap=new Map(courses.map(c=>[c.id,c])); const sMap=new Map(students.map(x=>[x.id,x]));
  const filtered=items.filter(p=> (!y||yearForDate(p.date)==Number(y)) && (!s||p.studentId==Number(s)) && (!subj||cMap.get(Number(p.courseId))?.subject===subj)).sort((a,b)=>b.date.localeCompare(a.date));
  const gal=$('#pfGallery'); gal.innerHTML=''; for(const p of filtered){ const c=cMap.get(Number(p.courseId)), st=sMap.get(Number(p.studentId)); const file=p.fileId?await DB.get('files', p.fileId):null; const url=file?getObjectUrl(p.fileId, file.blob):''; const isImg = file && file.type.startsWith('image/'); const div=document.createElement('div'); div.className='tile'; div.innerHTML=`<div style="height:140px;display:flex;align-items:center;justify-content:center;background:#0a1123">${file?(isImg?`<img src="${url}" style="width:100%;height:140px;object-fit:cover">`:`<div class="muted">File: ${file.name||file.type}</div>`):'<div class="muted">No file</div>'}</div><div style="padding:.6rem"><div><strong>${p.title||'(untitled)'}</strong></div><div class="muted">${p.date} • ${st?.name||''} • ${c?.title||''}</div><div style="font-size:.92rem">${p.desc||''}</div><div class="row" style="margin-top:.5rem;justify-content:space-between"><div class="muted">${(p.tags||[]).join(', ')}</div><div class="row">${file?`<a download="${(p.title||'portfolio')}" href="${url}">Download</a>`:''}<button class="pfDel" data-id="${p.id}">Delete</button></div></div></div>`; gal.appendChild(div);} }
async function renderReports(){
  const [logs,courses]=await Promise.all([listLogs(), listCourses()]); const sId=Number($('#rpStudent').value); const yStart=Number($('#rpYear').value); const groupBy=$('#rpGroupBy').value; const cMap=new Map(courses.map(c=>[c.id,c])); const filtered=logs.filter(l=> Number(l.studentId)===sId && yearForDate(l.date)===yStart);
  const totals={total:0,core:0,home:0,nonCore:0}, groups=new Map(); function addG(k,hrs,home,nonCore){ const o=groups.get(k)||{hours:0,home:0,nonCore:0}; o.hours+=hrs; if(home) o.home+=hrs; if(nonCore) o.nonCore+=hrs; groups.set(k,o); }
  filtered.forEach(l=>{ const hrs=Number(l.hours)||0; const subj=cMap.get(Number(l.courseId))?.subject; totals.total+=hrs; const isCore=CORE.has(subj); const home = isCore && l.location==='home'; const nonCore = !isCore; if(isCore) totals.core+=hrs; if(home) totals.home+=hrs; if(nonCore) totals.nonCore+=hrs; let key=''; if(groupBy==='subject') key=subj||'(none)'; else if(groupBy==='course') key=cMap.get(Number(l.courseId))?.title||'(none)'; else key=l.date.slice(0,7); addG(key,hrs,home,nonCore); });
  const mk=(label,val,goal)=>`<div class="card"><div class="muted">${label} (goal ${goal})</div><div class="num">${fmt.format(val)}</div><div class="bar"><span style="width:${Math.min(100,(val/goal)*100)}%"></span></div></div>`;
  $('#rpSummary').innerHTML = mk('Total Hours',totals.total,1000)+mk('Core Hours',totals.core,600)+mk('Core @ Home',totals.home,400)+mk('Non-Core Hours',totals.nonCore,400);
  const tb=$('#rpTable tbody'); tb.innerHTML=''; Array.from(groups.entries()).sort((a,b)=>b[1].hours-a[1].hours).forEach(([k,v])=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${k}</td><td class="right">${fmt.format(v.hours)}</td><td class="right">${fmt.format(v.home)}</td><td class="right">${fmt.format(v.nonCore)}</td>`; tb.appendChild(tr); });
}

/* Events */
function renderSettings(){ const s=getSettings(); $('#scName').value=s.name; $('#scPhone').value=s.phone; $('#scAddress').value=s.address; $('#scYearStart').value=s.yearStart; $('#yearNow').textContent=new Date().getFullYear(); }
$('#scSave')?.addEventListener('click', ()=>{
  const settings = {
    name: $('#scName').value.trim(),
    phone: $('#scPhone').value.trim(),
    address: $('#scAddress').value.trim(),
    yearStart: $('#scYearStart').value
  };
  
  if (!settings.name) {
    showNotification('School name is required', 'error');
    return;
  }
  
  setSettings(settings);
  showNotification('Settings saved successfully!', 'success');
  renderDashboard(); 
  renderLogsTable(); 
  renderPortfolio(); 
  renderReports(); 
});
$('#scReset')?.addEventListener('click', ()=>{ if(confirm('Reset to defaults?')) setSettings({name:'Peaceful Academy of Kansas City, Missouri',phone:'',address:'',yearStart:'07-01'}); });
// Build a rich snapshot including denormalized names/subjects for logs
async function buildSnapshotPayload(){
  const [students,courses,logs,portfolio,files] = await Promise.all([
    listStudents(), listCourses(), listLogs(), listPortfolio(), DB.all('files')
  ]);
  const cMap = new Map(courses.map(c=>[Number(c.id), c]));
  const sMap = new Map(students.map(s=>[Number(s.id), s]));
  const logsRich = logs.map(l=>({
    ...l,
    studentName: sMap.get(Number(l.studentId))?.name || null,
    courseTitle: cMap.get(Number(l.courseId))?.title || null,
    subject: cMap.get(Number(l.courseId))?.subject || null
  }));
  return { settings: getSettings(), students, courses, logs: logsRich, portfolio, files };
}

$('#scExportAll')?.addEventListener('click', async()=>{ const payload = await buildSnapshotPayload(); const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:'peaceful-academy-backup.json'}); a.click(); });
$('#scImportAll')?.addEventListener('change', async(e)=>{ const f=e.target.files?.[0]; if(!f) return; if(!confirm('Import will REPLACE existing data. Continue?')) return; const data=JSON.parse(await f.text()); await Promise.all(['students','courses','logs','portfolio','files'].map(s=>new Promise((res,rej)=>{ const r=tx([s],'readwrite').objectStore(s).clear(); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error);}))); if(data.settings) setSettings(data.settings); for(const s of (data.students||[])) await DB.add('students', s); for(const c of (data.courses||[])) await DB.add('courses', c); for(const l of (data.logs||[])) await DB.add('logs', l); for(const p of (data.portfolio||[])) await DB.add('portfolio', p); alert('Imported.'); renderDashboard(); renderStudents(); renderCourses(); renderLogsTable(); renderPortfolio(); renderReports(); });
$('#scWipe')?.addEventListener('click', async()=>{ if(!confirm('Erase ALL data?')) return; await Promise.all(['students','courses','logs','portfolio','files'].map(s=>new Promise((res,rej)=>{ const r=tx([s],'readwrite').objectStore(s).clear(); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error);}))); alert('Cleared.'); renderDashboard(); renderStudents(); renderCourses(); renderLogsTable(); renderPortfolio(); renderReports(); });

// Export all local data to Neon (bulk upsert)
$('#scExportNeon')?.addEventListener('click', async()=>{
  try {
    const payload = await buildSnapshotPayload();
    appendLog('info', ['Export to Neon started']);
    const res = await fetch('/.netlify/functions/db', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ action: 'bulk.upsertAll', data: payload })
    });
    const raw = await res.text();
    let json = null; try{ json = JSON.parse(raw); } catch(_){}
    if(!res.ok || (json && json.error)){
      const msg = (json && json.error) ? json.error : `HTTP ${res.status}`;
      appendLog('error', ['Export to Neon failed', msg, 'raw:', raw.slice(0,500)]);
      throw new Error(msg);
    }
    appendLog('info', ['Export to Neon completed', JSON.stringify(json.counts||{})]);
    showNotification('Exported to Neon successfully!', 'success');
  } catch(e){
    console.error('Export to Neon failed', e);
    appendLog('error', ['Export to Neon exception', String(e&&e.message||e)]);
    showNotification('Export to Neon failed. See console.', 'error');
  }
});

// Import all data from Neon (replace local)
$('#scImportNeon')?.addEventListener('click', async()=>{
  if(!confirm('Import from Neon will REPLACE local data. Continue?')) return;
  try {
    appendLog('info', ['Import from Neon started']);
    const res = await fetch('/.netlify/functions/db', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ action: 'bulk.readAll' })
    });
    const raw = await res.text();
    let json = null; try{ json = JSON.parse(raw); } catch(_){}
    if(!res.ok || (json && json.error)){
      const msg = (json && json.error) ? json.error : `HTTP ${res.status}`;
      appendLog('error', ['Import from Neon failed', msg, 'raw:', raw.slice(0,500)]);
      throw new Error(msg);
    }
    const data = json.data || {};
    await Promise.all(['students','courses','logs','portfolio','files'].map(s=>new Promise((res2,rej)=>{ const r=tx([s],'readwrite').objectStore(s).clear(); r.onsuccess=()=>res2(); r.onerror=()=>rej(r.error);}))); 
    if(data.settings) setSettings(data.settings);
    for(const s of (data.students||[])) await DB.add('students', s);
    for(const c of (data.courses||[])) await DB.add('courses', c);
    for(const l of (data.logs||[])) await DB.add('logs', l);
    for(const p of (data.portfolio||[])) await DB.add('portfolio', p);
    for(const f of (data.files||[])) await DB.add('files', f);
    appendLog('info', ['Import from Neon completed', `students=${(data.students||[]).length}`, `courses=${(data.courses||[]).length}`, `logs=${(data.logs||[]).length}`, `portfolio=${(data.portfolio||[]).length}`]);
    showNotification('Imported from Neon successfully!', 'success');
    renderDashboard(); renderStudents(); renderCourses(); renderLogsTable(); renderPortfolio(); renderReports();
  } catch(e){
    console.error('Import from Neon failed', e);
    appendLog('error', ['Import from Neon exception', String(e&&e.message||e)]);
    showNotification('Import from Neon failed. See console.', 'error');
  }
});

// Backup to Neon (store JSON in backups table)
$('#scBackupNeon')?.addEventListener('click', async()=>{
  try {
    appendLog('info', ['Backup to Neon started']);
    const payload = await buildSnapshotPayload();
    const res = await fetch('/.netlify/functions/db', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ action: 'backup.save', data: { payload, note: 'manual backup' } })
    });
    const raw = await res.text(); let json=null; try{ json=JSON.parse(raw);}catch(_){ }
    if(!res.ok || (json && json.error)){
      const msg=(json&&json.error)||`HTTP ${res.status}`; appendLog('error',['Backup to Neon failed', msg, 'raw:', raw.slice(0,500)]); throw new Error(msg);
    }
    appendLog('info', ['Backup to Neon completed', JSON.stringify(json)]);
    showNotification('Backup saved in Neon', 'success');
  } catch(e){ console.error('Backup to Neon failed', e); appendLog('error', ['Backup to Neon exception', String(e&&e.message||e)]); showNotification('Backup to Neon failed', 'error'); }
});

// Restore from latest Neon backup
$('#scRestoreNeon')?.addEventListener('click', async()=>{
  if(!confirm('Restore will REPLACE local data with the latest Neon backup. Continue?')) return;
  try {
    appendLog('info', ['Restore from Neon started']);
    const res = await fetch('/.netlify/functions/db', {
      method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ action: 'backup.latest' })
    });
    const raw=await res.text(); let json=null; try{ json=JSON.parse(raw);}catch(_){ }
    if(!res.ok || (json && json.error)){
      const msg=(json&&json.error)||`HTTP ${res.status}`; appendLog('error',['Restore from Neon failed', msg, 'raw:', raw.slice(0,500)]); throw new Error(msg);
    }
    const backup = json.backup; if(!backup || !backup.payload){ showNotification('No backup found in Neon', 'warning'); return; }
    const data = backup.payload;
    await Promise.all(['students','courses','logs','portfolio','files'].map(s=>new Promise((res2,rej)=>{ const r=tx([s],'readwrite').objectStore(s).clear(); r.onsuccess=()=>res2(); r.onerror=()=>rej(r.error);}))); 
    if(data.settings) setSettings(data.settings);
    for(const s of (data.students||[])) await DB.add('students', s);
    for(const c of (data.courses||[])) await DB.add('courses', c);
    for(const l of (data.logs||[])) await DB.add('logs', l);
    for(const p of (data.portfolio||[])) await DB.add('portfolio', p);
    for(const f of (data.files||[])) await DB.add('files', f);
    appendLog('info', ['Restore from Neon completed']);
    showNotification('Restored from Neon backup', 'success');
    renderDashboard(); renderStudents(); renderCourses(); renderLogsTable(); renderPortfolio(); renderReports();
  } catch(e){ console.error('Restore from Neon failed', e); appendLog('error',['Restore from Neon exception', String(e&&e.message||e)]); showNotification('Restore from Neon failed','error'); }
});

// Backfill Neon logs with student_name / course_title / subject
$('#scBackfillLogs')?.addEventListener('click', async()=>{
  try {
    appendLog('info', ['Logs backfill started']);
    const res = await fetch('/.netlify/functions/db', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ action: 'logs.backfill' }) });
    const raw=await res.text(); let json=null; try{ json=JSON.parse(raw);}catch(_){ }
    if(!res.ok || (json && json.error)){
      const msg=(json&&json.error)||`HTTP ${res.status}`; appendLog('error',['Logs backfill failed', msg, 'raw:', raw.slice(0,500)]); showNotification('Backfill failed', 'error'); return;
    }
    showNotification(`Backfilled: student_name ${json.updated.student_name}, course_title ${json.updated.course_title}, subject ${json.updated.subject}`, 'success');
    appendLog('info', ['Logs backfill completed', JSON.stringify(json.updated||{})]);
  } catch(e){ console.error('Logs backfill exception', e); appendLog('error',['Logs backfill exception', String(e&&e.message||e)]); showNotification('Backfill failed', 'error'); }
});

/* Students */
document.body.addEventListener('click', async(e)=>{ if(e.target.classList.contains('stDel')){ await DB.del('students', Number(e.target.dataset.id)); renderStudents(); renderDashboard(); renderLogsTable(); renderPortfolio(); renderReports(); } });
$('#stSave')?.addEventListener('click', async()=>{ 
  const obj={ 
    name:$('#stName').value.trim(), 
    dob:$('#stDob').value||'', 
    grade:$('#stGrade').value.trim(), 
    startYear:Number($('#stStart').value)||currentAcademicStart(), 
    notes:$('#stNotes').value.trim() 
  }; 
  
  // Enhanced validation
  const errors = validateStudentData(obj);
  if(errors.length > 0) {
    alert('Please fix the following errors:\n' + errors.join('\n'));
    return;
  }
  
  try {
    await DB.add('students', obj);
    await netlifySubmit('student', {name:obj.name, dob:obj.dob, grade:obj.grade, startYear:String(obj.startYear), notes:obj.notes});
    await saveToNeon('student', {name:obj.name, dob:obj.dob, grade:obj.grade, startYear:obj.startYear, notes:obj.notes});
    $('#stName').value=''; $('#stDob').value=''; $('#stGrade').value=''; $('#stNotes').value=''; 
    renderStudents(); renderYearSelectors(); renderDashboard(); 
  } catch(e) {
    console.error('Error saving student:', e);
    showNotification('Error saving student. Please try again.', 'error');
  }
});
$('#stClear')?.addEventListener('click', ()=>{$$('#view-students input, #view-students textarea').forEach(el=>el.value='')});

/* Courses */
document.body.addEventListener('click', async(e)=>{ if(e.target.classList.contains('coDel')){ await DB.del('courses', Number(e.target.dataset.id)); renderCourses(); renderLogsTable(); renderDashboard(); renderPortfolio(); renderReports(); } });
$('#coSave')?.addEventListener('click', async()=>{ 
  const obj={ 
    title:$('#coTitle').value.trim(), 
    subject:$('#coSubject').value, 
    description:$('#coDesc').value.trim() 
  }; 
  
  // Enhanced validation
  const errors = [];
  if(!validateRequired(obj.title)) errors.push('Course title is required');
  if(!validateRequired(obj.subject)) errors.push('Subject is required');
  if(obj.title.length > 100) errors.push('Course title is too long (max 100 characters)');
  
  if(errors.length > 0) {
    alert('Please fix the following errors:\n' + errors.join('\n'));
    return;
  }
  
  try {
    await DB.add('courses', obj);
    await netlifySubmit('course', obj);
    await saveToNeon('course', obj);
    $('#coTitle').value=''; $('#coDesc').value=''; 
    renderCourses(); renderDashboard(); 
  } catch(e) {
    console.error('Error saving course:', e);
    showNotification('Error saving course. Please try again.', 'error');
  }
});
$('#coClear')?.addEventListener('click', ()=>{$$('#view-courses input, #view-courses textarea').forEach(el=>el.value='')});

/* Logs */
$('#qaToday')?.addEventListener('click', ()=> $('#qaDate').value=todayISO());
$('#lgToday2')?.addEventListener('click', ()=> $('#lgDate').value=todayISO());
$('#qaAdd')?.addEventListener('click', async()=>{
  const obj={ 
    studentId:Number($('#qaStudent').value), 
    courseId:Number($('#qaCourse').value), 
    date:$('#qaDate').value||todayISO(), 
    hours:Number($('#qaHours').value), 
    location:$('#qaLocation').value, 
    notes:$('#qaNotes').value.trim() 
  };
  
  // Enhanced validation
  const errors = [];
  if(!obj.studentId){ errors.push('Please select a student'); }
  if(!obj.courseId){ errors.push('Please select a course'); }
  if(!validateHours(obj.hours)){ errors.push('Please enter valid hours (0.25 to 24)'); }
  if(!validateDate(obj.date)){ errors.push('Please enter a valid date'); }
  if(obj.notes.length > 500) { errors.push('Notes are too long (max 500 characters)'); }
  
  if(errors.length > 0) {
    alert('Please fix the following errors:\n' + errors.join('\n'));
    return;
  }
  
  try {
    await DB.add('logs', obj);
    const [courses,students]=await Promise.all([listCourses(), listStudents()]); 
    const c=courses.find(x=>x.id===obj.courseId), s=students.find(x=>x.id===obj.studentId);
    await netlifySubmit('log-entry', { student:s?.name||String(obj.studentId), course:c?.title||String(obj.courseId), subject:c?.subject||'', date:obj.date, hours:String(obj.hours), location:obj.location, notes:obj.notes });
    await saveToNeon('log', { studentId: obj.studentId, studentName: s?.name||String(obj.studentId), courseId: obj.courseId, courseTitle: c?.title||String(obj.courseId), subject: c?.subject||'', date: obj.date, hours: obj.hours, location: obj.location, notes: obj.notes });
    $('#qaHours').value=''; $('#qaNotes').value=''; 
    renderDashboard(); renderLogsTable(); renderReports();
    showNotification('Log entry added successfully!', 'success');
  } catch(e) {
    console.error('Error adding log entry:', e);
    showNotification('Error adding log entry. Please try again.', 'error');
  }
});
$('#lgAdd')?.addEventListener('click', async()=>{
  const obj={ 
    studentId:Number($('#lgStudent').value), 
    courseId:Number($('#lgCourse').value), 
    date:$('#lgDate').value||todayISO(), 
    hours:Number($('#lgHours').value), 
    location:$('#lgLocation').value, 
    notes:$('#lgNotes').value.trim() 
  };
  
  // Enhanced validation
  const errors = [];
  if(!obj.studentId){ errors.push('Please select a student'); }
  if(!obj.courseId){ errors.push('Please select a course'); }
  if(!validateHours(obj.hours)){ errors.push('Please enter valid hours (0.25 to 24)'); }
  if(!validateDate(obj.date)){ errors.push('Please enter a valid date'); }
  if(obj.notes.length > 500) { errors.push('Notes are too long (max 500 characters)'); }
  
  if(errors.length > 0) {
    alert('Please fix the following errors:\n' + errors.join('\n'));
    return;
  }
  
  try {
    await DB.add('logs', obj);
    const [courses,students]=await Promise.all([listCourses(), listStudents()]); 
    const c=courses.find(x=>x.id===obj.courseId), s=students.find(x=>x.id===obj.studentId);
    await netlifySubmit('log-entry', { student:s?.name||String(obj.studentId), course:c?.title||String(obj.courseId), subject:c?.subject||'', date:obj.date, hours:String(obj.hours), location:obj.location, notes:obj.notes });
    await saveToNeon('log', { studentId: obj.studentId, studentName: s?.name||String(obj.studentId), courseId: obj.courseId, courseTitle: c?.title||String(obj.courseId), subject: c?.subject||'', date: obj.date, hours: obj.hours, location: obj.location, notes: obj.notes });
    $('#lgHours').value=''; $('#lgNotes').value=''; 
    renderLogsTable(); renderDashboard(); renderReports();
    showNotification('Log entry added successfully!', 'success');
  } catch(e) {
    console.error('Error adding log entry:', e);
    showNotification('Error adding log entry. Please try again.', 'error');
  }
});
document.body.addEventListener('click', async(e)=>{ if(e.target.classList.contains('lgDel')){ await DB.del('logs', Number(e.target.dataset.id)); renderLogsTable(); renderDashboard(); renderReports(); } });
$('#exportCSV')?.addEventListener('click', async()=>{ const [logs,courses,students]=await Promise.all([listLogs(), listCourses(), listStudents()]); const cMap=new Map(courses.map(c=>[c.id,c])); const sMap=new Map(students.map(s=>[s.id,s])); const y=$('#lgYearFilter').value; const rows=[['date','student','course','subject','hours','location','notes']]; for(const l of logs){ if(y && yearForDate(l.date)!=Number(y)) continue; const c=cMap.get(l.courseId), st=sMap.get(l.studentId); rows.push([l.date, st?.name||'', c?.title||'', c?.subject||'', String(l.hours), l.location, (l.notes||'').replace(/\n/g,' ')]);} const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n'); const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([csv],{type:'text/csv'})),download:'logs.csv'}); a.click(); });
$('#exportJSON')?.addEventListener('click', async()=>{ const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([JSON.stringify({logs:await listLogs()},null,2)],{type:'application/json'})),download:'logs.json'}); a.click(); });
$('#importJSON')?.addEventListener('change', async(e)=>{ const f=e.target.files?.[0]; if(!f) return; const data=JSON.parse(await f.text()); if(!Array.isArray(data.logs)){ alert('Invalid'); return; } for(const l of data.logs) await DB.add('logs', l); alert('Imported'); renderLogsTable(); renderDashboard(); renderReports(); });

/* Portfolio */
async function fileToBlob(file){ return file.slice(0,file.size,file.type); }
$('#pfSave')?.addEventListener('click', async()=>{
  const file=$('#pfFile').files[0]||null; let fileId=null;
  if(file){ const blob=await fileToBlob(file); fileId=await DB.add('files', {blob, type:file.type, name:file.name, size:file.size}); }
  const obj={ 
    studentId:Number($('#pfStudent').value), 
    courseId:Number($('#pfCourse').value), 
    date:$('#pfDate').value||todayISO(), 
    title:$('#pfTitle').value.trim(), 
    desc:$('#pfDesc').value.trim(), 
    tags:$('#pfTags').value.split(',').map(t=>t.trim()).filter(Boolean), 
    fileId 
  };
  
  // Enhanced validation
  if(!obj.studentId){ alert('Please select a student'); return; }
  if(!obj.courseId){ alert('Please select a course'); return; }
  if(!validateDate(obj.date)){ alert('Please enter a valid date'); return; }
  
  await DB.add('portfolio', obj);
  const [courses,students]=await Promise.all([listCourses(), listStudents()]); const c=courses.find(x=>x.id===obj.courseId), s=students.find(x=>x.id===obj.studentId);
  const fd=new FormData(); fd.append('student', s?.name||String(obj.studentId)); fd.append('course', c?.title||String(obj.courseId)); fd.append('date', obj.date); fd.append('title', obj.title); fd.append('tags', (obj.tags||[]).join(', ')); fd.append('description', obj.desc); if(file) fd.append('file', file, file.name); await netlifySubmitFormData('portfolio-upload', fd);
  await saveToNeon('portfolio', { studentId: obj.studentId, studentName: s?.name||String(obj.studentId), courseId: obj.courseId, courseTitle: c?.title||String(obj.courseId), subject: c?.subject||'', date: obj.date, title: obj.title, tags: obj.tags, description: obj.desc, fileName: (file? file.name : null), fileType: (file? file.type : null), fileSize: (file? file.size : null) });
  ['pfTitle','pfDesc','pfTags'].forEach(id=>$('#'+id).value=''); $('#pfFile').value=''; renderPortfolio();
});
$('#pfClear')?.addEventListener('click', ()=>{ ['pfTitle','pfDesc','pfTags','pfFile'].forEach(id=>$('#'+id).value=''); });
document.body.addEventListener('click', async(e)=>{ if(e.target.classList.contains('pfDel')){ const id=Number(e.target.dataset.id); const item=await DB.get('portfolio', id); if(item?.fileId) await DB.del('files', item.fileId); await DB.del('portfolio', id); renderPortfolio(); } });

/* Transcript */
function gradePoint(letter){ 
  const map={'A+':4,'A':4,'A-':3.7,'B+':3.3,'B':3,'B-':2.7,'C+':2.3,'C':2,'C-':1.7,'D+':1.3,'D':1,'F':0}; 
  return map[letter?.toUpperCase()] ?? null; 
}
function getTranscriptOverrides(){ return JSON.parse(localStorage.getItem('pa_transcript')||'{}'); }
function setTranscriptOverrides(v){ localStorage.setItem('pa_transcript', JSON.stringify(v)); }

// Enhanced transcript validation
function validateGrade(grade) {
  if (!grade) return true; // Empty grade is valid
  const validGrades = ['A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D', 'F'];
  return validGrades.includes(grade.toUpperCase());
}
async function buildTranscript(){
  const [logs,courses,students]=await Promise.all([listLogs(), listCourses(), listStudents()]); const sId=Number($('#trStudent').value); if(!sId){ alert('Choose a student'); return; } const years=Array.from($('#trYears').selectedOptions).map(o=>Number(o.value)); const scale=Number($('#trScale').value)||120; const cMap=new Map(courses.map(c=>[c.id,c])); const st=students.find(s=>s.id===sId); const filtered=logs.filter(l=> l.studentId===sId && years.includes(yearForDate(l.date)));
  const by=new Map(); filtered.forEach(l=>{ const y=yearForDate(l.date), key=l.courseId+'|'+y; const c=cMap.get(l.courseId); const o=by.get(key)||{hours:0, subject:c?.subject, title:c?.title, year:y}; o.hours+=Number(l.hours)||0; by.set(key,o); });
  const rows=Array.from(by.values()).sort((a,b)=> (a.year-b.year)||a.title.localeCompare(b.title)); const ov=getTranscriptOverrides(); ov[sId]=ov[sId]||{};
  let html=`<div class="card" style="background:white;color:#111827"><div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:1.5rem;font-weight:800">Peaceful Academy • Kansas City, MO</div><div class="muted">Official High School Transcript</div></div><div class="muted">Issued: ${$('#trIssue').value||todayISO()}</div></div><hr><div class="grid three"><div><strong>Student</strong><div>${st?.name||''}</div></div><div><strong>DOB</strong><div>${st?.dob||''}</div></div><div><strong>Address</strong><div>${getSettings().address||'On file'}</div></div></div><table style="width:100%;border-collapse:collapse;margin-top:10px"><thead><tr><th style="text-align:left">Year</th><th style="text-align:left">Course</th><th style="text-align:left">Subject</th><th class="right">Hours</th><th class="right">Credits</th><th class="right">Grade</th><th class="right">Pts</th></tr></thead><tbody>`;
  let totalCredits=0, totalPts=0, gradedCredits=0;
  for(const r of rows){ const key=r.year+'|'+r.title; const rec=ov[sId][key] || {credit:(r.hours/scale).toFixed(2), grade:''}; ov[sId][key]=rec; const gp=gradePoint(rec.grade); const pts=gp!=null? gp*Number(rec.credit) : ''; if(gp!=null){ totalPts+=gp*Number(rec.credit); gradedCredits+=Number(rec.credit);} totalCredits+=Number(rec.credit);
    html += `<tr><td>${yearLabel(r.year)}</td><td>${r.title}</td><td>${r.subject||''}</td><td class="right">${fmt.format(r.hours)}</td><td class="right" contenteditable="true" data-tr-key="${key}" data-tr-field="credit">${rec.credit}</td><td class="right" contenteditable="true" data-tr-key="${key}" data-tr-field="grade">${rec.grade||''}</td><td class="right">${pts===''?'':fmt.format(pts)}</td></tr>`; }
  const gpa=gradedCredits? (totalPts/gradedCredits).toFixed(2) : '—';
  html += `</tbody></table><div class="row" style="justify-content:flex-end;margin-top:8px"><div class="card" style="background:#f1f5f9;color:#111827"><div><strong>Total Credits:</strong> ${fmt.format(totalCredits)}</div><div><strong>Cumulative GPA:</strong> ${gpa}</div></div></div><div class="row" style="margin-top:16px;justify-content:space-between"><div>Administrator: ${$('#trAdmin').value||''}</div><div>Signature: _____________________________</div></div></div>`;
  $('#trOut').innerHTML=html;
  
  // Fix the event listener issue by removing the {once:true} option and properly managing listeners
  const trOut = $('#trOut');
  trOut.removeEventListener('blur', handleTranscriptEdit);
  trOut.addEventListener('blur', handleTranscriptEdit);
}

// Separate function for transcript edit handling
function handleTranscriptEdit(e) {
  const td = e.target.closest('[contenteditable]');
  if (!td) return;
  
  const key = td.getAttribute('data-tr-key');
  const field = td.getAttribute('data-tr-field');
  const value = td.textContent.trim();
  const ov = getTranscriptOverrides();
  const sId = Number($('#trStudent').value);
  
  // Validate input based on field type
  if (field === 'grade' && value && !validateGrade(value)) {
    alert('Invalid grade. Please use A+, A, A-, B+, B, B-, C+, C, C-, D+, D, or F');
    buildTranscript(); // Rebuild to reset the invalid value
    return;
  }
  
  if (field === 'credit' && value) {
    const credit = Number(value);
    if (isNaN(credit) || credit < 0 || credit > 10) {
      alert('Invalid credit value. Please enter a number between 0 and 10');
      buildTranscript(); // Rebuild to reset the invalid value
      return;
    }
  }
  
  ov[sId] = ov[sId] || {};
  ov[sId][key] = ov[sId][key] || {};
  ov[sId][key][field] = value;
  setTranscriptOverrides(ov);
  buildTranscript();
}

$('#trBuild')?.addEventListener('click', buildTranscript);
$('#trPrint')?.addEventListener('click', ()=>window.print());

/* Diploma */
async function buildDiploma(){ const stId=Number($('#dpStudent').value); if(!stId){ alert('Choose a student'); return; } const st=(await listStudents()).find(s=>s.id===stId); const school=getSettings().name; const date=$('#dpDate').value||todayISO(); const place=$('#dpPlace').value||'Kansas City, Missouri'; const tA=$('#dpTitleA').value||'Administrator'; const tB=$('#dpTitleB').value||'Parent/Guardian'; const html=`<div class="diploma-page"><div class="watermark"></div><div style="text-align:center;font-family:Georgia,serif"><div style="font-size:2rem;font-weight:700">${school}</div><div style="margin-top:8px;font-size:1rem;letter-spacing:.08em">Kansas City, Missouri</div><div style="margin-top:24px;font-size:1.4rem">Diploma of High School Graduation</div><div style="margin-top:24px">This certifies that</div><div style="margin-top:6px;font-size:2.2rem;font-weight:800">${st?.name||''}</div><div style="margin-top:6px">has satisfactorily completed a course of study prescribed for graduation and is hereby awarded this diploma.</div><div style="margin-top:6px">Given at ${place}, this ${date}.</div></div><div class="row" style="margin-top:48px;justify-content:space-between"><div style="text-align:center;flex:1"><div style="height:48px;border-bottom:1px solid #1f2937;margin:0 24px"></div><div class="muted">${tA}</div></div><div style="text-align:center;flex:1"><div style="height:48px;border-bottom:1px solid #1f2937;margin:0 24px"></div><div class="muted">${tB}</div></div></div></div>`; $('#dpOut').innerHTML=html; }
$('#dpPreview')?.addEventListener('click', buildDiploma);
$('#dpPrint')?.addEventListener('click', ()=>window.print());

/* Filters & misc */
['dashStudent','dashYear','lgYearFilter','lgStudentFilter','lgSubjectFilter'].forEach(id=>{ document.getElementById(id)?.addEventListener('change', ()=>{ if(id.startsWith('dash')) renderDashboard(); else renderLogsTable(); }); });
['pfYearFilter','pfStudentFilter','pfSubjectFilter'].forEach(id=>{ document.getElementById(id)?.addEventListener('change', renderPortfolio); });
['rpStudent','rpYear','rpGroupBy'].forEach(id=>{ document.getElementById(id)?.addEventListener('change', renderReports); });
$('#rpPrint')?.addEventListener('click', ()=>window.print());

// Clean up object URLs when page unloads
window.addEventListener('beforeunload', cleanupObjectUrls);

// Hamburger menu functionality
function initHamburgerMenu() {
  const hamburger = $('#hamburger');
  const nav = $('#nav');
  
  hamburger?.addEventListener('click', () => {
    hamburger.classList.toggle('active');
    nav.classList.toggle('active');
  });
  
  // Close menu when clicking on a nav link
  nav?.addEventListener('click', (e) => {
    if (e.target.tagName === 'A') {
      hamburger.classList.remove('active');
      nav.classList.remove('active');
    }
  });
  
  // Close menu when clicking outside
  document.addEventListener('click', (e) => {
    if (!hamburger.contains(e.target) && !nav.contains(e.target)) {
      hamburger.classList.remove('active');
      nav.classList.remove('active');
    }
  });
  
  // Close menu on window resize if screen becomes larger
  window.addEventListener('resize', () => {
    if (window.innerWidth > 768) {
      hamburger.classList.remove('active');
      nav.classList.remove('active');
    }
  });
}

// Enhanced initialization with error handling
async function init(){
  try {
    if (!location.hash) location.hash = '#dashboard';
    $('#qaDate').value=todayISO(); 
    $('#lgDate').value=todayISO(); 
    $('#pfDate').value=todayISO();
    $('#trIssue').value=todayISO();
    $('#dpDate').value=todayISO();
    
    await renderStudents(); 
    await renderCourses(); 
    await renderYearSelectors(); 
    await renderDashboard();
    
    // Initialize hamburger menu
    initHamburgerMenu();
    
    // Add loading states
    document.body.classList.add('loaded');
  } catch(e) {
    console.error('Initialization error:', e);
    alert('Error initializing application. Please refresh the page.');
  }
}

// Add loading indicator styles
const style = document.createElement('style');
style.textContent = `
  body:not(.loaded) { opacity: 0.7; }
  .loading { opacity: 0.5; pointer-events: none; }
  .error { color: var(--danger); }
  .success { color: var(--ok); }
  .warning { color: #f59e0b; }
  
  /* Enhanced form validation styles */
  input:invalid, select:invalid, textarea:invalid {
    border-color: var(--danger);
  }
  
  /* Better focus states */
  input:focus, select:focus, textarea:focus, button:focus {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  
  /* Improved button states */
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  /* Enhanced table hover effects */
  tr:hover {
    background: rgba(34, 197, 94, 0.05) !important;
  }
  
  /* Hamburger menu improvements */
  .hamburger:hover span {
    background: var(--accent);
  }
  
  .hamburger:focus {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  
  /* Smooth transitions for menu items */
  nav a:hover {
    background: rgba(34, 197, 94, 0.1);
    border-color: var(--accent);
  }
  
  /* Better mobile menu styling */
  @media(max-width:768px) {
    nav a:hover {
      background: rgba(34, 197, 94, 0.15);
    }
    
    .topbar .wrap h1 {
      font-size: 1.2rem;
    }
  }
`;
document.head.appendChild(style);
</script>
</body>
</html>
