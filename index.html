<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Peaceful Fields Academy — Kansas City, Missouri</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#0b1226">
<meta name="description" content="Missouri-compliant homeschool hours, courses, and portfolio tracker for Peaceful Fields Academy, Kansas City, MO.">
<style>
:root{--bg:#0f172a;--card:#0b1226;--ink:#e5e7eb;--muted:#94a3b8;--border:#1f2937;--accent:#22c55e;--accent2:#06b6d4;--danger:#ef4444;--ok:#10b981}
*{box-sizing:border-box}html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:1100px;margin:0 auto;padding:24px}
.topbar{position:sticky;top:0;z-index:3;background:rgba(15,23,42,.86);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
nav{display:flex;gap:.5rem;flex-wrap:wrap}
nav a{padding:.5rem .8rem;border-radius:999px;border:1px solid var(--border);background:#0a1123;color:inherit;text-decoration:none}
nav a.active{background:linear-gradient(135deg,#1e293b,#0b1226)}
h1{font-size:1.4rem;margin:.6rem 0 .2rem} h2{font-size:1.15rem;margin:.2rem 0 .6rem;color:#d1d5db}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1rem}
.grid{display:grid;gap:1rem}.two{grid-template-columns:1fr 1fr}.three{grid-template-columns:repeat(3,1fr)}@media(max-width:800px){.two,.three{grid-template-columns:1fr}}
label{font-weight:600}.row{display:flex;gap:1rem;flex-wrap:wrap;align-items:center}
input,select,textarea,button{font:inherit;color:inherit}
input,select,textarea{width:100%;background:#0b1226;border:1px solid var(--border);border-radius:10px;padding:.55rem .7rem}
button{border:1px solid var(--border);background:#0a1123;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
button.primary{background:linear-gradient(135deg,#0ea5e9,#22c55e);border:none;color:white}
button.ghost{background:transparent;border:1px dashed var(--border)}
button.danger{background:var(--danger);border:none;color:white}
table{width:100%;border-collapse:collapse}th,td{padding:.5rem;border-bottom:1px solid var(--border);text-align:left}tr:hover td{background:#0c142a}
.right{text-align:right}.muted{color:var(--muted)}.hide{display:none !important}.num{font-weight:800;font-size:1.6rem}
.bar{height:10px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:#0a1123}.bar>span{display:block;height:100%;background:linear-gradient(90deg,#22c55e,#06b6d4)}
.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}.tile{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#0a1123}
.pill{padding:.25rem .5rem;border-radius:999px;border:1px solid var(--border)}
footer{margin:3rem 0 2rem;color:var(--muted);text-align:center}
.diploma-page{background:linear-gradient(180deg,#ffffff,#f8fafc);color:#111827;border:8px double #d1d5db;border-radius:12px;padding:48px;position:relative}
.watermark{position:absolute;inset:0;opacity:0.06;background:url('assets/icon.svg') center/60% no-repeat;pointer-events:none}
.signature-line{border-top:1px solid #111827;margin-top:28px;padding-top:6px}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}@media(max-width:900px){.kpis{grid-template-columns:repeat(2,1fr)}}
.kpi{padding:.6rem;border:1px solid var(--border);border-radius:12px;background:#0a1123}
@media print{ nav,.no-print{display:none !important} .diploma-page{box-shadow:none} body{background:white} .card{border:none} .wrap{max-width:900px}}
</style>
</head>
<body>
<header class="topbar">
  <div class="wrap">
    <h1>Peaceful Fields Academy • Kansas City, MO</h1>
    <nav id="nav">
      <a href="#dashboard" class="active">Dashboard</a>
      <a href="#students">Students</a>
      <a href="#courses">Courses</a>
      <a href="#log">Log Hours</a>
      <a href="#portfolio">Portfolio</a>
      <a href="#reports">Reports</a>
      <a href="#transcript">Transcript</a>
      <a href="#diploma">Diploma</a>
      <a href="#database">Database</a>
      <a href="#settings">Settings</a>
      <a href="#help">Help</a>
    </nav>
  </div>
</header>

<!-- Hidden Netlify Forms (dashboard backup) -->
<form name="log-entry" data-netlify="true" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" />
  <input type="text" name="student" /><input type="text" name="course" />
  <input type="text" name="subject" /><input type="text" name="date" />
  <input type="text" name="hours" /><input type="text" name="location" />
  <input type="text" name="notes" />
</form>
<form name="student" data-netlify="true" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" />
  <input type="text" name="name" /><input type="text" name="dob" />
  <input type="text" name="grade" /><input type="text" name="startYear" />
  <input type="text" name="notes" />
</form>
<form name="course" data-netlify="true" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" />
  <input type="text" name="title" /><input type="text" name="subject" />
  <input type="text" name="description" />
</form>
<form name="portfolio-upload" data-netlify="true" enctype="multipart/form-data" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" />
  <input type="text" name="student" /><input type="text" name="course" />
  <input type="text" name="date" /><input type="text" name="title" />
  <input type="text" name="tags" /><input type="text" name="description" />
  <input type="file" name="file" />
</form>

<main class="wrap">
  <!-- DASHBOARD -->
  <section id="view-dashboard" class="view">
    <div class="card">
      <h2>Dashboard</h2>
      <div class="kpis">
        <div class="kpi"><div class="muted">Current Academic Year</div><div class="num" id="kpiYear">—</div></div>
        <div class="kpi"><div class="muted">Total Hours (Year)</div><div class="num" id="kpiHours">0</div></div>
        <div class="kpi"><div class="muted">Core Hours</div><div class="num" id="kpiCore">0</div></div>
        <div class="kpi"><div class="muted">Home Core Hours</div><div class="num" id="kpiHomeCore">0</div></div>
      </div>
      <div class="bar" style="margin-top:.8rem"><span id="kpiBar" style="width:0%"></span></div>
      <div class="muted" style="margin-top:.3rem">Goal: 1,000 total / 600 core / 400 core-at-home</div>
    </div>

    <div class="grid two" style="margin-top:1rem">
      <div class="card">
        <h3 style="margin-top:0">Quick Add — Log Hours</h3>
        <div class="grid two">
          <div><label>Student</label><select id="qaStudent"></select></div>
          <div><label>Course</label><select id="qaCourse"></select></div>
          <div><label>Date</label><input type="date" id="qaDate"></div>
          <div><label>Hours</label><input id="qaHours" type="number" step="0.25" min="0"></div>
          <div><label>Location</label>
            <select id="qaLocation"><option value="home">home</option><option value="offsite">offsite</option></select>
          </div>
          <div><label>Notes</label><input id="qaNotes" placeholder="optional"></div>
        </div>
        <div class="row" style="margin-top:.6rem">
          <button class="primary" id="qaSave">Add Log Entry</button>
          <span class="muted" id="qaMsg"></span>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Recent Entries</h3>
        <table id="dashRecent"><thead><tr><th>Date</th><th>Student</th><th>Course</th><th class="right">Hours</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- STUDENTS -->
  <section id="view-students" class="view hide">
    <div class="card"><h2>Students</h2>
      <div class="grid two">
        <div class="card">
          <div class="grid two">
            <div><label>Name</label><input id="stName"></div>
            <div><label>DOB</label><input type="date" id="stDob"></div>
            <div><label>Grade</label><input id="stGrade"></div>
            <div><label>Start Year</label><input id="stStart" placeholder="e.g., 2024"></div>
          </div>
          <label>Notes</label><textarea id="stNotes" rows="3"></textarea>
          <div class="row" style="margin-top:.6rem"><button class="primary" id="stSave">Add Student</button><span id="stMsg" class="muted"></span></div>
        </div>
        <div>
          <table id="stTable"><thead><tr><th>Name</th><th>DOB</th><th>Grade</th><th>Start</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </section>

  <!-- COURSES -->
  <section id="view-courses" class="view hide">
    <div class="card"><h2>Courses</h2>
      <div class="grid two">
        <div class="card">
          <div class="grid two">
            <div><label>Course Title</label><input id="coTitle"></div>
            <div><label>Subject</label>
              <select id="coSubject">
                <option>Language Arts</option><option>Reading</option>
                <option>Mathematics</option><option>Science</option>
                <option>Social Studies</option><option>Elective</option>
              </select>
            </div>
          </div>
          <label>Description</label><textarea id="coDesc" rows="3"></textarea>
          <div class="row" style="margin-top:.6rem"><button class="primary" id="coSave">Add Course</button><span id="coMsg" class="muted"></span></div>
        </div>
        <div><table id="coTable"><thead><tr><th>Course</th><th>Subject</th><th>Description</th></tr></thead><tbody></tbody></table></div>
      </div>
    </div>
  </section>

  <!-- LOG HOURS -->
  <section id="view-log" class="view hide">
    <div class="card"><h2>Daily Log</h2>
      <div class="grid three">
        <div><label>Student</label><select id="lgStudent"></select></div>
        <div><label>Course</label><select id="lgCourse"></select></div>
        <div><label>Subject</label>
          <select id="lgSubject">
            <option>Reading</option><option>Language Arts</option><option>Mathematics</option>
            <option>Science</option><option>Social Studies</option><option>Elective</option>
          </select>
        </div>
        <div><label>Date</label><input type="date" id="lgDate"></div>
        <div><label>Hours</label><input id="lgHours" type="number" step="0.25" min="0"></div>
        <div><label>Location</label>
          <select id="lgLocation"><option value="home">home</option><option value="offsite">offsite</option></select>
        </div>
      </div>
      <label>Notes</label><textarea id="lgNotes" rows="2"></textarea>
      <div class="row" style="margin-top:.6rem">
        <button class="primary" id="lgSave">Add Entry</button><span id="lgMsg" class="muted"></span>
      </div>
      <div class="card" style="margin-top:1rem">
        <h3 style="margin-top:0">All Entries</h3>
        <table id="lgTable"><thead><tr><th>Date</th><th>Student</th><th>Course</th><th>Subject</th><th class="right">Hours</th><th>Location</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- PORTFOLIO -->
  <section id="view-portfolio" class="view hide">
    <div class="card"><h2>Portfolio</h2>
      <div class="grid two">
        <div class="card">
          <div class="grid two">
            <div><label>Student</label><select id="pfStudent"></select></div>
            <div><label>Course</label><select id="pfCourse"></select></div>
            <div><label>Date</label><input type="date" id="pfDate"></div>
            <div><label>Title</label><input id="pfTitle"></div>
          </div>
          <label>Tags (comma separated)</label><input id="pfTags" placeholder="e.g., essay, project, field trip">
          <label>Description</label><textarea id="pfDesc" rows="3"></textarea>
          <div class="row" style="margin-top:.6rem">
            <button class="primary" id="pfSave">Add Portfolio Item</button><span id="pfMsg" class="muted"></span>
          </div>
        </div>
        <div>
          <div class="gallery" id="pfGallery"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- REPORTS -->
  <section id="view-reports" class="view hide">
    <div class="card"><h2>Reports</h2>
      <div class="grid three">
        <div><label>Student</label><select id="rpStudent"></select></div>
        <div><label>Academic Year</label><select id="rpYear"></select></div>
        <div class="row"><button id="rpRun" class="primary">Run</button></div>
      </div>
      <div class="grid three" style="margin-top:1rem">
        <div class="card">
          <div class="muted">Total Hours</div><div class="num" id="rpTot">0</div>
          <div class="bar"><span id="rpTotBar" style="width:0%"></span></div>
        </div>
        <div class="card">
          <div class="muted">Core Hours</div><div class="num" id="rpCore">0</div>
          <div class="bar"><span id="rpCoreBar" style="width:0%"></span></div>
        </div>
        <div class="card">
          <div class="muted">Home Core Hours</div><div class="num" id="rpHomeCore">0</div>
          <div class="bar"><span id="rpHomeCoreBar" style="width:0%"></span></div>
        </div>
      </div>
      <div class="card" style="margin-top:1rem">
        <h3 style="margin-top:0">By Course</h3>
        <table id="rpByCourse"><thead><tr><th>Course</th><th>Subject</th><th class="right">Hours</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- TRANSCRIPT -->
  <section id="view-transcript" class="view hide">
    <div class="card">
      <h2>Transcript Generator</h2>
      <div class="grid three">
        <div><label>Student</label><select id="trStudent"></select></div>
        <div><label>Years (comma separated)</label><input id="trYears" placeholder="e.g., 2024,2025"></div>
        <div><label>Credit Hours per 1.0</label><input id="trScale" type="number" step="1" value="120"></div>
      </div>
      <div class="row" style="margin-top:.6rem">
        <button class="primary" id="trRun">Generate</button>
        <button id="trPrint">Print</button>
      </div>
      <div class="card" style="margin-top:1rem">
        <table id="trTable"><thead><tr><th>Year</th><th>Course</th><th>Subject</th><th class="right">Hours</th><th class="right">Credits</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- DIPLOMA -->
  <section id="view-diploma" class="view hide">
    <div class="card">
      <h2>Diploma</h2>
      <div class="grid three">
        <div><label>Student Name</label><input id="dpName"></div>
        <div><label>Graduation Date</label><input id="dpDate" type="date"></div>
        <div><label>City, State</label><input id="dpPlace" value="Kansas City, Missouri"></div>
      </div>
      <div class="row" style="margin-top:.6rem">
        <button class="primary" id="dpPreview">Preview</button>
        <button id="dpPrint">Print</button>
      </div>
      <div id="dpOut" style="margin-top:1rem"></div>
    </div>
  </section>

  <!-- DATABASE -->
  <section id="view-database" class="view hide">
    <div class="card">
      <h2>Database</h2>
      <div class="grid two">
        <div class="card">
          <h3 style="margin-top:0">Connection Health</h3>
          <div class="row">
            <button id="dbHealthBtn" class="primary">Run health check</button>
            <span class="pill">Browser: <span id="dbNetState">unknown</span></span>
          </div>
          <div id="dbHealthOut" style="margin-top:.8rem" class="muted">Not checked yet.</div>
        </div>
        <div class="card">
          <h3 style="margin-top:0">Row Counts</h3>
          <div class="row"><button id="dbStatsBtn">Refresh counts</button></div>
          <table id="dbStatsTbl" style="margin-top:.8rem">
            <thead><tr><th>Table</th><th class="right">Rows</th></tr></thead>
            <tbody>
              <tr><td>students</td><td class="right" id="c_students">—</td></tr>
              <tr><td>courses</td><td class="right" id="c_courses">—</td></tr>
              <tr><td>logs</td><td class="right" id="c_logs">—</td></tr>
              <tr><td>portfolio</td><td class="right" id="c_portfolio">—</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="view-settings" class="view hide">
    <div class="card"><h2>Settings</h2>
      <div class="grid two">
        <div class="card">
          <div class="grid two">
            <div><label>School Name</label><input id="scName" value="Peaceful Fields Academy (Kansas City, MO)"></div>
            <div><label>Year Starts</label><select id="scYearStart"><option value="07-01" selected>July 1</option></select></div>
          </div>
          <div class="row" style="margin-top:.6rem"><button class="primary" id="scSave">Save</button></div>
        </div>
      </div>
    </div>
  </section>

  <!-- HELP -->
  <section id="view-help" class="view hide">
    <div class="card">
      <h2>Help & Missouri Notes</h2>
      <ul>
        <li>Keep a plan book (daily log), maintain a portfolio, and track progress.</li>
        <li>Target at least 1,000 total hours; at least 600 in core (Reading/Language Arts/Math/Science/Social Studies), with at least 400 of those core hours at home.</li>
        <li>This app works offline (PWA), mirrors entries to Netlify Forms, and writes to Neon via Netlify Functions.</li>
      </ul>
      <div class="muted">Tip: use Transcript and Diploma pages in a desktop browser for best printing.</div>
    </div>
  </section>
</main>

<footer>© <span id="yearNow"></span> Peaceful Fields Academy • Kansas City, MO</footer>

<script>
/* PWA */
if ('serviceWorker' in navigator) { window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js')); }

/* Tiny helpers */
const $ = s=>document.querySelector(s), $$ = s=>Array.from(document.querySelectorAll(s));
const fmt = new Intl.NumberFormat();

/* Router */
function show(view){ $$('.view').forEach(v=>v.classList.add('hide')); $('#view-'+view).classList.remove('hide'); $$('#nav a').forEach(a=>a.classList.remove('active')); $(`#nav a[href="#${view}"]`)?.classList.add('active'); }
window.addEventListener('hashchange', ()=>{ const v=(location.hash||'#dashboard').slice(1); show(v); onShow(v); });

/* IndexedDB (offline-first) */
let idb; (function openDB(){ const req=indexedDB.open('peacefulAcademyDB',3); req.onupgradeneeded=e=>{const d=e.target.result;
  if(!d.objectStoreNames.contains('students')) d.createObjectStore('students',{keyPath:'id',autoIncrement:true});
  if(!d.objectStoreNames.contains('courses')) d.createObjectStore('courses',{keyPath:'id',autoIncrement:true});
  if(!d.objectStoreNames.contains('logs')) d.createObjectStore('logs',{keyPath:'id',autoIncrement:true});
  if(!d.objectStoreNames.contains('portfolio')) d.createObjectStore('portfolio',{keyPath:'id',autoIncrement:true});
}; req.onsuccess=()=>{idb=req.result; init();}; })();
function tx(names,mode='readonly'){ return idb.transaction(Array.isArray(names)?names:[names],mode); }
const DB={
  add:(s,o)=>new Promise((res,rej)=>{const r=tx(s,'readwrite').objectStore(s).add(o); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error)}),
  all:(s)=>new Promise((res,rej)=>{const r=tx(s).objectStore(s).getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=()=>rej(r.error)}),
  put:(s,o)=>new Promise((res,rej)=>{const r=tx(s,'readwrite').objectStore(s).put(o); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error)})
};

/* Utilities */
const CORE = ['Reading','Language Arts','Mathematics','Science','Social Studies'];
function academicYear(dateStr){ if(!dateStr) return null; const d=new Date(dateStr+'T00:00:00'); const m=d.getUTCMonth()+1; const y=d.getUTCFullYear(); return (m>=7? y : y-1); }
const safe = async (res)=>{ try{ return await res.json(); } catch(e){ const t=await res.text().catch(()=> ''); throw new Error(`Invalid JSON (${res.status}): ${t.slice(0,200)}`); } };

/* Netlify Forms mirror */
async function netlifySubmit(formName, data){
  try{
    const enc = d => Object.keys(d).map(k=> encodeURIComponent(k)+'='+encodeURIComponent(d[k] ?? '')).join('&');
    await fetch('/', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: enc(Object.assign({'form-name': formName, 'bot-field':''}, data)) });
  }catch(e){}
}

/* Neon helpers (serverless) */
async function neon(action, data){
  const r = await fetch('/.netlify/functions/db', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ action, data }) });
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  const j = await safe(r);
  if(j.error) throw new Error(j.error);
  return j;
}
async function apiGET(url){ const r=await fetch(url); if(!r.ok) throw new Error(`HTTP ${r.status}`); return safe(r); }

/* Populate selects */
async function refreshSelects(){
  const students = await DB.all('students');
  const courses  = await DB.all('courses');

  const fillSel = (sel, arr, mapFn) => { sel.innerHTML = ''; arr.forEach(o=>{ const opt=document.createElement('option'); const {v,t}=mapFn(o); opt.value=v; opt.textContent=t; sel.appendChild(opt); }); };

  ['qaStudent','lgStudent','pfStudent','rpStudent','trStudent'].forEach(id=>{
    const el = $('#'+id); if(!el) return;
    fillSel(el, students, s=>({v:s.id, t:s.name}));
  });
  ['qaCourse','lgCourse','pfCourse'].forEach(id=>{
    const el = $('#'+id); if(!el) return;
    fillSel(el, courses, c=>({v:c.id, t:c.title}));
  });

  // years based on logs in IDB
  const logs = await DB.all('logs');
  const years = Array.from(new Set(logs.map(l=>academicYear(l.date)).filter(Boolean))).sort((a,b)=>a-b);
  const rpYear = $('#rpYear'); rpYear.innerHTML=''; years.forEach(y=>{ const o=document.createElement('option'); o.textContent=o.value=y; rpYear.appendChild(o); });
}

/* Renderers */
async function renderDashboard(){
  const logs = await DB.all('logs');
  const year = academicYear(new Date().toISOString().slice(0,10));
  $('#kpiYear').textContent = year ?? '—';

  const thisYear = logs.filter(l=>academicYear(l.date)===year);
  const tot = thisYear.reduce((a,b)=>a+(+b.hours||0),0);
  const core = thisYear.filter(l=>CORE.includes(l.subject||'')).reduce((a,b)=>a+(+b.hours||0),0);
  const homeCore = thisYear.filter(l=>CORE.includes(l.subject||'') && (l.location==='home')).reduce((a,b)=>a+(+b.hours||0),0);

  $('#kpiHours').textContent = fmt.format(tot);
  $('#kpiCore').textContent = fmt.format(core);
  $('#kpiHomeCore').textContent = fmt.format(homeCore);
  $('#kpiBar').style.width = Math.min(100, Math.round((tot/1000)*100)) + '%';

  const recent = logs.sort((a,b)=> (a.date<b.date?1:-1)).slice(0,10);
  const tb = $('#dashRecent tbody'); tb.innerHTML='';
  recent.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.date}</td><td>${r.studentName||''}</td><td>${r.courseTitle||''}</td><td class="right">${(+r.hours||0).toFixed(2)}</td>`; tb.appendChild(tr); });

  await refreshSelects();
}
async function renderStudents(){
  const s = await DB.all('students');
  const tb = $('#stTable tbody'); tb.innerHTML='';
  s.forEach(x=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${x.name}</td><td>${x.dob||''}</td><td>${x.grade||''}</td><td>${x.startYear||''}</td>`; tb.appendChild(tr); });
}
async function renderCourses(){
  const s = await DB.all('courses');
  const tb = $('#coTable tbody'); tb.innerHTML='';
  s.forEach(x=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${x.title}</td><td>${x.subject||''}</td><td>${x.description||''}</td>`; tb.appendChild(tr); });
}
async function renderLogsTable(){
  const s = await DB.all('logs');
  const tb = $('#lgTable tbody'); tb.innerHTML='';
  s.sort((a,b)=> a.date<b.date?1:-1).forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${x.date}</td><td>${x.studentName||''}</td><td>${x.courseTitle||''}</td><td>${x.subject||''}</td><td class="right">${(+x.hours||0).toFixed(2)}</td><td>${x.location||''}</td>`;
    tb.appendChild(tr);
  });
}
async function renderPortfolio(){
  const s = await DB.all('portfolio');
  const g = $('#pfGallery'); g.innerHTML='';
  s.sort((a,b)=> (a.date||'') < (b.date||'') ? 1 : -1).forEach(p=>{
    const t=document.createElement('div'); t.className='tile'; t.innerHTML=`<div style="padding:.7rem"><div style="font-weight:700">${p.title||'(untitled)'}</div><div class="muted" style="font-size:.9rem">${p.date||''} • ${p.studentName||''} • ${p.courseTitle||''}</div><div style="margin-top:.4rem">${p.description||''}</div><div class="muted" style="margin-top:.3rem">${(p.tags||[]).join(', ')}</div></div>`;
    g.appendChild(t);
  });
}
async function renderReports(){
  await refreshSelects();
}
async function renderTranscript(){ await refreshSelects(); $('#trTable tbody').innerHTML=''; }
async function renderDiploma(){ $('#dpOut').innerHTML=''; }
async function renderDatabase(){
  const setNet=()=>{ const el=$('#dbNetState'); if(el) el.textContent = navigator.onLine? 'online' : 'offline'; };
  setNet(); window.addEventListener('online', setNet); window.addEventListener('offline', setNet);
  const out=$('#dbHealthOut'); out.textContent='Checking…';
  try{ const h=await apiGET('/.netlify/functions/api/health'); out.textContent = `OK • server time: ${h.now} • ${h.version}`; }
  catch(e){ try{ const h=await apiGET('/.netlify/functions/db?action=health'); out.textContent=`OK • server time: ${h.now} • ${h.version}`; } catch(err){ out.textContent='Health error: '+(err.message||err); } }
  try{ const s=await apiGET('/.netlify/functions/api/stats'); const st=s.stats||{}; const set=(id,v)=>{ const el=$('#'+id); if(el) el.textContent = (v!=null? v : '0'); }; set('c_students', st.students); set('c_courses', st.courses); set('c_logs', st.logs); set('c_portfolio', st.portfolio); }
  catch(e){ try{ const s=await apiGET('/.netlify/functions/db?action=stats'); const st=s.stats||{}; ['students','courses','logs','portfolio'].forEach(k=>{ const el=$('#c_'+k); if(el) el.textContent = st[k] ?? '0'; }); } catch(err){} }
}

/* On show */
function onShow(v){
  if(v==='dashboard') renderDashboard();
  if(v==='students') renderStudents();
  if(v==='courses') renderCourses();
  if(v==='log') { renderLogsTable(); refreshSelects(); }
  if(v==='portfolio') { renderPortfolio(); refreshSelects(); }
  if(v==='reports') renderReports();
  if(v==='transcript') renderTranscript();
  if(v==='diploma') renderDiploma();
  if(v==='database') renderDatabase();
}

/* Events: Quick Add */
$('#qaSave')?.addEventListener('click', async()=>{
  const sId=+$('#qaStudent').value, cId=+$('#qaCourse').value;
  const students = await DB.all('students'); const courses = await DB.all('courses');
  const student = students.find(x=>x.id===sId); const course = courses.find(x=>x.id===cId);
  const obj = {
    studentId:sId, studentName:student?.name||'',
    courseId:cId, courseTitle:course?.title||'',
    subject:course?.subject||'Elective',
    date: $('#qaDate').value || new Date().toISOString().slice(0,10),
    hours: +($('#qaHours').value || 0),
    location: $('#qaLocation').value || 'home',
    notes: $('#qaNotes').value || ''
  };
  if (!obj.studentName || !obj.courseTitle || !obj.date || obj.hours<=0) { $('#qaMsg').textContent='Fill all fields (hours > 0)'; return; }
  await DB.add('logs', obj);
  netlifySubmit('log-entry',{student:obj.studentName,course:obj.courseTitle,subject:obj.subject,date:obj.date,hours:String(obj.hours),location:obj.location,notes:obj.notes});
  try{ await neon('log.insert', obj); $('#qaMsg').textContent='Saved ✓'; }catch(e){ $('#qaMsg').textContent='Saved locally (offline)'; }
  $('#qaHours').value=''; $('#qaNotes').value='';
  renderDashboard(); renderLogsTable();
});

/* Students */
$('#stSave')?.addEventListener('click', async()=>{
  const obj={ name:$('#stName').value.trim(), dob:$('#stDob').value||'', grade:$('#stGrade').value.trim(), startYear:$('#stStart').value.trim(), notes:$('#stNotes').value.trim() };
  if(!obj.name){ $('#stMsg').textContent='Name required'; return; }
  obj.id = await DB.add('students', obj);
  netlifySubmit('student',{ name:obj.name, dob:obj.dob, grade:obj.grade, startYear:String(obj.startYear), notes:obj.notes });
  try{ await neon('student.insert', obj); $('#stMsg').textContent='Saved ✓'; }catch(e){ $('#stMsg').textContent='Saved locally (offline)'; }
  $('#stName').value=''; $('#stDob').value=''; $('#stGrade').value=''; $('#stStart').value=''; $('#stNotes').value='';
  refreshSelects(); renderStudents();
});

/* Courses */
$('#coSave')?.addEventListener('click', async()=>{
  const obj={ title:$('#coTitle').value.trim(), subject:$('#coSubject').value, description:$('#coDesc').value.trim() };
  if(!obj.title){ $('#coMsg').textContent='Title required'; return; }
  obj.id = await DB.add('courses', obj);
  netlifySubmit('course',{ title:obj.title, subject:obj.subject, description:obj.description });
  try{ await neon('course.insert', obj); $('#coMsg').textContent='Saved ✓'; }catch(e){ $('#coMsg').textContent='Saved locally (offline)'; }
  $('#coTitle').value=''; $('#coDesc').value='';
  refreshSelects(); renderCourses();
});

/* Log page save */
$('#lgSave')?.addEventListener('click', async()=>{
  const students = await DB.all('students'); const courses= await DB.all('courses');
  const sId=+$('#lgStudent').value, cId=+$('#lgCourse').value;
  const student=students.find(x=>x.id===sId), course=courses.find(x=>x.id===cId);
  const obj = {
    studentId:sId, studentName:student?.name||'',
    courseId:cId, courseTitle:course?.title||'',
    subject:$('#lgSubject').value,
    date:$('#lgDate').value || new Date().toISOString().slice(0,10),
    hours:+($('#lgHours').value || 0),
    location:$('#lgLocation').value,
    notes:$('#lgNotes').value.trim()
  };
  if (!obj.studentName || !obj.courseTitle || !obj.date || obj.hours<=0){ $('#lgMsg').textContent='Fill all fields (hours > 0)'; return; }
  await DB.add('logs', obj);
  netlifySubmit('log-entry',{student:obj.studentName,course:obj.courseTitle,subject:obj.subject,date:obj.date,hours:String(obj.hours),location:obj.location,notes:obj.notes});
  try{ await neon('log.insert', obj); $('#lgMsg').textContent='Saved ✓'; }catch(e){ $('#lgMsg').textContent='Saved locally (offline)'; }
  $('#lgHours').value=''; $('#lgNotes').value='';
  renderLogsTable(); renderDashboard();
});

/* Portfolio */
$('#pfSave')?.addEventListener('click', async()=>{
  const students = await DB.all('students'); const courses= await DB.all('courses');
  const sId=+$('#pfStudent').value, cId=+$('#pfCourse').value;
  const obj = {
    studentId:sId, studentName:(students.find(x=>x.id===sId)||{}).name || '',
    courseId:cId, courseTitle:(courses.find(x=>x.id===cId)||{}).title || '',
    subject:(courses.find(x=>x.id===cId)||{}).subject || 'Elective',
    date:$('#pfDate').value || '',
    title:$('#pfTitle').value.trim(),
    tags:($('#pfTags').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    description:$('#pfDesc').value.trim()
  };
  await DB.add('portfolio', obj);
  netlifySubmit('portfolio-upload',{student:obj.studentName,course:obj.courseTitle,date:obj.date,title:obj.title,tags:obj.tags.join(','),description:obj.description});
  try{ await neon('portfolio.insert', obj); $('#pfMsg').textContent='Saved ✓'; }catch(e){ $('#pfMsg').textContent='Saved locally (offline)'; }
  $('#pfTitle').value=''; $('#pfTags').value=''; $('#pfDesc').value='';
  renderPortfolio();
});

/* Reports */
$('#rpRun')?.addEventListener('click', async()=>{
  const sId = +$('#rpStudent').value;
  const year = +$('#rpYear').value;
  let rows;
  try{ const r = await apiGET(`/reports/yearly?studentId=${sId}&year=${year}`); rows = r.rows || []; }
  catch(e){ // fallback compute from IDB
    const logs = (await DB.all('logs')).filter(l=> l.studentId===sId && academicYear(l.date)===year);
    const tot = logs.reduce((a,b)=>a+(+b.hours||0),0);
    const core = logs.filter(l=>CORE.includes(l.subject||'')).reduce((a,b)=>a+(+b.hours||0),0);
    const home = logs.filter(l=>CORE.includes(l.subject||'') && l.location==='home').reduce((a,b)=>a+(+b.hours||0),0);
    rows = [{ total_hours: tot, core_hours: core, home_core_hours: home }];
  }
  const totals = rows[0] || { total_hours:0, core_hours:0, home_core_hours:0 };
  const set = (id,val,goal)=>{ $('#'+id).textContent = (+val||0).toFixed(2); $('#'+id+'Bar').style.width = Math.min(100, Math.round((+val/goal)*100)) + '%'; };
  set('rpTot', totals.total_hours, 1000);
  set('rpCore', totals.core_hours, 600);
  set('rpHomeCore', totals.home_core_hours, 400);

  // table by course (local compute)
  const logs = (await DB.all('logs')).filter(l=> l.studentId===sId && academicYear(l.date)===year);
  const byCourse = {};
  logs.forEach(l=>{ const key = (l.courseTitle||'Untitled') + '||' + (l.subject||''); byCourse[key] = (byCourse[key]||0) + (+l.hours||0); });
  const tb=$('#rpByCourse tbody'); tb.innerHTML='';
  Object.entries(byCourse).sort((a,b)=>b[1]-a[1]).forEach(([k,h])=>{
    const [title, subj] = k.split('||'); const tr=document.createElement('tr'); tr.innerHTML=`<td>${title}</td><td>${subj}</td><td class="right">${h.toFixed(2)}</td>`; tb.appendChild(tr);
  });
});

/* Transcript */
$('#trRun')?.addEventListener('click', async()=>{
  const sId=+$('#trStudent').value; const years=($('#trYears').value||'').split(',').map(s=>s.trim()).filter(Boolean).join(',');
  const scale = +($('#trScale').value||120);
  let rows=[];
  try{ const r = await apiGET(`/transcript/${sId}?years=${encodeURIComponent(years)}&scale=${scale}`); rows = r.rows || []; }
  catch(e){ // fallback local compute
    const targetYears = years? years.split(',').map(Number) : [];
    const logs = (await DB.all('logs')).filter(l=> l.studentId===sId && (targetYears.length? targetYears.includes(academicYear(l.date)) : true));
    const map=new Map();
    logs.forEach(l=>{
      const y=academicYear(l.date), key=`${y}||${l.courseTitle||'Untitled'}||${l.subject||'Elective'}`;
      map.set(key, (map.get(key)||0) + (+l.hours||0));
    });
    rows = Array.from(map.entries()).map(([key,hours])=>{
      const [y, title, subj] = key.split('||');
      return { academic_year:+y, course_title:title, subject:subj, hours_total:hours, credits_scale: Math.round((hours/scale)*100)/100 };
    }).sort((a,b)=> a.academic_year===b.academic_year ? a.course_title.localeCompare(b.course_title) : a.academic_year-b.academic_year);
  }
  const tb=$('#trTable tbody'); tb.innerHTML='';
  rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.academic_year}</td><td>${r.course_title}</td><td>${r.subject}</td><td class="right">${(+r.hours_total||0).toFixed(2)}</td><td class="right">${(+r.credits_scale || (+r.credits_120)||0).toFixed(2)}</td>`; tb.appendChild(tr); });
});
$('#trPrint')?.addEventListener('click', ()=> window.print());

/* Diploma */
$('#dpPreview')?.addEventListener('click', ()=>{
  const name=$('#dpName').value.trim()||'(Student Name)'; const date=$('#dpDate').value||''; const place=$('#dpPlace').value||'Kansas City, Missouri';
  $('#dpOut').innerHTML = `
  <div class="diploma-page">
    <div class="watermark"></div>
    <h1 style="text-align:center;font-size:2rem;margin:0">Diploma</h1>
    <p style="text-align:center;margin:.5rem 0 1.2rem;color:#374151">Peaceful Fields Academy • ${place}</p>
    <p style="font-size:1.1rem">This certifies that <strong>${name}</strong> has completed a program of home instruction in accordance with the requirements of the State of Missouri.</p>
    <p>Date of Graduation: <strong>${date||'__________'}</strong></p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-top:48px">
      <div>
        <div class="signature-line">Parent/Administrator</div>
      </div>
      <div>
        <div class="signature-line">Witness</div>
      </div>
    </div>
  </div>`;
});
$('#dpPrint')?.addEventListener('click', ()=> window.print());

/* Database buttons */
$('#dbHealthBtn')?.addEventListener('click', async()=>{
  const out=$('#dbHealthOut'); out.textContent='Checking…';
  try{ const h=await apiGET('/.netlify/functions/api/health'); out.textContent=`OK • server time: ${h.now} • ${h.version}`; }
  catch(e){ try{ const h=await apiGET('/.netlify/functions/db?action=health'); out.textContent=`OK • server time: ${h.now} • ${h.version}`; } catch(err){ out.textContent='Health error: '+(err.message||err); } }
});
$('#dbStatsBtn')?.addEventListener('click', async()=>{
  try{ const s=await apiGET('/.netlify/functions/api/stats'); const st=s.stats||{}; ['students','courses','logs','portfolio'].forEach(k=>{ const el=$('#c_'+k); if(el) el.textContent = st[k] ?? '0'; }); }
  catch(e){ try{ const s=await apiGET('/.netlify/functions/db?action=stats'); const st=s.stats||{}; ['students','courses','logs','portfolio'].forEach(k=>{ const el=$('#c_'+k); if(el) el.textContent = st[k] ?? '0'; }); } catch(err){} }
});

/* Init */
async function init(){
  if(!location.hash) location.hash='#dashboard';
  $('#yearNow').textContent = new Date().getFullYear();
  refreshSelects();
  onShow((location.hash||'#dashboard').slice(1));
}
</script>
</body>
</html>
