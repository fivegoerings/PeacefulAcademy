<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Peaceful Academy — Kansas City, Missouri</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Missouri-compliant homeschool hours, courses, portfolio tracker with Netlify Forms, Neon DB, and PWA." />
    <meta name="theme-color" content="#0b1226" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="./manifest.webmanifest">

<!-- Favicons -->
<link rel="icon" href="./favicon.svg" type="image/svg+xml" />
<link rel="icon" href="./favicon.ico" sizes="any" />
<link rel="apple-touch-icon" href="./apple-touch-icon.png" />
<style>
:root{--bg:#0f172a;--card:#0b1226;--ink:#e5e7eb;--muted:#94a3b8;--border:#1f2937;--accent:#22c55e;--accent2:#06b6d4;--danger:#ef4444;--ok:#10b981}
*{box-sizing:border-box}html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:1100px;margin:0 auto;padding:24px}
.topbar{position:sticky;top:0;z-index:3;background:rgba(15,23,42,.86);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
.topbar .wrap{display:flex;justify-content:space-between;align-items:center}
.hamburger{display:none;flex-direction:column;gap:4px;background:none;border:none;cursor:pointer;padding:8px}
.hamburger span{width:24px;height:3px;background:var(--ink);border-radius:2px;transition:all 0.3s ease}
.hamburger.active span:nth-child(1){transform:rotate(45deg) translate(6px,6px)}
.hamburger.active span:nth-child(2){opacity:0}
.hamburger.active span:nth-child(3){transform:rotate(-45deg) translate(6px,-6px)}
nav{display:flex;gap:.5rem;flex-wrap:wrap}
nav a{padding:.5rem .8rem;border-radius:999px;border:1px solid var(--border);background:#0a1123;color:inherit;text-decoration:none;transition:all 0.2s ease}
nav a.active{background:linear-gradient(135deg,#1e293b,#0b1226)}
nav a.admin-link{background:linear-gradient(135deg,#dc2626,#b91c1c);color:white;border-color:#dc2626}
nav a.admin-link:hover{background:linear-gradient(135deg,#b91c1c,#991b1b)}
@media(max-width:768px){
  .hamburger{display:flex}
  nav{position:absolute;top:100%;left:0;right:0;background:rgba(15,23,42,.95);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);flex-direction:column;padding:1rem;transform:translateY(-100%);opacity:0;visibility:hidden;transition:all 0.3s ease}
  nav.active{transform:translateY(0);opacity:1;visibility:visible}
  nav a{border-radius:8px;margin-bottom:0.5rem}
}
h1{font-size:1.4rem;margin:.6rem 0 .2rem} h2{font-size:1.15rem;margin:.2rem 0 .6rem;color:#d1d5db}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1rem}
.grid{display:grid;gap:1rem}.two{grid-template-columns:1fr 1fr}.three{grid-template-columns:repeat(3,1fr)}.four{grid-template-columns:repeat(4,1fr)}@media(max-width:800px){.two,.three,.four{grid-template-columns:1fr}}
label{font-weight:600}.row{display:flex;gap:1rem;flex-wrap:wrap;align-items:center}
input,select,textarea,button{font:inherit;color:inherit}
input,select,textarea{width:100%;background:#0b1226;border:1px solid var(--border);border-radius:10px;padding:.55rem .7rem}
button{border:1px solid var(--border);background:#0a1123;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
button.primary{background:linear-gradient(135deg,#0ea5e9,#22c55e);border:none;color:white}
button.ghost{background:transparent;border:1px dashed var(--border)}
button.danger{background:var(--danger);border:none;color:white}
.admin-button:hover{background:linear-gradient(135deg,#b91c1c,#991b1b) !important;transform:translateY(-1px);box-shadow:0 4px 12px rgba(220,38,38,0.3)}
table{width:100%;border-collapse:collapse}th,td{padding:.5rem;border-bottom:1px solid var(--border);text-align:left}tr:hover td{background:#0c142a}
.right{text-align:right}.muted{color:var(--muted)}.hide{display:none !important}.num{font-weight:800;font-size:1.6rem}
.bar{height:10px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:#0a1123}.bar>span{display:block;height:100%;background:linear-gradient(90deg,#22c55e,#06b6d4)}
.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}.tile{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#0a1123}
.pill{padding:.25rem .5rem;border-radius:999px;border:1px solid var(--border)}
footer{margin:3rem 0 2rem;color:var(--muted);text-align:center}
.diploma-page{background:linear-gradient(180deg,#ffffff,#f8fafc);color:#111827;border:8px double #d1d5db;border-radius:12px;padding:48px;position:relative}
.watermark{position:absolute;inset:0;opacity:0.06;background:url('assets/icon.svg') center/60% no-repeat;pointer-events:none}
@media print{ nav,.no-print{display:none !important} .diploma-page{box-shadow:none} body{background:white}}
</style>
</head>
<body>
<header class="topbar">
  <div class="wrap">
    <h1>Peaceful Academy • Kansas City, MO</h1>
    <button class="hamburger" id="hamburger" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="nav">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <nav id="nav" role="navigation" aria-label="Main navigation">
      <a href="#dashboard" class="active" aria-current="page">Dashboard</a>
      <a href="#students">Students</a>
      <a href="#courses">Courses</a>
      <a href="#log">Log Hours</a>
      <a href="#portfolio">Portfolio</a>
      <a href="#reports">Reports</a>
      <a href="#transcript">Transcript</a>
      <a href="#diploma">Diploma</a>
      <a href="#settings">Settings</a>
      <a href="#help">Help</a>
      <a href="./admin/index.html" target="_blank" class="admin-link" aria-label="Admin panel (opens in new tab)">Admin</a>
    </nav>
  </div>
</header>

<!-- Netlify hidden forms to enable Netlify Forms UI -->
<form name="log-entry" data-netlify="true" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" /><input type="text" name="student" /><input type="text" name="course" /><input type="text" name="subject" /><input type="text" name="date" /><input type="text" name="hours" /><input type="text" name="location" /><input type="text" name="notes" />
</form>
<form name="student" data-netlify="true" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" /><input type="text" name="name" /><input type="text" name="dob" /><input type="text" name="grade" /><input type="text" name="startYear" /><input type="text" name="notes" />
</form>
<form name="course" data-netlify="true" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" /><input type="text" name="title" /><input type="text" name="subject" /><input type="text" name="description" />
</form>
<form name="portfolio-upload" data-netlify="true" enctype="multipart/form-data" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" /><input type="text" name="student" /><input type="text" name="course" /><input type="text" name="date" /><input type="text" name="title" /><input type="text" name="tags" /><input type="text" name="description" /><input type="file" name="file" />
</form>

<main class="wrap">
  <section id="view-dashboard" class="view">
    <div class="grid two">
      <div class="card">
        <h2>Progress</h2>
        <div class="row">
          <div style="flex:1" class="card"><div class="muted">Total Hours (1000)</div><div class="num" id="kpiTotal">0</div><div class="bar"><span id="barTotal" style="width:0%"></span></div></div>
          <div style="flex:1" class="card"><div class="muted">Core (600)</div><div class="num" id="kpiCore">0</div><div class="bar"><span id="barCore" style="width:0%"></span></div></div>
          <div style="flex:1" class="card"><div class="muted">Core @ Home (400)</div><div class="num" id="kpiHome">0</div><div class="bar"><span id="barHome" style="width:0%"></span></div></div>
          <div style="flex:1" class="card"><div class="muted">Non-Core</div><div class="num" id="kpiNonCore">0</div><div class="bar"><span id="barNonCore" style="width:0%"></span></div></div>
        </div>
        <div class="row" style="margin-top:1rem">
          <div style="flex:1" class="card"><div class="muted">Avg Daily Hours</div><div class="num" id="kpiAvgDaily">0</div><div class="bar"><span id="barAvgDaily" style="width:0%"></span></div></div>
          <div style="flex:1" class="card"><div class="muted">Days Attended</div><div class="num" id="kpiDaysAttended">0</div><div class="bar"><span id="barDaysAttended" style="width:0%"></span></div></div>
        </div>
        <div class="row" style="margin-top:1rem">
          <div style="flex:1"><label>Student</label><select id="dashStudent"></select></div>
          <div style="flex:1"><label>Academic Year</label><select id="dashYear"></select></div>
        </div>
        <table id="recentTable" style="margin-top:.8rem"><thead><tr><th>Date</th><th>Course</th><th class="right">Hours</th><th>Loc</th><th>Notes</th></tr></thead><tbody></tbody></table>
        <div class="row hide" style="margin-top:1rem">
          <button class="admin-button" onclick="window.open('./admin/index.html', '_blank')" style="background:linear-gradient(135deg,#dc2626,#b91c1c);border:none;color:white;padding:.75rem 1.5rem;border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.2s ease;">
            <span style="margin-right:8px;">⚙️</span>Open Admin Panel
          </button>
        </div>
      </div>
      <div class="card">
        <h2>Quick Add</h2>
        <div class="grid two">
                      <div><label for="qaStudent">Student</label><select id="qaStudent" aria-describedby="qaStudent-help"></select></div>
            <div><label for="qaCourse">Course</label><select id="qaCourse" aria-describedby="qaCourse-help"></select></div>
            <div><label for="qaDate">Date</label><input type="text" id="qaDate" placeholder="mm/dd/yyyy" pattern="\d{1,2}/\d{1,2}/\d{4}" aria-describedby="qaDate-help"></div>
            <div><label for="qaMinutes">Time (minutes)</label><input type="number" step="1" min="0" id="qaMinutes" placeholder="e.g., 90 for 1.5 hours" aria-describedby="qaMinutes-help"></div>
            <div><label for="qaLocation">Location</label><select id="qaLocation" aria-describedby="qaLocation-help"><option value="home">Home</option><option value="offsite">Offsite</option></select></div>
            <div><label for="qaNotes">Notes</label><input id="qaNotes" placeholder="Lesson, lab, trip…" aria-describedby="qaNotes-help"></div>
        </div>
        <div class="row" style="margin-top:.6rem"><button class="primary" id="qaAdd">Add Hours</button><button class="ghost" id="qaToday">Today</button></div>
      </div>
    </div>
    <div id="appVersion" style="position: fixed; bottom: 10px; right: 10px; font-size: 0.75rem; color: #666; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px; z-index: 1000;"></div>
  </section>

  <section id="view-students" class="view hide">
    <div class="card"><h2>Students</h2>
      <div class="grid two">
        <div class="card">
          <div class="grid two">
            <div><label>Name</label><input id="stName"></div>
            <div><label>DOB</label><input type="date" id="stDob"></div>
            <div><label>Grade</label><input id="stGrade"></div>
            <div><label>Start Year</label><select id="stStart"></select></div>
          </div>
          <label>Notes</label><textarea id="stNotes" rows="3"></textarea>
          <div class="row" style="margin-top:.6rem"><button class="primary" id="stSave">Add Student</button><button class="ghost" id="stClear">Clear</button></div>
        </div>
        <div><table id="stTable"><thead><tr><th>Name</th><th>DOB</th><th>Grade</th><th>Start</th><th></th></tr></thead><tbody></tbody></table></div>
      </div>
    </div>
  </section>

  <section id="view-courses" class="view hide">
    <div class="card"><h2>Courses & Subjects</h2>
      <div class="grid two">
        <div class="card">
          <div class="grid two">
            <div><label>Course Title</label><input id="coTitle"></div>
            <div><label>Subject</label>
              <select id="coSubject">
                <option>Language Arts</option><option>Reading</option><option>Mathematics</option><option>Science</option><option>Social Studies</option><option>Elective</option>
              </select>
            </div>
          </div>
          <label>Description</label><textarea id="coDesc" rows="3" placeholder="Objectives, materials… (plan book)"></textarea>
          <div class="row" style="margin-top:.6rem"><button class="primary" id="coSave">Add Course</button><button class="ghost" id="coClear">Clear</button></div>
        </div>
        <div><table id="coTable"><thead><tr><th>Course</th><th>Subject</th><th>Description</th><th></th></tr></thead><tbody></tbody></table></div>
      </div>
      <div class="muted">Core subjects (Missouri): Reading, Language Arts, Mathematics, Science, Social Studies.</div>
    </div>
  </section>

  <section id="view-log" class="view hide">
    <div class="card"><h2>Daily Log</h2>
      <div class="grid three">
        <div><label>Student</label><select id="lgStudent"></select></div>
        <div><label>Course</label><select id="lgCourse"></select></div>
                    <div><label>Date</label><input type="text" id="lgDate" placeholder="mm/dd/yyyy" pattern="\d{1,2}/\d{1,2}/\d{4}"></div>
                 <div><label>Time (minutes)</label><input type="number" step="1" min="0" id="lgMinutes" placeholder="e.g., 90 for 1.5 hours"></div>
        <div><label>Location</label><select id="lgLocation"><option value="home">Home</option><option value="offsite">Offsite</option></select></div>
        <div><label>Notes</label><input id="lgNotes" placeholder="Activity details"></div>
      </div>
      <div class="row" style="margin-top:.6rem"><button class="primary" id="lgAdd">Add Entry</button><button class="ghost" id="lgToday2">Today</button></div>

      <div class="row" style="margin-top:1rem">
        <div style="flex:1"><label>Filter Year</label><select id="lgYearFilter"></select></div>
        <div style="flex:1"><label>Filter Student</label><select id="lgStudentFilter"></select></div>
        <div style="flex:1"><label>Filter Subject</label>
          <select id="lgSubjectFilter">
            <option value="">All</option><option>Language Arts</option><option>Reading</option><option>Mathematics</option><option>Science</option><option>Social Studies</option><option>Elective</option>
          </select>
        </div>
        <div class="row"><button id="exportCSV">Export CSV</button><button id="exportJSON">Backup (JSON)</button><label class="pill muted">Import JSON <input id="importJSON" type="file" accept="application/json" style="display:none"></label></div>
      </div>
      <table id="lgTable"><thead><tr><th>Date</th><th>Student</th><th>Course</th><th>Subject</th><th class="right">Hours</th><th>Loc</th><th>Notes</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="view-portfolio" class="view hide">
    <div class="card"><h2>Portfolio: Work Samples</h2>
      <div class="grid two">
        <div class="card">
          <div class="grid two">
            <div><label>Student</label><select id="pfStudent"></select></div>
            <div><label>Course</label><select id="pfCourse"></select></div>
            <div><label>Date</label><input type="text" id="pfDate" placeholder="mm/dd/yyyy" pattern="\d{1,2}/\d{1,2}/\d{4}"></div>
            <div><label>File</label><input type="file" id="pfFile" accept="image/*,application/pdf"></div>
            <div><label>Title</label><input id="pfTitle" placeholder="Essay, lab, test…"></div>
            <div><label>Tags</label><input id="pfTags" placeholder="draft, test, project"></div>
          </div>
          <label>Description</label><textarea id="pfDesc" rows="3"></textarea>
          <div class="row" style="margin-top:.6rem"><button class="primary" id="pfSave">Add to Portfolio</button><button class="ghost" id="pfClear">Clear</button></div>
          <div class="muted">Files stored locally; metadata also saved to Netlify Forms and Neon.</div>
        </div>
        <div>
          <div class="row">
            <div style="flex:1"><label>Filter Year</label><select id="pfYearFilter"></select></div>
            <div style="flex:1"><label>Filter Student</label><select id="pfStudentFilter"></select></div>
            <div style="flex:1"><label>Filter Subject</label><select id="pfSubjectFilter"><option value="">All</option><option>Language Arts</option><option>Reading</option><option>Mathematics</option><option>Science</option><option>Social Studies</option><option>Elective</option></select></div>
          </div>
          <div id="pfGallery" class="gallery" style="margin-top:12px"></div>
        </div>
      </div>
    </div>
  </section>

  <section id="view-reports" class="view hide">
    <div class="card"><h2>Annual Compliance Report</h2>
      <div class="grid three">
        <div><label>Student</label><select id="rpStudent"></select></div>
        <div><label>Academic Year</label><select id="rpYear"></select></div>
        <div><label>Group By</label><select id="rpGroupBy"><option value="subject">Subject</option><option value="course">Course</option><option value="month">Month</option></select></div>
      </div>
              <div id="rpSummary" class="grid four" style="margin-top:12px"></div>
      <table id="rpTable" style="margin-top:12px"><thead><tr><th>Group</th><th class="right">Hours</th><th class="right">Home (core)</th><th class="right">Non-Core</th></tr></thead><tbody></tbody></table>
      <div class="row" style="margin-top:12px"><button id="rpPrint">Print Report</button></div>
    </div>
  </section>

  <section id="view-transcript" class="view hide">
    <div class="card"><h2>High School Transcript (Printable)</h2>
      <div class="grid three">
        <div><label>Student</label><select id="trStudent"></select></div>
        <div><label>Include Years</label><select id="trYears" multiple size="4"></select></div>
        <div><label>Scale</label><select id="trScale"><option value="120">Carnegie (120 hrs = 1.0 credit)</option><option value="135">Block (135 hrs)</option></select></div>
      </div>
      <div class="grid two" style="margin-top:12px">
        <div><label>Administrator Name</label><input id="trAdmin" placeholder="Administrator / Parent"></div>
        <div><label>Issue Date</label><input type="text" id="trIssue" placeholder="mm/dd/yyyy" pattern="\d{1,2}/\d{1,2}/\d{4}"></div>
      </div>
      <div class="row" style="margin-top:12px"><button id="trBuild" class="primary">Build Transcript</button><button id="trPrint">Print Transcript</button></div>
      <div id="trOut" style="margin-top:16px"></div>
    </div>
  </section>

  <section id="view-diploma" class="view hide">
    <div class="card"><h2>Diploma Generator (Printable)</h2>
      <div class="grid two">
        <div><label>Student</label><select id="dpStudent"></select></div>
        <div><label>Graduation Date</label><input type="text" id="dpDate" placeholder="mm/dd/yyyy" pattern="\d{1,2}/\d{1,2}/\d{4}"></div>
        <div><label>City, State</label><input id="dpPlace" value="Kansas City, Missouri"></div>
        <div><label>Administrator Title</label><input id="dpTitleA" value="Administrator"></div>
        <div><label>Second Title</label><input id="dpTitleB" value="Parent/Guardian"></div>
      </div>
      <div class="row" style="margin-top:12px"><button id="dpPreview" class="primary">Preview</button><button id="dpPrint">Print Diploma</button></div>
      <div id="dpOut" style="margin-top:16px"></div>
    </div>
  </section>

  <section id="view-settings" class="view hide">
    <div class="card"><h2>Settings & Backups</h2>
      <div class="grid two">
        <div class="card">
          <div class="grid two">
            <div><label>School Name</label><input id="scName" value="Peaceful Academy of Kansas City, Missouri"></div>
            <div><label>Phone</label><input id="scPhone"></div>
            <div><label>Address</label><input id="scAddress" placeholder="Street, Kansas City, MO"></div>
            <div><label>Year Starts</label><select id="scYearStart"><option value="07-01" selected>July 1</option><option value="08-01">August 1</option><option value="09-01">September 1</option></select></div>
            <div style="grid-column: 1 / -1"><label><input type="checkbox" id="scNeonSync"> Enable Neon Sync (multi-device)</label><div class="muted">When enabled, the app pulls the latest data from Neon on startup and periodically while still working offline.</div></div>
          </div>
          <div class="row" style="margin-top:.6rem"><button class="primary" id="scSave">Save</button><button class="ghost" id="scReset">Reset</button></div>
        </div>
        <div class="card">
          <h3 style="margin-top:0">Data</h3>
          <div class="row">
            <button id="scExportAll">Export ALL (JSON)</button>
            <label class="pill muted">Import ALL <input type="file" id="scImportAll" accept="application/json" style="display:none"></label>
            <button class="danger" id="scWipe">Erase Everything</button>
            <button id="scExportNeon" title="Push all local data to Neon (upsert)">Export to Neon</button>
            <button id="scImportNeon" title="Replace local data with Neon data">Import from Neon</button>
            <button id="scBackupNeon" title="Save a full JSON snapshot into Neon backups">Backup to Neon</button>
            <button id="scRestoreNeon" title="Replace local data with the latest Neon backup">Restore from Neon</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="view-help" class="view hide"><div class="card">
    <h2>Help & Missouri Notes</h2>
    <ul>
      <li>Track at least <strong>1,000</strong> hours per student, with <strong>600 core</strong> in Reading/Language Arts/Math/Social Studies/Science and <strong>400 core @ home</strong>.</li>
      <li>Maintain a plan book/diary (Daily Log), a portfolio of work (Portfolio), and evaluations/assessments (attach notes/files).</li>
      <li>School year defaults to <strong>July 1 – June 30</strong>. Adjust in Settings if needed.</li>
      <li>This app works offline (PWA), mirrors to Netlify Forms, and writes to Neon Postgres via Netlify Functions.</li>
      <li><a href="/admin/console.html" target="_blank">Open Log Console</a> to see recent app messages/errors.</li>
    </ul>
  </div></section>
</main>

<footer>© <span id="yearNow"></span> Peaceful Academy • Kansas City, MO • v.0.0.3</footer>

<script>
if ('serviceWorker' in navigator) { window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js')); }

const $ = s=>document.querySelector(s), $$ = s=>Array.from(document.querySelectorAll(s));
const fmt = new Intl.NumberFormat(undefined,{maximumFractionDigits:2});

// Log console sink shared with Admin Console
const LOG_STORAGE_KEY = 'pa_log_console_v1';
function appendLog(level, parts){
  try{
    const now=new Date().toISOString();
    const entry={ ts:now, level, msg: (parts||[]).map(p=>{ try{ return typeof p==='string'? p : JSON.stringify(p); }catch(_){ return String(p);} }).join(' ') };
    const arr=JSON.parse(localStorage.getItem(LOG_STORAGE_KEY)||'[]');
    arr.push(entry);
    if(arr.length>2000) arr.splice(0, arr.length-2000);
    localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(arr));
  }catch(_){/* ignore */}
}
['log','info','warn','error'].forEach(l=>{ const orig=console[l]; console[l]=function(){ try{ appendLog(l, Array.from(arguments)); }catch(_){ } return orig.apply(console, arguments); }; });
window.addEventListener('error', e=>{ 
  appendLog('error', [e.message||'error', e.filename||'', String(e.lineno||''), String(e.colno||'')]); 
  console.error('Global error:', e);
});

window.addEventListener('unhandledrejection', e=>{ 
  appendLog('error', ['unhandledrejection', String(e.reason&&e.reason.message||e.reason||'')]); 
  console.error('Unhandled promise rejection:', e.reason);
  
  // Show user-friendly error message for critical errors
  if (e.reason && typeof e.reason === 'object' && e.reason.message) {
    showNotification('An unexpected error occurred. Please refresh the page.', 'error');
  }
});

// Fix timezone handling for dates
const todayISO = ()=> {
  const now = new Date();
  // Use local timezone to avoid date shifting issues
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

// Format date for display in mm/dd/yyyy format
const formatDateForDisplay = (dateString) => {
  if (!dateString) return '';
  const date = new Date(dateString + 'T00:00:00');
  if (isNaN(date.getTime())) return '';
  
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const year = date.getFullYear();
  
  return `${month}/${day}/${year}`;
};

// Parse mm/dd/yyyy format back to ISO format
const parseDisplayDate = (displayDate) => {
  if (!displayDate) return '';
  
  // Handle mm/dd/yyyy format
  const match = displayDate.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (match) {
    const [, month, day, year] = match;
    const monthNum = parseInt(month, 10);
    const dayNum = parseInt(day, 10);
    const yearNum = parseInt(year, 10);
    
    // Validate date
    const date = new Date(yearNum, monthNum - 1, dayNum);
    if (date.getFullYear() === yearNum && 
        date.getMonth() === monthNum - 1 && 
        date.getDate() === dayNum) {
      return `${yearNum}-${String(monthNum).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
    }
  }
  
  // If not in expected format, try to parse as ISO
  if (isValidDate(displayDate)) {
    return displayDate;
  }
  
  return '';
};

// Enhanced date validation with timezone awareness
const isValidDate = (dateString) => {
  if (!dateString) return false;
  
  // Check if it's a valid date format (YYYY-MM-DD)
  if (!/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
    return false;
  }
  
  const [year, month, day] = dateString.split('-').map(Number);
  
  // Validate year range (reasonable for educational purposes)
  if (year < 1900 || year > 2100) {
    return false;
  }
  
  // Validate month
  if (month < 1 || month > 12) {
    return false;
  }
  
  // Validate day
  const daysInMonth = new Date(year, month, 0).getDate();
  if (day < 1 || day > daysInMonth) {
    return false;
  }
  
  // Check if date is not in the future
  const inputDate = new Date(dateString + 'T00:00:00');
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  return inputDate <= today;
};

// Validate display date format (mm/dd/yyyy)
const isValidDisplayDate = (displayDate) => {
  if (!displayDate) return false;
  
  // Check if it's in mm/dd/yyyy format
  const match = displayDate.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (!match) {
    return false;
  }
  
  const [, month, day, year] = match;
  const monthNum = parseInt(month, 10);
  const dayNum = parseInt(day, 10);
  const yearNum = parseInt(year, 10);
  
  // Validate year range
  if (yearNum < 1900 || yearNum > 2100) {
    return false;
  }
  
  // Validate month
  if (monthNum < 1 || monthNum > 12) {
    return false;
  }
  
  // Validate day
  const daysInMonth = new Date(yearNum, monthNum, 0).getDate();
  if (dayNum < 1 || dayNum > daysInMonth) {
    return false;
  }
  
  // Check if date is not in the future
  const inputDate = new Date(yearNum, monthNum - 1, dayNum);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  return inputDate <= today;
};

const CORE = new Set(['Reading','Language Arts','Mathematics','Science','Social Studies']);

// Cache for object URLs to prevent memory leaks
const objectUrlCache = new Map();

// Input validation helpers
function validateMinutes(minutes) {
  const num = Number(minutes);
  return !isNaN(num) && num >= 1 && num <= 1440; // 1 minute to 24 hours (1440 minutes)
}

function minutesToHours(minutes) {
  return Number(minutes) / 60;
}

function validateDate(date) {
  return isValidDate(date);
}

function validateRequired(value) {
  return value && value.trim().length > 0;
}

// Input sanitization helper to prevent XSS
function sanitizeInput(input) {
  if (typeof input !== 'string') return '';
  return input
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;')
    .replace(/\//g, '&#x2F;');
}

// Safe HTML insertion helper
function safeInnerHTML(element, content) {
  if (!element) return;
  const div = document.createElement('div');
  div.textContent = content || '';
  element.innerHTML = div.innerHTML;
}

// Enhanced validation for student data
function validateStudentData(data) {
  const errors = [];
  if (!validateRequired(data.name)) errors.push('Student name is required');
  if (data.dob && !validateDate(data.dob)) errors.push('Invalid date of birth');
  if (data.dob) {
    const dob = new Date(data.dob);
    const today = new Date();
    const age = today.getFullYear() - dob.getFullYear();
    if (age < 3 || age > 25) errors.push('Student age seems unrealistic');
  }
  return errors;
}

/* Settings & year helpers */
function getSettings(){ return Object.assign({name:'Peaceful Academy of Kansas City, Missouri',phone:'',address:'',yearStart:'07-01', neonSync:false}, JSON.parse(localStorage.getItem('pa_settings')||'{}'));}
function setSettings(v){ localStorage.setItem('pa_settings', JSON.stringify(v)); renderSettings(); }
function yearForDate(d){ const [Y,M,D]=d.split('-').map(Number); const s=getSettings().yearStart; const anchor=new Date(Y, Number(s.slice(0,2))-1, Number(s.slice(3,5))); const dt=new Date(d+'T12:00:00'); return dt>=anchor?Y:Y-1; }
function yearLabel(y){ return y+'–'+(y+1); }
function currentAcademicStart(){ return yearForDate(todayISO()); }

/* IndexedDB */
let db; 
(function openDB(){ 
  const req=indexedDB.open('peacefulAcademyDB',2); 
  req.onupgradeneeded=e=>{
    const d=e.target.result; 
    // Create stores with better error handling
    if (!d.objectStoreNames.contains('students')) {
      d.createObjectStore('students',{keyPath:'id',autoIncrement:true}); 
    }
    if (!d.objectStoreNames.contains('courses')) {
      d.createObjectStore('courses',{keyPath:'id',autoIncrement:true}); 
    }
    if (!d.objectStoreNames.contains('logs')) {
      d.createObjectStore('logs',{keyPath:'id',autoIncrement:true}); 
    }
    if (!d.objectStoreNames.contains('portfolio')) {
      d.createObjectStore('portfolio',{keyPath:'id',autoIncrement:true}); 
    }
    if (!d.objectStoreNames.contains('files')) {
      d.createObjectStore('files',{keyPath:'id',autoIncrement:true}); 
    }
  }; 
  req.onsuccess=()=>{db=req.result; init();}; 
  req.onerror=(e)=>{
    console.error('IndexedDB error:', e);
    // Fallback: continue without IndexedDB (will use localStorage-based DB)
    db=null;
    init();
  }; 
})();
function tx(names,mode='readonly'){ return db.transaction(names,mode); }
// LocalStorage fallback helpers with size limits and cleanup
const LS_SIZE_LIMIT = 5 * 1024 * 1024; // 5MB limit per store
const LS_TOTAL_LIMIT = 50 * 1024 * 1024; // 50MB total limit

function lsKey(s){ return 'pa_store_'+s; }
function lsCounterKey(s){ return 'pa_store_'+s+'_id'; }

function lsRead(s){ 
  try{ 
    const data = localStorage.getItem(lsKey(s));
    if (!data) return [];
    return JSON.parse(data);
  } catch(e){ 
    console.error('Error reading from localStorage:', e);
    return []; 
  } 
}

function lsWrite(s, arr){ 
  try {
    // Check size before writing
    const dataSize = JSON.stringify(arr).length;
    if (dataSize > LS_SIZE_LIMIT) {
      console.warn(`Store ${s} exceeds size limit (${dataSize} bytes). Truncating...`);
      // Keep only the most recent 1000 items
      arr = arr.slice(-1000);
    }
    
    // Check total localStorage usage
    const totalSize = Object.keys(localStorage).reduce((total, key) => {
      return total + (localStorage.getItem(key)?.length || 0);
    }, 0);
    
    if (totalSize > LS_TOTAL_LIMIT) {
      console.warn('localStorage usage limit exceeded. Cleaning up old data...');
      cleanupLocalStorage();
    }
    
    localStorage.setItem(lsKey(s), JSON.stringify(arr));
  } catch(e) {
    console.error('Error writing to localStorage:', e);
    // If we can't write, try to clean up and retry
    try {
      cleanupLocalStorage();
      localStorage.setItem(lsKey(s), JSON.stringify(arr.slice(-500))); // Keep only recent items
    } catch(e2) {
      console.error('Failed to write to localStorage even after cleanup:', e2);
    }
  }
}

function lsNextId(s){ 
  const k=lsCounterKey(s); 
  const v=Number(localStorage.getItem(k)||'0')+1; 
  localStorage.setItem(k, String(v)); 
  return v; 
}

function cleanupLocalStorage() {
  try {
    const stores = ['students', 'courses', 'logs', 'portfolio', 'files'];
    const storeSizes = stores.map(store => ({
      store,
      size: JSON.stringify(lsRead(store)).length,
      count: lsRead(store).length
    }));
    
    // Sort by size (largest first)
    storeSizes.sort((a, b) => b.size - a.size);
    
    // Clean up largest stores first
    for (const { store, count } of storeSizes) {
      if (count > 1000) {
        const data = lsRead(store);
        const cleaned = data.slice(-500); // Keep only recent 500 items
        lsWrite(store, cleaned);
        console.log(`Cleaned up ${store}: kept ${cleaned.length} of ${count} items`);
      }
    }
  } catch(e) {
    console.error('Error during localStorage cleanup:', e);
  }
}
const DB={ 
  add:(s,o)=>new Promise((res,rej)=>{
    try {
      if (db) {
        const r=tx([s],'readwrite').objectStore(s).add(o); 
        r.onsuccess=()=>res(r.result); 
        r.onerror=(e)=>{
          console.error('DB add error:', e); 
          // Provide more specific error information
          const error = new Error(`Failed to add to ${s}: ${r.error?.message || 'Unknown error'}`);
          error.originalError = r.error;
          rej(error);
        } 
      } else {
        const arr=lsRead(s);
        const obj=Object.assign({}, o);
        if (obj.id==null) obj.id=lsNextId(s);
        arr.push(obj);
        lsWrite(s, arr);
        res(obj.id);
      }
    } catch(e) {
      console.error('DB add exception:', e);
      rej(e);
    }
  }), 
  put:(s,o)=>new Promise((res,rej)=>{
    try {
      if (db) {
        const r=tx([s],'readwrite').objectStore(s).put(o); 
        r.onsuccess=()=>res(r.result); 
        r.onerror=(e)=>{console.error('DB put error:', e); rej(r.error);} 
      } else {
        const arr=lsRead(s);
        const idx=arr.findIndex(it=>String(it.id)===String(o.id));
        if (idx>=0) arr[idx]=Object.assign({}, o); else arr.push(Object.assign({}, o));
        lsWrite(s, arr);
        res(o.id);
      }
    } catch(e) {
      console.error('DB put exception:', e);
      rej(e);
    }
  }), 
  get:(s,k)=>new Promise((res,rej)=>{
    try {
      if (db) {
        const r=tx([s]).objectStore(s).get(k); 
        r.onsuccess=()=>res(r.result); 
        r.onerror=(e)=>{console.error('DB get error:', e); rej(r.error);} 
      } else {
        const arr=lsRead(s);
        const v=arr.find(it=>String(it.id)===String(k));
        // Provide safe placeholder for files without blobs
        if (s==='files' && v && !v.blob) {
          v.blob=new Blob([], { type: v.type||'application/octet-stream' });
        }
        res(v||null);
      }
    } catch(e) {
      console.error('DB get exception:', e);
      rej(e);
    }
  }), 
  all:(s)=>new Promise((res,rej)=>{
    try {
      if (db) {
        const r=tx([s]).objectStore(s).getAll(); 
        r.onsuccess=()=>res(r.result || []); 
        r.onerror=(e)=>{console.error('DB all error:', e); rej(r.error);} 
      } else {
        res(lsRead(s));
      }
    } catch(e) {
      console.error('DB all exception:', e);
      rej(e);
    }
  }), 
  del:(s,k)=>new Promise((res,rej)=>{
    try {
      if (db) {
        const r=tx([s],'readwrite').objectStore(s).delete(k); 
        r.onsuccess=()=>res(); 
        r.onerror=(e)=>{console.error('DB delete error:', e); rej(r.error);} 
      } else {
        const arr=lsRead(s).filter(it=>String(it.id)!==String(k));
        lsWrite(s, arr);
        res();
      }
    } catch(e) {
      console.error('DB delete exception:', e);
      rej(e);
    }
  }) 
};

// Safely clear data stores whether IndexedDB is available or not
async function clearStoresSafely(storeNames){
  try{
    if (db) {
      await Promise.all(storeNames.map(s=> new Promise((res,rej)=>{ const r=tx([s],'readwrite').objectStore(s).clear(); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error);} )));
    } else {
      storeNames.forEach(s=>{ lsWrite(s, []); localStorage.setItem(lsCounterKey(s), '0'); });
    }
  }catch(e){ console.error('clearStoresSafely failed', e); throw e; }
}

// Clean up object URLs to prevent memory leaks
function cleanupObjectUrls() {
  for (const [key, url] of objectUrlCache.entries()) {
    URL.revokeObjectURL(url);
  }
  objectUrlCache.clear();
}

// Get or create object URL with caching
function getObjectUrl(fileId, blob) {
  if (objectUrlCache.has(fileId)) {
    return objectUrlCache.get(fileId);
  }
  const url = URL.createObjectURL(blob);
  objectUrlCache.set(fileId, url);
  return url;
}

// Enhanced portfolio rendering with proper cleanup
async function renderPortfolio(){
  // Clean up previous object URLs to prevent memory leaks
  cleanupObjectUrls();
  
  const [items,courses,students]=await Promise.all([listPortfolio(), listCourses(), listStudents()]); 
  const y=$('#pfYearFilter').value, s=$('#pfStudentFilter').value, subj=$('#pfSubjectFilter').value; 
  const cMap=new Map(courses.map(c=>[c.id,c])); 
  const sMap=new Map(students.map(x=>[x.id,x]));
  const filtered=items.filter(p=> (!y||yearForDate(p.date)==Number(y)) && (!s||p.studentId==Number(s)) && (!subj||cMap.get(Number(p.courseId))?.subject===subj)).sort((a,b)=>b.date.localeCompare(a.date));
  
  const gal=$('#pfGallery'); 
  gal.innerHTML=''; 
  
  for(const p of filtered){ 
    const c=cMap.get(Number(p.courseId)), st=sMap.get(Number(p.studentId)); 
    const file=p.fileId?await DB.get('files', p.fileId):null; 
    const url=file?getObjectUrl(p.fileId, file.blob):''; 
    const isImg = file && file.type.startsWith('image/'); 
    
    const div=document.createElement('div'); 
    div.className='tile'; 
    
    // Sanitize user input to prevent XSS
    const sanitizeHtml = (str) => {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    };
    
    div.innerHTML=`
      <div style="height:140px;display:flex;align-items:center;justify-content:center;background:#0a1123">
        ${file?(isImg?`<img src="${url}" style="width:100%;height:140px;object-fit:cover" alt="Portfolio item">`:`<div class="muted">File: ${sanitizeHtml(file.name||file.type)}</div>`):'<div class="muted">No file</div>'}
      </div>
      <div style="padding:.6rem">
        <div><strong>${sanitizeHtml(p.title||'(untitled)')}</strong></div>
        <div class="muted">${sanitizeHtml(formatDateForDisplay(p.date))} • ${sanitizeHtml(st?.name||'')} • ${sanitizeHtml(c?.title||'')}</div>
        <div style="font-size:.92rem">${sanitizeHtml(p.desc||'')}</div>
        <div class="row" style="margin-top:.5rem;justify-content:space-between">
          <div class="muted">${sanitizeHtml((p.tags||[]).join(', '))}</div>
          <div class="row">
            ${file?`<a download="${sanitizeHtml(p.title||'portfolio')}" href="${url}">Download</a>`:''}
            <button class="pfDel" data-id="${p.id}">Delete</button>
          </div>
        </div>
      </div>
    `; 
    gal.appendChild(div);
  }
}

/* Netlify forms */
function encode(data){ return Object.keys(data).map(k=> encodeURIComponent(k)+'='+encodeURIComponent(data[k])).join('&'); }
async function netlifySubmit(formName, data){ 
  try{ 
    await fetch('/', { 
      method:'POST', 
      headers:{'Content-Type':'application/x-www-form-urlencoded'}, 
      body: encode(Object.assign({'form-name': formName, 'bot-field':''}, data)) 
    }); 
  } catch(e){ 
    console.warn('Netlify submit failed', e);
  } 
}
async function netlifySubmitFormData(formName, fd){ 
  try{ 
    fd.append('form-name', formName); 
    fd.append('bot-field',''); 
    await fetch('/', { 
      method:'POST', 
      body:fd 
    }); 
  } catch(e){ 
    console.warn('Netlify file submit failed', e);
  } 
}

// Enhanced notification system
function showNotification(message, type = 'info') {
  try{ appendLog(type==='error'?'error':type==='warning'?'warn':'info', [message]); }catch(_){}
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 1000;
    animation: slideIn 0.3s ease-out;
    ${type === 'success' ? 'background: var(--ok);' : ''}
    ${type === 'error' ? 'background: var(--danger);' : ''}
    ${type === 'warning' ? 'background: #f59e0b;' : ''}
    ${type === 'info' ? 'background: var(--accent2);' : ''}
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Add notification animations
const notificationStyle = document.createElement('style');
notificationStyle.textContent = `
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(notificationStyle);

/* Neon helper */
async function saveToNeon(kind, data){ try{ await fetch('/.netlify/functions/db', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ action: kind + '.insert', data }) }); } catch(e){ console.warn('Neon save failed', e); }}

/* Lists & renders */
async function listStudents(){ return await DB.all('students'); }
async function listCourses(){ return await DB.all('courses'); }
async function listLogs(){ return await DB.all('logs'); }
async function listPortfolio(){ return await DB.all('portfolio'); }

function show(view){ $$('.view').forEach(v=>v.classList.add('hide')); $('#view-'+view).classList.remove('hide'); $$('#nav a').forEach(a=>a.classList.remove('active')); $(`#nav a[href="#${view}"]`)?.classList.add('active'); }
window.addEventListener('hashchange', ()=>{ const v=(location.hash||'#dashboard').slice(1); show(v); updateVersionVisibility(); if(v==='dashboard') renderDashboard(); if(v==='students') renderStudents(); if(v==='courses') renderCourses(); if(v==='log') renderLogsTable(); if(v==='portfolio') renderPortfolio(); if(v==='reports') renderReports(); if(v==='settings') renderSettings(); });

async function renderStudents(){
  const students = await listStudents();
  const tb = $('#stTable tbody'); if(tb){ tb.innerHTML=''; students.forEach(s=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${s.name}</td><td>${s.dob ? formatDateForDisplay(s.dob) : ''}</td><td>${s.grade||''}</td><td>${s.startYear||''}</td><td class="right"><button class="stDel" data-id="${s.id}">Delete</button></td>`; tb.appendChild(tr); });}
  const opts = students.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  ['dashStudent','qaStudent','lgStudent','lgStudentFilter','pfStudent','pfStudentFilter','rpStudent','trStudent','dpStudent'].forEach(id=>{ const el=$('#'+id); if(!el) return; const prev=el.value; el.innerHTML=(id.endsWith('Filter')?'<option value="">All</option>':'')+opts; if(prev) el.value=prev; });
}
async function renderCourses(){
  const courses=await listCourses(); const tb=$('#coTable tbody'); if(tb){ tb.innerHTML=''; courses.forEach(c=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.title}</td><td>${c.subject}</td><td class="muted">${c.description||''}</td><td class="right"><button class="coDel" data-id="${c.id}">Delete</button></td>`; tb.appendChild(tr);});}
  const opts=courses.map(c=>`<option value="${c.id}">${c.title}</option>`).join(''); ['qaCourse','lgCourse','pfCourse'].forEach(id=>{ const el=$('#'+id); if(el){ const prev=el.value; el.innerHTML=opts; if(prev) el.value=prev; }});
}
function academicYears(logs){ const ys=new Set(logs.map(l=>yearForDate(l.date))); if(!ys.size) ys.add(currentAcademicStart()); return Array.from(ys).sort((a,b)=>b-a); }
async function renderYearSelectors(){
  const logs=await listLogs(); const years=academicYears(logs);
  const set=(id,all=false)=>{ const el=$('#'+id); if(!el) return; const prev=el.value; el.innerHTML=(all?'<option value="">All</option>':'')+years.map(y=>`<option value="${y}">${yearLabel(y)}</option>`).join(''); el.value=prev||years[0]; };
  set('dashYear'); set('lgYearFilter', true); set('pfYearFilter', true); set('rpYear'); const stStart=$('#stStart'); if(stStart){ stStart.innerHTML=years.slice().reverse().map(y=>`<option value="${y}">${yearLabel(y)}</option>`).join(''); } const trYears=$('#trYears'); if(trYears){ trYears.innerHTML=years.map(y=>`<option value="${y}" selected>${yearLabel(y)}</option>`).join(''); }
}
async function renderDashboard(){
  try {
    const [logs,courses,students]=await Promise.all([
      listLogs().catch(e => { console.error('Error loading logs:', e); return []; }),
      listCourses().catch(e => { console.error('Error loading courses:', e); return []; }),
      listStudents().catch(e => { console.error('Error loading students:', e); return []; })
    ]); 
    
    await renderYearSelectors(); 
    await renderStudents(); 
    await renderCourses();
    
    const sId=Number($('#dashStudent').value || (students[0]?.id||0)); 
    $('#dashStudent').value=sId||''; 
    const yStart=Number($('#dashYear').value)||currentAcademicStart();
    
    const filtered=logs.filter(l=> Number(l.studentId)===sId && yearForDate(l.date)===yStart); 
    const cMap=new Map(courses.map(c=>[c.id,c]));
    
    let total=0, core=0, home=0, nonCore=0; 
    filtered.forEach(l=>{ 
      const subj=cMap.get(Number(l.courseId))?.subject; 
      const hrs=Number(l.hours)||0; 
      total+=hrs; 
      if(CORE.has(subj)){ 
        core+=hrs; 
        if(l.location==='home') home+=hrs; 
      } else { 
        nonCore+=hrs; 
      }
    });
    
    // Calculate average daily hours and days attended
    const uniqueDays = new Set(filtered.map(l => l.date));
    const daysAttended = uniqueDays.size;
    const avgDailyHours = daysAttended > 0 ? total / daysAttended : 0;
    
    // Safely update DOM elements
    const updateElement = (id, value) => {
      const element = $('#' + id);
      if (element) element.textContent = value;
    };
    
    updateElement('kpiTotal', fmt.format(total)); 
    updateElement('kpiCore', fmt.format(core)); 
    updateElement('kpiHome', fmt.format(home)); 
    updateElement('kpiNonCore', fmt.format(nonCore));
    updateElement('kpiAvgDaily', fmt.format(avgDailyHours)); 
    updateElement('kpiDaysAttended', daysAttended);
    
    // Update progress bars safely
    const updateBar = (id, percentage) => {
      const element = $('#' + id);
      if (element) element.style.width = Math.min(100, percentage) + '%';
    };
    
    updateBar('barTotal', (total/1000)*100); 
    updateBar('barCore', (core/600)*100); 
    updateBar('barHome', (home/400)*100); 
    updateBar('barNonCore', (nonCore/400)*100);
    updateBar('barAvgDaily', (avgDailyHours/8)*100); 
    updateBar('barDaysAttended', (daysAttended/180)*100);
    
    // Render recent table with sanitization
    const recent = filtered.slice().sort((a,b)=>b.date.localeCompare(a.date)).slice(0,10); 
    const tb=$('#recentTable tbody'); 
    if (tb) {
      tb.innerHTML=''; 
      recent.forEach(r=>{ 
        const c=cMap.get(Number(r.courseId)); 
        const tr=document.createElement('tr'); 
        
        // Sanitize data before inserting
        const sanitizeHtml = (str) => {
          const div = document.createElement('div');
          div.textContent = str || '';
          return div.innerHTML;
        };
        
        tr.innerHTML=`
          <td>${sanitizeHtml(formatDateForDisplay(r.date))}</td>
          <td>${sanitizeHtml(c?.title||'')}</td>
          <td class="right">${fmt.format(r.hours)}</td>
          <td>${r.location==='home'?'Home':'Offsite'}</td>
          <td class="muted">${sanitizeHtml(r.notes||'')}</td>
        `; 
        tb.appendChild(tr); 
      });
    }
    
    // Set form values safely
    const setValue = (id, value) => {
      const element = $('#' + id);
      if (element) element.value = value;
    };
    
    setValue('qaStudent', sId||''); 
    setValue('qaCourse', courses[0]?.id||''); 
    setValue('qaDate', todayISO());
    
  } catch (error) {
    console.error('Error rendering dashboard:', error);
    showNotification('Error loading dashboard data. Please refresh the page.', 'error');
  }
}
async function renderLogsTable(){
  try {
    const [logs,courses,students]=await Promise.all([
      listLogs().catch(e => { console.error('Error loading logs:', e); return []; }),
      listCourses().catch(e => { console.error('Error loading courses:', e); return []; }),
      listStudents().catch(e => { console.error('Error loading students:', e); return []; })
    ]);
    
    const subjF=$('#lgSubjectFilter').value; 
    const y=$('#lgYearFilter').value; 
    const s=$('#lgStudentFilter').value; 
    const cMap=new Map(courses.map(c=>[c.id,c])); 
    const sMap=new Map(students.map(x=>[x.id,x]));
    
    const filtered=logs.filter(l=> 
      (!y||yearForDate(l.date)==Number(y)) && 
      (!s||l.studentId==Number(s)) && 
      (!subjF||cMap.get(l.courseId)?.subject===subjF)
    ).sort((a,b)=>b.date.localeCompare(a.date));
    
    const tb=$('#lgTable tbody'); 
    if (tb) {
      tb.innerHTML=''; 
      filtered.forEach(l=>{ 
        const c=cMap.get(Number(l.courseId)), 
              st=sMap.get(Number(l.studentId)); 
        const tr=document.createElement('tr'); 
        
        // Sanitize data before inserting
        const sanitizeHtml = (str) => {
          const div = document.createElement('div');
          div.textContent = str || '';
          return div.innerHTML;
        };
        
        tr.innerHTML=`
          <td>${formatDateForDisplay(l.date)}</td>
          <td>${sanitizeHtml(st?.name||'')}</td>
          <td>${sanitizeHtml(c?.title||'')}</td>
          <td>${sanitizeHtml(c?.subject||'')}</td>
          <td class="right">${fmt.format(l.hours)}</td>
          <td>${l.location==='home'?'Home':'Offsite'}</td>
          <td class="muted">${sanitizeHtml(l.notes||'')}</td>
          <td class="right"><button class="lgDel" data-id="${l.id}">Delete</button></td>
        `; 
        tb.appendChild(tr); 
      });
    }
  } catch (error) {
    console.error('Error rendering logs table:', error);
    showNotification('Error loading logs table. Please refresh the page.', 'error');
  }
}

async function renderReports(){
  const [logs,courses]=await Promise.all([listLogs(), listCourses()]); const sId=Number($('#rpStudent').value); const yStart=Number($('#rpYear').value); const groupBy=$('#rpGroupBy').value; const cMap=new Map(courses.map(c=>[c.id,c])); const filtered=logs.filter(l=> Number(l.studentId)===sId && yearForDate(l.date)===yStart);
  const totals={total:0,core:0,home:0,nonCore:0}, groups=new Map(); function addG(k,hrs,home,nonCore){ const o=groups.get(k)||{hours:0,home:0,nonCore:0}; o.hours+=hrs; if(home) o.home+=hrs; if(nonCore) o.nonCore+=hrs; groups.set(k,o); }
  filtered.forEach(l=>{ const hrs=Number(l.hours)||0; const subj=cMap.get(Number(l.courseId))?.subject; totals.total+=hrs; const isCore=CORE.has(subj); const home = isCore && l.location==='home'; const nonCore = !isCore; if(isCore) totals.core+=hrs; if(home) totals.home+=hrs; if(nonCore) totals.nonCore+=hrs; let key=''; if(groupBy==='subject') key=subj||'(none)'; else if(groupBy==='course') key=cMap.get(Number(l.courseId))?.title||'(none)'; else key=l.date.slice(0,7); addG(key,hrs,home,nonCore); });
  const mk=(label,val,goal)=>`<div class="card"><div class="muted">${label} (goal ${goal})</div><div class="num">${fmt.format(val)}</div><div class="bar"><span style="width:${Math.min(100,(val/goal)*100)}%"></span></div></div>`;
  $('#rpSummary').innerHTML = mk('Total Hours',totals.total,1000)+mk('Core Hours',totals.core,600)+mk('Core @ Home',totals.home,400)+mk('Non-Core Hours',totals.nonCore,400);
  const tb=$('#rpTable tbody'); tb.innerHTML=''; Array.from(groups.entries()).sort((a,b)=>b[1].hours-a[1].hours).forEach(([k,v])=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${k}</td><td class="right">${fmt.format(v.hours)}</td><td class="right">${fmt.format(v.home)}</td><td class="right">${fmt.format(v.nonCore)}</td>`; tb.appendChild(tr); });
}

/* Events */
function renderSettings(){ const s=getSettings(); $('#scName').value=s.name; $('#scPhone').value=s.phone; $('#scAddress').value=s.address; $('#scYearStart').value=s.yearStart; $('#scNeonSync').checked=!!s.neonSync; $('#yearNow').textContent=new Date().getFullYear(); }
$('#scSave')?.addEventListener('click', ()=>{
  const settings = {
    name: $('#scName').value.trim(),
    phone: $('#scPhone').value.trim(),
    address: $('#scAddress').value.trim(),
    yearStart: $('#scYearStart').value,
    neonSync: $('#scNeonSync').checked
  };
  
  if (!settings.name) {
    showNotification('School name is required', 'error');
    return;
  }
  
  setSettings(settings);
  showNotification('Settings saved successfully!', 'success');
  renderDashboard(); 
  renderLogsTable(); 
  renderPortfolio(); 
  renderReports(); 
});
$('#scReset')?.addEventListener('click', ()=>{ if(confirm('Reset to defaults?')) setSettings({name:'Peaceful Academy of Kansas City, Missouri',phone:'',address:'',yearStart:'07-01'}); });
$('#scNeonSync')?.addEventListener('change', ()=>{ const s=getSettings(); s.neonSync = $('#scNeonSync').checked; setSettings(s); });
// Build a rich snapshot including denormalized names/subjects for logs
async function buildSnapshotPayload(){
  const [students,courses,logs,portfolio,files] = await Promise.all([
    listStudents(), listCourses(), listLogs(), listPortfolio(), DB.all('files')
  ]);
  const cMap = new Map(courses.map(c=>[Number(c.id), c]));
  const sMap = new Map(students.map(s=>[Number(s.id), s]));
  const logsRich = logs.map(l=>({
    ...l,
    studentName: sMap.get(Number(l.studentId))?.name || null,
    courseTitle: cMap.get(Number(l.courseId))?.title || null,
    subject: cMap.get(Number(l.courseId))?.subject || null
  }));
  return { settings: getSettings(), students, courses, logs: logsRich, portfolio, files };
}

$('#scExportAll')?.addEventListener('click', async()=>{ const payload = await buildSnapshotPayload(); const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:'peaceful-academy-backup.json'}); a.click(); });
$('#scImportAll')?.addEventListener('change', async(e)=>{ const f=e.target.files?.[0]; if(!f) return; if(!confirm('Import will REPLACE existing data. Continue?')) return; const data=JSON.parse(await f.text()); await clearStoresSafely(['students','courses','logs','portfolio','files']); if(data.settings) setSettings(data.settings); for(const s of (data.students||[])) await DB.add('students', s); for(const c of (data.courses||[])) await DB.add('courses', c); for(const l of (data.logs||[])) await DB.add('logs', l); for(const p of (data.portfolio||[])) await DB.add('portfolio', p); alert('Imported.'); renderDashboard(); renderStudents(); renderCourses(); renderLogsTable(); renderPortfolio(); renderReports(); });
$('#scWipe')?.addEventListener('click', async()=>{ if(!confirm('Erase ALL data?')) return; await Promise.all(['students','courses','logs','portfolio','files'].map(s=>new Promise((res,rej)=>{ const r=tx([s],'readwrite').objectStore(s).clear(); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error);}))); alert('Cleared.'); renderDashboard(); renderStudents(); renderCourses(); renderLogsTable(); renderPortfolio(); renderReports(); });

// Export all local data to Neon (bulk upsert)
$('#scExportNeon')?.addEventListener('click', async()=>{
  try {
    const payload = await buildSnapshotPayload();
    appendLog('info', ['Export to Neon started']);
    const res = await fetch('/.netlify/functions/db', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ action: 'bulk.upsertAll', data: payload })
    });
    const raw = await res.text();
    let json = null; try{ json = JSON.parse(raw); } catch(_){}
    if(!res.ok || (json && json.error)){
      const msg = (json && json.error) ? json.error : `HTTP ${res.status}`;
      appendLog('error', ['Export to Neon failed', msg, 'raw:', raw.slice(0,500)]);
      throw new Error(msg);
    }
    appendLog('info', ['Export to Neon completed', JSON.stringify(json.counts||{})]);
    showNotification('Exported to Neon successfully!', 'success');
  } catch(e){
    console.error('Export to Neon failed', e);
    appendLog('error', ['Export to Neon exception', String(e&&e.message||e)]);
    showNotification('Export to Neon failed. See console.', 'error');
  }
});

// Import all data from Neon (replace local)
$('#scImportNeon')?.addEventListener('click', async()=>{
  if(!confirm('Import from Neon will REPLACE local data. Continue?')) return;
  try {
    appendLog('info', ['Import from Neon started']);
    const res = await fetch('/.netlify/functions/db', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ action: 'bulk.readAll' })
    });
    const raw = await res.text();
    let json = null; try{ json = JSON.parse(raw); } catch(_){}
    if(!res.ok || (json && json.error)){
      const msg = (json && json.error) ? json.error : `HTTP ${res.status}`;
      appendLog('error', ['Import from Neon failed', msg, 'raw:', raw.slice(0,500)]);
      throw new Error(msg);
    }
    const data = json.data || {};
    await clearStoresSafely(['students','courses','logs','portfolio','files']); 
    if(data.settings) setSettings(data.settings);
    for(const s of (data.students||[])) await DB.add('students', s);
    for(const c of (data.courses||[])) await DB.add('courses', c);
    for(const l of (data.logs||[])) await DB.add('logs', l);
    for(const p of (data.portfolio||[])) await DB.add('portfolio', p);
    for(const f of (data.files||[])) await DB.add('files', f);
    appendLog('info', ['Import from Neon completed', `students=${(data.students||[]).length}`, `courses=${(data.courses||[]).length}`, `logs=${(data.logs||[]).length}`, `portfolio=${(data.portfolio||[]).length}`]);
    showNotification('Imported from Neon successfully!', 'success');
    renderDashboard(); renderStudents(); renderCourses(); renderLogsTable(); renderPortfolio(); renderReports();
  } catch(e){
    console.error('Import from Neon failed', e);
    appendLog('error', ['Import from Neon exception', String(e&&e.message||e)]);
    showNotification('Import from Neon failed. See console.', 'error');
  }
});

// Backup to Neon (store JSON in backups table)
$('#scBackupNeon')?.addEventListener('click', async()=>{
  try {
    appendLog('info', ['Backup to Neon started']);
    const payload = await buildSnapshotPayload();
    const res = await fetch('/.netlify/functions/db', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ action: 'backup.save', data: { payload, note: 'manual backup' } })
    });
    const raw = await res.text(); let json=null; try{ json=JSON.parse(raw);}catch(_){ }
    if(!res.ok || (json && json.error)){
      const msg=(json&&json.error)||`HTTP ${res.status}`; appendLog('error',['Backup to Neon failed', msg, 'raw:', raw.slice(0,500)]); throw new Error(msg);
    }
    appendLog('info', ['Backup to Neon completed', JSON.stringify(json)]);
    showNotification('Backup saved in Neon', 'success');
  } catch(e){ console.error('Backup to Neon failed', e); appendLog('error', ['Backup to Neon exception', String(e&&e.message||e)]); showNotification('Backup to Neon failed', 'error'); }
});

// Restore from latest Neon backup
$('#scRestoreNeon')?.addEventListener('click', async()=>{
  if(!confirm('Restore will REPLACE local data with the latest Neon backup. Continue?')) return;
  try {
    appendLog('info', ['Restore from Neon started']);
    const res = await fetch('/.netlify/functions/db', {
      method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ action: 'backup.latest' })
    });
    const raw=await res.text(); let json=null; try{ json=JSON.parse(raw);}catch(_){ }
    if(!res.ok || (json && json.error)){
      const msg=(json&&json.error)||`HTTP ${res.status}`; appendLog('error',['Restore from Neon failed', msg, 'raw:', raw.slice(0,500)]); throw new Error(msg);
    }
    const backup = json.backup; if(!backup || !backup.payload){ showNotification('No backup found in Neon', 'warning'); return; }
    const data = backup.payload;
    await clearStoresSafely(['students','courses','logs','portfolio','files']); 
    if(data.settings) setSettings(data.settings);
    for(const s of (data.students||[])) await DB.add('students', s);
    for(const c of (data.courses||[])) await DB.add('courses', c);
    for(const l of (data.logs||[])) await DB.add('logs', l);
    for(const p of (data.portfolio||[])) await DB.add('portfolio', p);
    for(const f of (data.files||[])) await DB.add('files', f);
    appendLog('info', ['Restore from Neon completed']);
    showNotification('Restored from Neon backup', 'success');
    renderDashboard(); renderStudents(); renderCourses(); renderLogsTable(); renderPortfolio(); renderReports();
  } catch(e){ console.error('Restore from Neon failed', e); appendLog('error',['Restore from Neon exception', String(e&&e.message||e)]); showNotification('Restore from Neon failed','error'); }
});

// Backfill Neon logs with student_name / course_title / subject
$('#scBackfillLogs')?.addEventListener('click', async()=>{
  try {
    appendLog('info', ['Logs backfill started']);
    const res = await fetch('/.netlify/functions/db', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ action: 'logs.backfill' }) });
    const raw=await res.text(); let json=null; try{ json=JSON.parse(raw);}catch(_){ }
    if(!res.ok || (json && json.error)){
      const msg=(json&&json.error)||`HTTP ${res.status}`; appendLog('error',['Logs backfill failed', msg, 'raw:', raw.slice(0,500)]); showNotification('Backfill failed', 'error'); return;
    }
    showNotification(`Backfilled: student_name ${json.updated.student_name}, course_title ${json.updated.course_title}, subject ${json.updated.subject}`, 'success');
    appendLog('info', ['Logs backfill completed', JSON.stringify(json.updated||{})]);
  } catch(e){ console.error('Logs backfill exception', e); appendLog('error',['Logs backfill exception', String(e&&e.message||e)]); showNotification('Backfill failed', 'error'); }
});

/* Students */
document.body.addEventListener('click', async(e)=>{ if(e.target.classList.contains('stDel')){ await DB.del('students', Number(e.target.dataset.id)); renderStudents(); renderDashboard(); renderLogsTable(); renderPortfolio(); renderReports(); } });
$('#stSave')?.addEventListener('click', async()=>{ 
  const obj={ 
    name:$('#stName').value.trim(), 
    dob:$('#stDob').value||'', 
    grade:$('#stGrade').value.trim(), 
    startYear:Number($('#stStart').value)||currentAcademicStart(), 
    notes:$('#stNotes').value.trim() 
  }; 
  
  // Enhanced validation
  const errors = validateStudentData(obj);
  if(errors.length > 0) {
    alert('Please fix the following errors:\n' + errors.join('\n'));
    return;
  }
  
  try {
    await DB.add('students', obj);
    await netlifySubmit('student', {name:obj.name, dob:obj.dob, grade:obj.grade, startYear:String(obj.startYear), notes:obj.notes});
    await saveToNeon('student', {name:obj.name, dob:obj.dob, grade:obj.grade, startYear:obj.startYear, notes:obj.notes});
    $('#stName').value=''; $('#stDob').value=''; $('#stGrade').value=''; $('#stNotes').value=''; 
    renderStudents(); renderYearSelectors(); renderDashboard(); 
  } catch(e) {
    console.error('Error saving student:', e);
    showNotification('Error saving student. Please try again.', 'error');
  }
});
$('#stClear')?.addEventListener('click', ()=>{$$('#view-students input, #view-students textarea').forEach(el=>el.value='')});

/* Courses */
document.body.addEventListener('click', async(e)=>{ if(e.target.classList.contains('coDel')){ await DB.del('courses', Number(e.target.dataset.id)); renderCourses(); renderLogsTable(); renderDashboard(); renderPortfolio(); renderReports(); } });
$('#coSave')?.addEventListener('click', async()=>{ 
  const obj={ 
    title:$('#coTitle').value.trim(), 
    subject:$('#coSubject').value, 
    description:$('#coDesc').value.trim() 
  }; 
  
  // Enhanced validation
  const errors = [];
  if(!validateRequired(obj.title)) errors.push('Course title is required');
  if(!validateRequired(obj.subject)) errors.push('Subject is required');
  if(obj.title.length > 100) errors.push('Course title is too long (max 100 characters)');
  
  if(errors.length > 0) {
    alert('Please fix the following errors:\n' + errors.join('\n'));
    return;
  }
  
  try {
    await DB.add('courses', obj);
    await netlifySubmit('course', obj);
    await saveToNeon('course', obj);
    $('#coTitle').value=''; $('#coDesc').value=''; 
    renderCourses(); renderDashboard(); 
  } catch(e) {
    console.error('Error saving course:', e);
    showNotification('Error saving course. Please try again.', 'error');
  }
});
$('#coClear')?.addEventListener('click', ()=>{$$('#view-courses input, #view-courses textarea').forEach(el=>el.value='')});

/* Logs */
$('#qaToday')?.addEventListener('click', ()=> $('#qaDate').value=formatDateForDisplay(todayISO()));
$('#lgToday2')?.addEventListener('click', ()=> $('#lgDate').value=formatDateForDisplay(todayISO()));
$('#qaAdd')?.addEventListener('click', async()=>{
  const minutes = Number($('#qaMinutes').value);
  const hours = minutesToHours(minutes);
  
  const obj={ 
    studentId:Number($('#qaStudent').value), 
    courseId:Number($('#qaCourse').value), 
    date:parseDisplayDate($('#qaDate').value)||todayISO(), 
    hours: hours, 
    location:$('#qaLocation').value, 
    notes:$('#qaNotes').value.trim() 
  };
  
  // Enhanced validation
  const errors = [];
  if(!obj.studentId){ errors.push('Please select a student'); }
  if(!obj.courseId){ errors.push('Please select a course'); }
  if(!validateMinutes(minutes)){ errors.push('Please enter valid minutes (1 to 1440)'); }
  if(!isValidDisplayDate($('#qaDate').value)){ errors.push('Please enter a valid date in mm/dd/yyyy format'); }
  if(obj.notes.length > 500) { errors.push('Notes are too long (max 500 characters)'); }
  
  if(errors.length > 0) {
    alert('Please fix the following errors:\n' + errors.join('\n'));
    return;
  }
  
  try {
    // Disable button to prevent double submission
    const button = $('#qaAdd');
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'Adding...';
    
    // Sequential operations to prevent race conditions
    const logId = await DB.add('logs', obj);
    
    // Get related data after successful DB add
    const [courses,students]=await Promise.all([listCourses(), listStudents()]); 
    const c=courses.find(x=>x.id===obj.courseId), s=students.find(x=>x.id===obj.studentId);
    
    // Fire-and-forget operations that don't affect the main flow
    Promise.allSettled([
      netlifySubmit('log-entry', { 
        student:s?.name||String(obj.studentId), 
        course:c?.title||String(obj.courseId), 
        subject:c?.subject||'', 
        date:obj.date, 
        hours:String(obj.hours), 
        location:obj.location, 
        notes:obj.notes 
      }),
      saveToNeon('log', { 
        studentId: obj.studentId, 
        studentName: s?.name||String(obj.studentId), 
        courseId: obj.courseId, 
        courseTitle: c?.title||String(obj.courseId), 
        subject: c?.subject||'', 
        date: obj.date, 
        hours: obj.hours, 
        location: obj.location, 
        notes: obj.notes 
      })
    ]).then(results => {
      results.forEach((result, index) => {
        if (result.status === 'rejected') {
          console.warn(`Background operation ${index} failed:`, result.reason);
        }
      });
    });
    
    $('#qaMinutes').value=''; $('#qaNotes').value=''; 
    renderDashboard(); renderLogsTable(); renderReports();
    showNotification('Log entry added successfully!', 'success');
  } catch(e) {
    console.error('Error adding log entry:', e);
    showNotification('Error adding log entry. Please try again.', 'error');
  } finally {
    // Re-enable button
    const button = $('#qaAdd');
    button.disabled = false;
    button.textContent = originalText;
  }
});
$('#lgAdd')?.addEventListener('click', async()=>{
  const minutes = Number($('#lgMinutes').value);
  const hours = minutesToHours(minutes);
  
  const obj={ 
    studentId:Number($('#lgStudent').value), 
    courseId:Number($('#lgCourse').value), 
    date:parseDisplayDate($('#lgDate').value)||todayISO(), 
    hours: hours, 
    location:$('#lgLocation').value, 
    notes:$('#lgNotes').value.trim() 
  };
  
  // Enhanced validation
  const errors = [];
  if(!obj.studentId){ errors.push('Please select a student'); }
  if(!obj.courseId){ errors.push('Please select a course'); }
  if(!validateMinutes(minutes)){ errors.push('Please enter valid minutes (1 to 1440)'); }
  if(!isValidDisplayDate($('#lgDate').value)){ errors.push('Please enter a valid date in mm/dd/yyyy format'); }
  if(obj.notes.length > 500) { errors.push('Notes are too long (max 500 characters)'); }
  
  if(errors.length > 0) {
    alert('Please fix the following errors:\n' + errors.join('\n'));
    return;
  }
  
  try {
    // Disable button to prevent double submission
    const button = $('#lgAdd');
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'Adding...';
    
    // Sequential operations to prevent race conditions
    const logId = await DB.add('logs', obj);
    
    // Get related data after successful DB add
    const [courses,students]=await Promise.all([listCourses(), listStudents()]); 
    const c=courses.find(x=>x.id===obj.courseId), s=students.find(x=>x.id===obj.studentId);
    
    // Fire-and-forget operations that don't affect the main flow
    Promise.allSettled([
      netlifySubmit('log-entry', { 
        student:s?.name||String(obj.studentId), 
        course:c?.title||String(obj.courseId), 
        subject:c?.subject||'', 
        date:obj.date, 
        hours:String(obj.hours), 
        location:obj.location, 
        notes:obj.notes 
      }),
      saveToNeon('log', { 
        studentId: obj.studentId, 
        studentName: s?.name||String(obj.studentId), 
        courseId: obj.courseId, 
        courseTitle: c?.title||String(obj.courseId), 
        subject: c?.subject||'', 
        date: obj.date, 
        hours: obj.hours, 
        location: obj.location, 
        notes: obj.notes 
      })
    ]).then(results => {
      results.forEach((result, index) => {
        if (result.status === 'rejected') {
          console.warn(`Background operation ${index} failed:`, result.reason);
        }
      });
    });
    
    $('#lgMinutes').value=''; $('#lgNotes').value=''; 
    renderLogsTable(); renderDashboard(); renderReports();
    showNotification('Log entry added successfully!', 'success');
  } catch(e) {
    console.error('Error adding log entry:', e);
    showNotification('Error adding log entry. Please try again.', 'error');
  } finally {
    // Re-enable button
    const button = $('#lgAdd');
    button.disabled = false;
    button.textContent = originalText;
  }
});
document.body.addEventListener('click', async(e)=>{ if(e.target.classList.contains('lgDel')){ await DB.del('logs', Number(e.target.dataset.id)); renderLogsTable(); renderDashboard(); renderReports(); } });
$('#exportCSV')?.addEventListener('click', async()=>{ const [logs,courses,students]=await Promise.all([listLogs(), listCourses(), listStudents()]); const cMap=new Map(courses.map(c=>[c.id,c])); const sMap=new Map(students.map(s=>[s.id,s])); const y=$('#lgYearFilter').value; const rows=[['date','student','course','subject','hours','location','notes']]; for(const l of logs){ if(y && yearForDate(l.date)!=Number(y)) continue; const c=cMap.get(l.courseId), st=sMap.get(l.studentId); rows.push([formatDateForDisplay(l.date), st?.name||'', c?.title||'', c?.subject||'', String(l.hours), l.location, (l.notes||'').replace(/\n/g,' ')]);} const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n'); const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([csv],{type:'text/csv'})),download:'logs.csv'}); a.click(); });
$('#exportJSON')?.addEventListener('click', async()=>{ const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([JSON.stringify({logs:await listLogs()},null,2)],{type:'application/json'})),download:'logs.json'}); a.click(); });
$('#importJSON')?.addEventListener('change', async(e)=>{ const f=e.target.files?.[0]; if(!f) return; const data=JSON.parse(await f.text()); if(!Array.isArray(data.logs)){ alert('Invalid'); return; } for(const l of data.logs) await DB.add('logs', l); alert('Imported'); renderLogsTable(); renderDashboard(); renderReports(); });

/* Portfolio */
async function fileToBlob(file){ return file.slice(0,file.size,file.type); }
$('#pfSave')?.addEventListener('click', async()=>{
  try {
    const file=$('#pfFile').files[0]||null; let fileId=null;
    if(file){ const blob=await fileToBlob(file); fileId=await DB.add('files', {blob, type:file.type, name:file.name, size:file.size}); }
    const obj={ 
      studentId:Number($('#pfStudent').value), 
      courseId:Number($('#pfCourse').value), 
      date:parseDisplayDate($('#pfDate').value)||todayISO(), 
      title:$('#pfTitle').value.trim(), 
      desc:$('#pfDesc').value.trim(), 
      tags:$('#pfTags').value.split(',').map(t=>t.trim()).filter(Boolean), 
      fileId 
    };
    
    // Enhanced validation
    const errors = [];
    if(!obj.studentId){ errors.push('Please select a student'); }
    if(!obj.courseId){ errors.push('Please select a course'); }
    if(!isValidDisplayDate($('#pfDate').value)){ errors.push('Please enter a valid date in mm/dd/yyyy format'); }
    if(!obj.title){ errors.push('Please enter a title for the portfolio item'); }
    if(obj.title && obj.title.length > 255){ errors.push('Title is too long (max 255 characters)'); }
    if(obj.desc && obj.desc.length > 1000){ errors.push('Description is too long (max 1000 characters)'); }
    if(obj.tags.length > 10){ errors.push('Too many tags (max 10)'); }
    if(obj.tags.some(tag => tag.length > 50)){ errors.push('Individual tags cannot exceed 50 characters'); }
    
    if(errors.length > 0) {
      alert('Please fix the following errors:\n' + errors.join('\n'));
      return;
    }
  
      await DB.add('portfolio', obj);
    const [courses,students]=await Promise.all([listCourses(), listStudents()]); 
    const c=courses.find(x=>x.id===obj.courseId), s=students.find(x=>x.id===obj.studentId);
    
    // Fire-and-forget operations
    Promise.allSettled([
      netlifySubmitFormData('portfolio-upload', (() => {
        const fd=new FormData(); 
        fd.append('student', s?.name||String(obj.studentId)); 
        fd.append('course', c?.title||String(obj.courseId)); 
        fd.append('date', obj.date); 
        fd.append('title', obj.title); 
        fd.append('tags', (obj.tags||[]).join(', ')); 
        fd.append('description', obj.desc); 
        if(file) fd.append('file', file, file.name); 
        return fd;
      })()),
      saveToNeon('portfolio', { 
        studentId: obj.studentId, 
        studentName: s?.name||String(obj.studentId), 
        courseId: obj.courseId, 
        courseTitle: c?.title||String(obj.courseId), 
        subject: c?.subject||'', 
        date: obj.date, 
        title: obj.title, 
        tags: obj.tags, 
        description: obj.desc, 
        fileName: (file? file.name : null), 
        fileType: (file? file.type : null), 
        fileSize: (file? file.size : null) 
      })
    ]).then(results => {
      results.forEach((result, index) => {
        if (result.status === 'rejected') {
          console.warn(`Portfolio background operation ${index} failed:`, result.reason);
        }
      });
    });
    
    ['pfTitle','pfDesc','pfTags'].forEach(id=>$('#'+id).value=''); 
    $('#pfFile').value=''; 
    renderPortfolio();
    showNotification('Portfolio item added successfully!', 'success');
  } catch(e) {
    console.error('Error adding portfolio item:', e);
    showNotification('Error adding portfolio item. Please try again.', 'error');
  }
});
});
$('#pfClear')?.addEventListener('click', ()=>{ ['pfTitle','pfDesc','pfTags','pfFile'].forEach(id=>$('#'+id).value=''); });
document.body.addEventListener('click', async(e)=>{ if(e.target.classList.contains('pfDel')){ const id=Number(e.target.dataset.id); const item=await DB.get('portfolio', id); if(item?.fileId) await DB.del('files', item.fileId); await DB.del('portfolio', id); renderPortfolio(); } });

/* Transcript */
function gradePoint(letter){ 
  const map={'A+':4,'A':4,'A-':3.7,'B+':3.3,'B':3,'B-':2.7,'C+':2.3,'C':2,'C-':1.7,'D+':1.3,'D':1,'F':0}; 
  return map[letter?.toUpperCase()] ?? null; 
}
function getTranscriptOverrides(){ return JSON.parse(localStorage.getItem('pa_transcript')||'{}'); }
function setTranscriptOverrides(v){ localStorage.setItem('pa_transcript', JSON.stringify(v)); }

// Enhanced transcript validation
function validateGrade(grade) {
  if (!grade) return true; // Empty grade is valid
  const validGrades = ['A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D', 'F'];
  return validGrades.includes(grade.toUpperCase());
}
async function buildTranscript(){
  const [logs,courses,students]=await Promise.all([listLogs(), listCourses(), listStudents()]); const sId=Number($('#trStudent').value); if(!sId){ alert('Choose a student'); return; } const years=Array.from($('#trYears').selectedOptions).map(o=>Number(o.value)); const scale=Number($('#trScale').value)||120; const cMap=new Map(courses.map(c=>[c.id,c])); const st=students.find(s=>s.id===sId); const filtered=logs.filter(l=> l.studentId===sId && years.includes(yearForDate(l.date)));
  const by=new Map(); filtered.forEach(l=>{ const y=yearForDate(l.date), key=l.courseId+'|'+y; const c=cMap.get(l.courseId); const o=by.get(key)||{hours:0, subject:c?.subject, title:c?.title, year:y}; o.hours+=Number(l.hours)||0; by.set(key,o); });
  const rows=Array.from(by.values()).sort((a,b)=> (a.year-b.year)||a.title.localeCompare(b.title)); const ov=getTranscriptOverrides(); ov[sId]=ov[sId]||{};
  let html=`<div class="card" style="background:white;color:#111827"><div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:1.5rem;font-weight:800">Peaceful Academy • Kansas City, MO</div><div class="muted">Official High School Transcript</div></div>      <div class="muted">Issued: ${formatDateForDisplay($('#trIssue').value)||formatDateForDisplay(todayISO())}</div></div><hr><div class="grid three"><div><strong>Student</strong><div>${st?.name||''}</div></div><div><strong>DOB</strong><div>${st?.dob ? formatDateForDisplay(st.dob) : ''}</div></div><div><strong>Address</strong><div>${getSettings().address||'On file'}</div></div></div><table style="width:100%;border-collapse:collapse;margin-top:10px"><thead><tr><th style="text-align:left">Year</th><th style="text-align:left">Course</th><th style="text-align:left">Subject</th><th class="right">Hours</th><th class="right">Credits</th><th class="right">Grade</th><th class="right">Pts</th></tr></thead><tbody>`;
  let totalCredits=0, totalPts=0, gradedCredits=0;
  for(const r of rows){ const key=r.year+'|'+r.title; const rec=ov[sId][key] || {credit:(r.hours/scale).toFixed(2), grade:''}; ov[sId][key]=rec; const gp=gradePoint(rec.grade); const pts=gp!=null? gp*Number(rec.credit) : ''; if(gp!=null){ totalPts+=gp*Number(rec.credit); gradedCredits+=Number(rec.credit);} totalCredits+=Number(rec.credit);
    html += `<tr><td>${yearLabel(r.year)}</td><td>${r.title}</td><td>${r.subject||''}</td><td class="right">${fmt.format(r.hours)}</td><td class="right" contenteditable="true" data-tr-key="${key}" data-tr-field="credit">${rec.credit}</td><td class="right" contenteditable="true" data-tr-key="${key}" data-tr-field="grade">${rec.grade||''}</td><td class="right">${pts===''?'':fmt.format(pts)}</td></tr>`; }
  const gpa=gradedCredits? (totalPts/gradedCredits).toFixed(2) : '—';
  html += `</tbody></table><div class="row" style="justify-content:flex-end;margin-top:8px"><div class="card" style="background:#f1f5f9;color:#111827"><div><strong>Total Credits:</strong> ${fmt.format(totalCredits)}</div><div><strong>Cumulative GPA:</strong> ${gpa}</div></div></div><div class="row" style="margin-top:16px;justify-content:space-between"><div>Administrator: ${$('#trAdmin').value||''}</div><div>Signature: _____________________________</div></div></div>`;
  $('#trOut').innerHTML=html;
  
  // Fix the event listener issue by removing the {once:true} option and properly managing listeners
  const trOut = $('#trOut');
  trOut.removeEventListener('blur', handleTranscriptEdit);
  trOut.addEventListener('blur', handleTranscriptEdit);
}

// Separate function for transcript edit handling
function handleTranscriptEdit(e) {
  const td = e.target.closest('[contenteditable]');
  if (!td) return;
  
  const key = td.getAttribute('data-tr-key');
  const field = td.getAttribute('data-tr-field');
  const value = td.textContent.trim();
  const ov = getTranscriptOverrides();
  const sId = Number($('#trStudent').value);
  
  // Validate input based on field type
  if (field === 'grade' && value && !validateGrade(value)) {
    alert('Invalid grade. Please use A+, A, A-, B+, B, B-, C+, C, C-, D+, D, or F');
    buildTranscript(); // Rebuild to reset the invalid value
    return;
  }
  
  if (field === 'credit' && value) {
    const credit = Number(value);
    if (isNaN(credit) || credit < 0 || credit > 10) {
      alert('Invalid credit value. Please enter a number between 0 and 10');
      buildTranscript(); // Rebuild to reset the invalid value
      return;
    }
  }
  
  ov[sId] = ov[sId] || {};
  ov[sId][key] = ov[sId][key] || {};
  ov[sId][key][field] = value;
  setTranscriptOverrides(ov);
  buildTranscript();
}

$('#trBuild')?.addEventListener('click', buildTranscript);
$('#trPrint')?.addEventListener('click', ()=>window.print());

/* Diploma */
async function buildDiploma(){ const stId=Number($('#dpStudent').value); if(!stId){ alert('Choose a student'); return; } const st=(await listStudents()).find(s=>s.id===stId); const school=getSettings().name; const date=formatDateForDisplay($('#dpDate').value)||formatDateForDisplay(todayISO()); const place=$('#dpPlace').value||'Kansas City, Missouri'; const tA=$('#dpTitleA').value||'Administrator'; const tB=$('#dpTitleB').value||'Parent/Guardian'; const html=`<div class="diploma-page"><div class="watermark"></div><div style="text-align:center;font-family:Georgia,serif"><div style="font-size:2rem;font-weight:700">${school}</div><div style="margin-top:8px;font-size:1rem;letter-spacing:.08em">Kansas City, Missouri</div><div style="margin-top:24px;font-size:1.4rem">Diploma of High School Graduation</div><div style="margin-top:24px">This certifies that</div><div style="margin-top:6px;font-size:2.2rem;font-weight:800">${st?.name||''}</div><div style="margin-top:6px">has satisfactorily completed a course of study prescribed for graduation and is hereby awarded this diploma.</div><div style="margin-top:6px">Given at ${place}, this ${date}.</div></div><div class="row" style="margin-top:48px;justify-content:space-between"><div style="text-align:center;flex:1"><div style="height:48px;border-bottom:1px solid #1f2937;margin:0 24px"></div><div class="muted">${tA}</div></div><div style="text-align:center;flex:1"><div style="height:48px;border-bottom:1px solid #1f2937;margin:0 24px"></div><div class="muted">${tB}</div></div></div></div>`; $('#dpOut').innerHTML=html; }
$('#dpPreview')?.addEventListener('click', buildDiploma);
$('#dpPrint')?.addEventListener('click', ()=>window.print());

/* Filters & misc with debouncing */
// Debounced render functions
const debouncedRenderDashboard = debounce(renderDashboard, 300);
const debouncedRenderLogsTable = debounce(renderLogsTable, 300);
const debouncedRenderPortfolio = debounce(renderPortfolio, 300);
const debouncedRenderReports = debounce(renderReports, 300);

['dashStudent','dashYear','lgYearFilter','lgStudentFilter','lgSubjectFilter'].forEach(id=>{ 
  document.getElementById(id)?.addEventListener('change', ()=>{
    if(id.startsWith('dash')) debouncedRenderDashboard(); 
    else debouncedRenderLogsTable(); 
  }); 
});
['pfYearFilter','pfStudentFilter','pfSubjectFilter'].forEach(id=>{ 
  document.getElementById(id)?.addEventListener('change', debouncedRenderPortfolio); 
});
['rpStudent','rpYear','rpGroupBy'].forEach(id=>{ 
  document.getElementById(id)?.addEventListener('change', debouncedRenderReports); 
});
$('#rpPrint')?.addEventListener('click', ()=>window.print());

// Clean up object URLs when page unloads
window.addEventListener('beforeunload', cleanupObjectUrls);

// Auto-format date inputs
function setupDateInputFormatting() {
  const dateInputs = document.querySelectorAll('input[placeholder*="mm/dd/yyyy"]');
  
  dateInputs.forEach(input => {
    input.addEventListener('input', (e) => {
      let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
      
      // Format as mm/dd/yyyy
      if (value.length >= 1) {
        value = value.substring(0, 2) + (value.length > 2 ? '/' + value.substring(2, 4) : '') + (value.length > 4 ? '/' + value.substring(4, 8) : '');
      }
      
      e.target.value = value;
    });
    
    // Validate on blur
    input.addEventListener('blur', (e) => {
      const value = e.target.value;
      if (value && !isValidDisplayDate(value)) {
        e.target.style.borderColor = 'var(--danger)';
        showNotification('Please enter a valid date in mm/dd/yyyy format', 'error');
      } else {
        e.target.style.borderColor = '';
      }
    });
  });
}

// Hamburger menu functionality
function initHamburgerMenu() {
  const hamburger = $('#hamburger');
  const nav = $('#nav');
  
  hamburger?.addEventListener('click', () => {
    const isActive = hamburger.classList.contains('active');
    hamburger.classList.toggle('active');
    nav.classList.toggle('active');
    
    // Update ARIA attributes
    hamburger.setAttribute('aria-expanded', !isActive);
    if (!isActive) {
      hamburger.setAttribute('aria-label', 'Close navigation menu');
    } else {
      hamburger.setAttribute('aria-label', 'Open navigation menu');
    }
  });
  
  // Close menu when clicking on a nav link
  nav?.addEventListener('click', (e) => {
    if (e.target.tagName === 'A') {
      hamburger.classList.remove('active');
      nav.classList.remove('active');
      hamburger.setAttribute('aria-expanded', 'false');
      hamburger.setAttribute('aria-label', 'Open navigation menu');
    }
  });
  
  // Close menu when clicking outside
  document.addEventListener('click', (e) => {
    if (!hamburger.contains(e.target) && !nav.contains(e.target)) {
      hamburger.classList.remove('active');
      nav.classList.remove('active');
      hamburger.setAttribute('aria-expanded', 'false');
      hamburger.setAttribute('aria-label', 'Open navigation menu');
    }
  });
  
  // Close menu on window resize if screen becomes larger
  window.addEventListener('resize', () => {
    if (window.innerWidth > 768) {
      hamburger.classList.remove('active');
      nav.classList.remove('active');
      hamburger.setAttribute('aria-expanded', 'false');
      hamburger.setAttribute('aria-label', 'Open navigation menu');
    }
  });
}

// Display app version and environment information
async function displayAppVersion() {
  const versionElement = document.getElementById('appVersion');
  if (!versionElement) return;
  
  // Get version from package.json or use a default
  const version = '1.0.0'; // This could be dynamically loaded from package.json
  
  // Try to get environment from backend first, fallback to client-side detection
  let environment = 'UNKNOWN';
  let context = 'unknown';
  
  try {
    const response = await fetch('/.netlify/functions/db', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ action: 'system.environment' })
    });
    
    if (response.ok) {
      const data = await response.json();
      environment = data.environment || 'UNKNOWN';
      context = data.context || 'unknown';
    } else {
      // Fallback to client-side detection
      const hostname = window.location.hostname;
      const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
      const isNetlifyDev = hostname.includes('netlify.app') && (hostname.includes('dev') || hostname.includes('deploy-preview'));
      const isDev = isLocalhost || isNetlifyDev;
      environment = isDev ? 'DEV' : 'PROD';
      context = isDev ? 'development' : 'production';
    }
  } catch (error) {
    // Fallback to client-side detection
    const hostname = window.location.hostname;
    const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
    const isNetlifyDev = hostname.includes('netlify.app') && (hostname.includes('dev') || hostname.includes('deploy-preview'));
    const isDev = isLocalhost || isNetlifyDev;
    environment = isDev ? 'DEV' : 'PROD';
    context = isDev ? 'development' : 'production';
  }
  
  // Get build timestamp for additional info
  const buildTime = new Date().toISOString().split('T')[0]; // Current date as fallback
  
  // Display version and environment
  versionElement.textContent = `v${version} | ${environment}`;
  
  // Add hover effect to show more details
  const details = [
    `Peaceful Academy v${version}`,
    `Environment: ${environment}`,
    `Context: ${context}`,
    `Host: ${window.location.hostname}`,
    `Build: ${buildTime}`
  ].join(' | ');
  
  versionElement.title = details;
  
  // Add subtle styling based on environment
  if (environment === 'DEV') {
    versionElement.style.background = 'rgba(255, 193, 7, 0.9)';
    versionElement.style.color = '#000';
  } else if (environment === 'PROD') {
    versionElement.style.background = 'rgba(16, 185, 129, 0.9)';
    versionElement.style.color = '#fff';
  }
  
  // Show/hide based on current view
  updateVersionVisibility();
}

// Update version visibility based on current view
function updateVersionVisibility() {
  const versionElement = document.getElementById('appVersion');
  if (!versionElement) return;
  
  const currentView = (location.hash || '#dashboard').slice(1);
  const isDashboard = currentView === 'dashboard';
  
  versionElement.style.display = isDashboard ? 'block' : 'none';
}

// Performance optimization: debounce function
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Pagination helper
function paginateArray(array, page, pageSize) {
  const start = page * pageSize;
  const end = start + pageSize;
  return {
    items: array.slice(start, end),
    total: array.length,
    page,
    pageSize,
    totalPages: Math.ceil(array.length / pageSize)
  };
}

// Enhanced initialization with error handling
async function init(){
  try {
    if (!location.hash) location.hash = '#dashboard';
    
    // Set default dates safely in mm/dd/yyyy format
    const setDateSafely = (id) => {
      const element = $('#' + id);
      if (element) element.value = formatDateForDisplay(todayISO());
    };
    
    setDateSafely('qaDate');
    setDateSafely('lgDate');
    setDateSafely('pfDate');
    setDateSafely('trIssue');
    setDateSafely('dpDate');
    
    // Initialize core components with error recovery
    try {
      await renderStudents(); 
    } catch (e) {
      console.error('Failed to render students:', e);
      showNotification('Error loading students. Some features may not work properly.', 'warning');
    }
    
    try {
      await renderCourses(); 
    } catch (e) {
      console.error('Failed to render courses:', e);
      showNotification('Error loading courses. Some features may not work properly.', 'warning');
    }
    
    try {
      await renderYearSelectors(); 
    } catch (e) {
      console.error('Failed to render year selectors:', e);
    }
    
    try {
      await renderDashboard();
    } catch (e) {
      console.error('Failed to render dashboard:', e);
      showNotification('Error loading dashboard. Please refresh the page.', 'error');
    }

    // Optional Neon sync: pull latest on startup and every 5 minutes
    const s = getSettings();
    if (s.neonSync) {
      try {
        appendLog('info', ['Neon sync: initial pull started']);
        const res = await fetch('/.netlify/functions/db', { 
          method:'POST', 
          headers:{'content-type':'application/json'}, 
          body: JSON.stringify({ action: 'backup.latest' }) 
        });
        
        const raw = await res.text(); 
        let json = null; 
        try { 
          json = JSON.parse(raw);
        } catch(_) { }
        
        if(res.ok && json && json.backup && json.backup.payload){
          const data = json.backup.payload; 
          
          // Clear and reload data safely
          try {
            await clearStoresSafely(['students','courses','logs','portfolio','files']); 
            if(data.settings) setSettings(Object.assign(getSettings(), data.settings)); 
            
            // Add data with error handling
            const addDataSafely = async (store, items) => {
              for(const item of (items||[])) {
                try {
                  await DB.add(store, item);
                } catch (e) {
                  console.warn(`Failed to add ${store} item:`, e);
                }
              }
            };
            
            await Promise.allSettled([
              addDataSafely('students', data.students),
              addDataSafely('courses', data.courses),
              addDataSafely('logs', data.logs),
              addDataSafely('portfolio', data.portfolio),
              addDataSafely('files', data.files)
            ]);
            
            appendLog('info', ['Neon sync: initial pull applied']);
            
            // Re-render with new data
            await Promise.allSettled([
              renderStudents(), 
              renderCourses(), 
              renderYearSelectors(), 
              renderDashboard()
            ]);
            
          } catch (e) {
            console.error('Error applying Neon sync data:', e);
            showNotification('Error syncing with cloud. Using local data.', 'warning');
          }
        }
      } catch(e) { 
        appendLog('warn', ['Neon sync: initial pull failed', String(e&&e.message||e)]); 
        showNotification('Cloud sync unavailable. Using local data.', 'warning');
      }

      // periodic background pull
      setInterval(async()=>{
        try{
          const res = await fetch('/.netlify/functions/db', { 
            method:'POST', 
            headers:{'content-type':'application/json'}, 
            body: JSON.stringify({ action: 'backup.latest' }) 
          });
          const json = await res.json().catch(()=>null);
          if(res.ok && json && json.backup && json.backup.payload){
            const data = json.backup.payload; 
            await clearStoresSafely(['students','courses','logs','portfolio','files']); 
            if(data.settings) setSettings(Object.assign(getSettings(), data.settings)); 
            
            // Add data with error handling
            const addDataSafely = async (store, items) => {
              for(const item of (items||[])) {
                try {
                  await DB.add(store, item);
                } catch (e) {
                  console.warn(`Failed to add ${store} item:`, e);
                }
              }
            };
            
            await Promise.allSettled([
              addDataSafely('students', data.students),
              addDataSafely('courses', data.courses),
              addDataSafely('logs', data.logs),
              addDataSafely('portfolio', data.portfolio),
              addDataSafely('files', data.files)
            ]);
            
            appendLog('info', ['Neon sync: periodic pull applied']);
          }
        }catch(e){
          console.warn('Periodic Neon sync failed:', e);
        }
      }, 5*60*1000);
    }
    
    // Initialize hamburger menu
    initHamburgerMenu();
    
    // Setup date input formatting
    setupDateInputFormatting();
    
    // Display app version and environment
    await displayAppVersion();
    
    // Add loading states
    document.body.classList.add('loaded');
    
    showNotification('Application loaded successfully!', 'success');
  } catch(e) {
    console.error('Initialization error:', e);
    showNotification('Error initializing application. Please refresh the page.', 'error');
  }
}

// Add loading indicator styles
const style = document.createElement('style');
style.textContent = `
  body:not(.loaded) { opacity: 0.7; }
  .loading { opacity: 0.5; pointer-events: none; }
  .error { color: var(--danger); }
  .success { color: var(--ok); }
  .warning { color: #f59e0b; }
  
  /* Enhanced form validation styles */
  input:invalid, select:invalid, textarea:invalid {
    border-color: var(--danger);
  }
  
  /* Better focus states */
  input:focus, select:focus, textarea:focus, button:focus {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  
  /* Improved keyboard navigation */
  button:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible {
    outline: 3px solid var(--accent);
    outline-offset: 2px;
    box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
  }
  
  /* Better color contrast for accessibility */
  .muted {
    color: #9ca3af !important; /* Better contrast than var(--muted) */
  }
  
  /* High contrast mode support */
  @media (prefers-contrast: high) {
    :root {
      --bg: #000000;
      --card: #1a1a1a;
      --ink: #ffffff;
      --muted: #cccccc;
      --border: #666666;
    }
  }
  
  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
  
  /* Improved button states */
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  /* Loading spinner for buttons */
  button.loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    margin: auto;
    border: 2px solid transparent;
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 8px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Enhanced table hover effects */
  tr:hover {
    background: rgba(34, 197, 94, 0.05) !important;
  }
  
  /* Hamburger menu improvements */
  .hamburger:hover span {
    background: var(--accent);
  }
  
  .hamburger:focus {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  
  /* Smooth transitions for menu items */
  nav a:hover {
    background: rgba(34, 197, 94, 0.1);
    border-color: var(--accent);
  }
  
  /* Better mobile menu styling */
  @media(max-width:768px) {
    nav a:hover {
      background: rgba(34, 197, 94, 0.15);
    }
    
    .topbar .wrap h1 {
      font-size: 1.2rem;
    }
  }
  
  /* Notification improvements */
  .notification {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border-radius: 8px;
    font-weight: 500;
    z-index: 1000;
  }
  
  /* Form validation feedback */
  .form-error {
    color: var(--danger);
    font-size: 0.875rem;
    margin-top: 0.25rem;
  }
  
  .form-success {
    color: var(--ok);
    font-size: 0.875rem;
    margin-top: 0.25rem;
  }
  
  /* Date input styling */
  input[placeholder*="mm/dd/yyyy"] {
    font-family: monospace;
    letter-spacing: 0.5px;
  }
  
  input[placeholder*="mm/dd/yyyy"]:focus {
    border-color: var(--accent);
  }
  
  input[placeholder*="mm/dd/yyyy"]:invalid {
    border-color: var(--danger);
  }
`;
document.head.appendChild(style);
</script>
</body>
</html>
