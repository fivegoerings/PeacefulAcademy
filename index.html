<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Peaceful Academy — Kansas City, Missouri</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Missouri-compliant homeschool hours, courses, portfolio tracker with Netlify Forms, Neon DB, and PWA." />
    <meta name="theme-color" content="#1e293b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="./manifest.webmanifest">

<!-- Favicons -->
<link rel="icon" href="./favicon.svg" type="image/svg+xml" />
<link rel="icon" href="./favicon.ico" sizes="any" />
<link rel="apple-touch-icon" href="./apple-touch-icon.png" />
<style>
:root{
  --bg: #f8fafc;
  --card: #ffffff;
  --ink: #1e293b;
  --muted: #64748b;
  --border: #e2e8f0;
  --accent: #3b82f6;
  --accent2: #06b6d4;
  --danger: #ef4444;
  --ok: #10b981;
  --success: #22c55e;
  --warning: #f59e0b;
  --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

*{box-sizing:border-box}

html,body{
  margin:0;
  height:100%;
  background:var(--bg);
  color:var(--ink);
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.wrap{
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px;
}

.topbar{
  position: sticky;
  top: 0;
  z-index: 50;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  box-shadow: var(--shadow);
}

.topbar .wrap{
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
}

.header-brand {
  display: flex;
  align-items: center;
  gap: 12px;
}

.brand-icon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
}

.header-brand h1 {
  font-size: 1.25rem;
  font-weight: 700;
  margin: 0;
  color: var(--ink);
}

.brand-subtitle {
  font-size: 0.875rem;
  color: var(--muted);
  font-weight: 500;
  margin-left: 8px;
}

.hamburger{
  display: none;
  flex-direction: column;
  gap: 4px;
  background: none;
  border: none;
  cursor: pointer;
  padding: 8px;
  border-radius: 8px;
  transition: background-color 0.2s ease;
}

.hamburger:hover {
  background-color: rgba(0, 0, 0, 0.05);
}

.hamburger span{
  width: 24px;
  height: 2px;
  background: var(--ink);
  border-radius: 1px;
  transition: all 0.3s ease;
}

.hamburger.active span:nth-child(1){
  transform: rotate(45deg) translate(6px, 6px);
}

.hamburger.active span:nth-child(2){
  opacity: 0;
}

.hamburger.active span:nth-child(3){
  transform: rotate(-45deg) translate(6px, -6px);
}

nav{
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

nav a{
  padding: 10px 16px;
  border-radius: 8px;
  border: 1px solid transparent;
  background: transparent;
  color: var(--muted);
  text-decoration: none;
  font-weight: 500;
  font-size: 14px;
  transition: all 0.2s ease;
  position: relative;
  display: flex;
  align-items: center;
  gap: 8px;
  white-space: nowrap;
}

nav a:hover{
  background: rgba(59, 130, 246, 0.05);
  color: var(--accent);
  border-color: rgba(59, 130, 246, 0.2);
}

nav a.active{
  background: var(--accent);
  color: white;
  border-color: var(--accent);
  box-shadow: var(--shadow);
}

nav a.admin-link{
  background: linear-gradient(135deg, var(--danger), #dc2626);
  color: white;
  border-color: var(--danger);
}

nav a.admin-link:hover{
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  transform: translateY(-1px);
  box-shadow: var(--shadow-lg);
}

@media(max-width: 768px){
  .hamburger{display: flex}
  nav{
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    flex-direction: column;
    padding: 16px;
    transform: translateY(-100%);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-lg);
  }
  nav.active{
    transform: translateY(0);
    opacity: 1;
    visibility: visible;
  }
  nav a{
    border-radius: 8px;
    margin-bottom: 4px;
    text-align: center;
  }
}

h1{
  font-size: 1.5rem;
  font-weight: 700;
  margin: 0;
  color: var(--ink);
  letter-spacing: -0.025em;
}

h2{
  font-size: 1.25rem;
  font-weight: 600;
  margin: 0 0 1rem 0;
  color: var(--ink);
  letter-spacing: -0.025em;
}

h3{
  font-size: 1.125rem;
  font-weight: 600;
  margin: 0 0 0.75rem 0;
  color: var(--ink);
}

.card{
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  box-shadow: var(--shadow);
  transition: box-shadow 0.2s ease, transform 0.2s ease;
}

.card:hover{
  box-shadow: var(--shadow-lg);
  transform: translateY(-1px);
}

.grid{
  display: grid;
  gap: 24px;
}

.two{
  grid-template-columns: 1fr 1fr;
}

.three{
  grid-template-columns: repeat(3, 1fr);
}

.four{
  grid-template-columns: repeat(4, 1fr);
}

@media(max-width: 800px){
  .two, .three, .four{
    grid-template-columns: 1fr;
  }
}

label{
  font-weight: 600;
  font-size: 14px;
  color: var(--ink);
  margin-bottom: 6px;
  display: block;
}

.row{
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  align-items: center;
}

input, select, textarea, button{
  font: inherit;
  color: inherit;
  border-radius: 8px;
  border: 1px solid var(--border);
  transition: all 0.2s ease;
}

input, select, textarea{
  width: 100%;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px 16px;
  font-size: 14px;
  transition: all 0.2s ease;
}

input:focus, select:focus, textarea:focus{
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

button{
  border: 1px solid var(--border);
  background: var(--card);
  border-radius: 8px;
  padding: 12px 20px;
  cursor: pointer;
  font-weight: 500;
  font-size: 14px;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

button:hover{
  background: rgba(0, 0, 0, 0.05);
  border-color: var(--accent);
  transform: translateY(-1px);
  box-shadow: var(--shadow);
}

button.primary{
  background: var(--accent);
  border: 1px solid var(--accent);
  color: white;
  font-weight: 600;
}

button.primary:hover{
  background: #2563eb;
  border-color: #2563eb;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

button.ghost{
  background: transparent;
  border: 1px dashed var(--border);
  color: var(--muted);
}

button.ghost:hover{
  background: rgba(0, 0, 0, 0.05);
  border-color: var(--accent);
  color: var(--accent);
}

button.danger{
  background: var(--danger);
  border: 1px solid var(--danger);
  color: white;
}

button.danger:hover{
  background: #dc2626;
  border-color: #dc2626;
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.admin-button:hover{
  background: linear-gradient(135deg, #dc2626, #b91c1c) !important;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

table{
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
  background: var(--card);
  border-radius: 8px;
  overflow: hidden;
  box-shadow: var(--shadow);
}

th, td{
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  text-align: left;
  font-size: 14px;
}

th{
  background: rgba(0, 0, 0, 0.02);
  font-weight: 600;
  color: var(--ink);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

tr:hover td{
  background: rgba(59, 130, 246, 0.02);
}

.right{
  text-align: right;
}

.muted{
  color: var(--muted);
  font-size: 14px;
}

.hide{
  display: none !important;
}

.num{
  font-weight: 700;
  font-size: 1.75rem;
  color: var(--ink);
  line-height: 1.2;
}

.bar{
  height: 8px;
  border: 1px solid var(--border);
  border-radius: 4px;
  overflow: hidden;
  background: rgba(0, 0, 0, 0.05);
  margin-top: 8px;
}

.bar > span{
  display: block;
  height: 100%;
  background: linear-gradient(90deg, var(--success), var(--accent2));
  border-radius: 4px;
  transition: width 0.3s ease;
}

.gallery{
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 16px;
}

.tile{
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  background: var(--card);
  transition: all 0.2s ease;
}

.tile:hover{
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.pill{
  padding: 6px 12px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--card);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

.pill:hover{
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}

footer{
  margin: 48px 0 24px;
  color: var(--muted);
  text-align: center;
  font-size: 14px;
}

/* Professional footer styling */
.footer {
  background: var(--card);
  border-top: 1px solid var(--border);
  padding: 48px 0 24px;
  margin-top: 64px;
}

.footer-content {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 48px;
  margin-bottom: 32px;
}

.footer-brand {
  display: flex;
  align-items: flex-start;
  gap: 16px;
}

.footer-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  flex-shrink: 0;
}

.footer-brand h3 {
  margin: 0 0 8px 0;
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--ink);
}

.footer-brand p {
  margin: 0;
  color: var(--muted);
  font-size: 14px;
  line-height: 1.5;
}

.footer-links {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 32px;
}

.footer-section h4 {
  margin: 0 0 16px 0;
  font-size: 1rem;
  font-weight: 600;
  color: var(--ink);
}

.footer-section ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.footer-section li {
  margin-bottom: 8px;
}

.footer-section a {
  color: var(--muted);
  text-decoration: none;
  font-size: 14px;
  transition: color 0.2s ease;
}

.footer-section a:hover {
  color: var(--accent);
}

.footer-bottom {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 24px;
  border-top: 1px solid var(--border);
}

.footer-bottom p {
  margin: 0;
  color: var(--muted);
  font-size: 14px;
}

.footer-badges {
  display: flex;
  gap: 8px;
}

.footer-badges .badge {
  font-size: 12px;
  padding: 4px 8px;
  background: rgba(59, 130, 246, 0.1);
  color: var(--accent);
  border-color: rgba(59, 130, 246, 0.2);
}

@media (max-width: 768px) {
  .footer-content {
    grid-template-columns: 1fr;
    gap: 32px;
  }
  
  .footer-links {
    grid-template-columns: 1fr;
    gap: 24px;
  }
  
  .footer-bottom {
    flex-direction: column;
    gap: 16px;
    text-align: center;
  }
  
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .form-actions {
    flex-direction: column;
  }
  
  .form-actions button {
    width: 100%;
  }
  
  .header-brand {
    flex-direction: column;
    gap: 8px;
    text-align: center;
  }
  
  .brand-subtitle {
    margin-left: 0;
  }
}

/* Enhanced animations and interactions */
.card {
  animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.stat-card {
  animation: fadeInUp 0.6s ease-out;
  animation-delay: calc(var(--animation-order, 0) * 0.1s);
}

/* Smooth scrolling */
html {
  scroll-behavior: smooth;
}

/* Focus styles for accessibility */
button:focus-visible,
input:focus-visible,
select:focus-visible,
textarea:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

/* Loading skeleton animation */
@keyframes shimmer {
  0% {
    background-position: -200px 0;
  }
  100% {
    background-position: calc(200px + 100%) 0;
  }
}

.skeleton {
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200px 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 4px;
}

.diploma-page{
  background: linear-gradient(180deg, #ffffff, #f8fafc);
  color: #111827;
  border: 8px double #d1d5db;
  border-radius: 12px;
  padding: 48px;
  position: relative;
  box-shadow: var(--shadow-xl);
}

.watermark{
  position: absolute;
  inset: 0;
  opacity: 0.06;
  background: url('assets/icon.svg') center/60% no-repeat;
  pointer-events: none;
}

@media print{
  nav, .no-print{
    display: none !important;
  }
  .diploma-page{
    box-shadow: none;
  }
  body{
    background: white;
  }
}

/* Professional enhancements */
.view {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Status indicators */
.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
}

.status-success {
  background: rgba(34, 197, 94, 0.1);
  color: var(--success);
}

.status-warning {
  background: rgba(245, 158, 11, 0.1);
  color: var(--warning);
}

.status-danger {
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger);
}

/* Enhanced form styling */
.form-group {
  margin-bottom: 20px;
}

.form-group label {
  margin-bottom: 8px;
}

/* Enhanced card variations */
.card-stats {
  text-align: center;
  padding: 20px;
}

.card-stats .num {
  font-size: 2rem;
  margin-bottom: 4px;
}

.card-stats .muted {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

/* Loading states */
.loading {
  opacity: 0.6;
  pointer-events: none;
}

.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin: -10px 0 0 -10px;
  border: 2px solid var(--border);
  border-top: 2px solid var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Dashboard enhancements */
.card-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}

.card-header h2 {
  margin: 0;
  display: flex;
  align-items: center;
  gap: 12px;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
}

.stat-card {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  transition: all 0.2s ease;
}

.stat-card:hover {
  box-shadow: var(--shadow-lg);
  transform: translateY(-2px);
}

.stat-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 48px;
  height: 48px;
  background: rgba(59, 130, 246, 0.1);
  border-radius: 12px;
  color: var(--accent);
  flex-shrink: 0;
}

.stat-content {
  flex: 1;
  min-width: 0;
}

.stat-label {
  font-size: 14px;
  color: var(--muted);
  font-weight: 500;
  margin-bottom: 4px;
}

.stat-value {
  font-size: 1.75rem;
  font-weight: 700;
  color: var(--ink);
  line-height: 1.2;
  margin-bottom: 8px;
}

.stat-bar {
  height: 6px;
  background: rgba(0, 0, 0, 0.05);
  border-radius: 3px;
  overflow: hidden;
}

.stat-bar > span {
  display: block;
  height: 100%;
  background: linear-gradient(90deg, var(--success), var(--accent2));
  border-radius: 3px;
  transition: width 0.3s ease;
}

.filters-section {
  margin-bottom: 32px;
  padding: 20px;
  background: rgba(0, 0, 0, 0.02);
  border-radius: 12px;
  border: 1px solid var(--border);
}

.recent-activity {
  margin-bottom: 24px;
}

.recent-activity h3 {
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.admin-section {
  padding-top: 20px;
  border-top: 1px solid var(--border);
}

.admin-button {
  background: linear-gradient(135deg, var(--danger), #dc2626) !important;
  border: none !important;
  color: white !important;
  padding: 12px 20px !important;
  border-radius: 8px !important;
  font-weight: 600 !important;
  cursor: pointer !important;
  transition: all 0.2s ease !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 8px !important;
}

.admin-button:hover {
  background: linear-gradient(135deg, #dc2626, #b91c1c) !important;
  transform: translateY(-1px) !important;
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3) !important;
}

/* Enhanced form styling */
.quick-add-form {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-group label {
  font-weight: 600;
  font-size: 14px;
  color: var(--ink);
  margin-bottom: 4px;
}

.form-actions {
  display: flex;
  gap: 12px;
  align-items: center;
  padding-top: 16px;
  border-top: 1px solid var(--border);
}

.form-actions button {
  min-width: 120px;
}

/* Enhanced input styling */
input::placeholder, select::placeholder {
  color: var(--muted);
  opacity: 0.7;
}

select {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 12px center;
  background-repeat: no-repeat;
  background-size: 16px;
  padding-right: 40px;
  appearance: none;
}
</style>
</head>
<body>
<header class="topbar">
  <div class="wrap">
    <div class="header-brand">
      <img src="./assets/icon.svg" alt="Peaceful Academy" class="brand-icon">
      <h1>Peaceful Academy</h1>
      <span class="brand-subtitle">Kansas City, Missouri</span>
    </div>
    <button class="hamburger" id="hamburger" aria-label="Toggle menu">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <nav id="nav">
      <a href="#dashboard" class="active">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        Dashboard
      </a>
      <a href="#students">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        Students
      </a>
      <a href="#courses">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
          <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
        </svg>
        Courses
      </a>
      <a href="#log">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12,6 12,12 16,14"></polyline>
        </svg>
        Log Hours
      </a>
      <a href="#portfolio">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <circle cx="8.5" cy="8.5" r="1.5"></circle>
          <polyline points="21,15 16,10 5,21"></polyline>
        </svg>
        Portfolio
      </a>
      <a href="#reports">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="20" x2="18" y2="10"></line>
          <line x1="12" y1="20" x2="12" y2="4"></line>
          <line x1="6" y1="20" x2="6" y2="14"></line>
        </svg>
        Reports
      </a>
      <a href="#transcript">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14,2 14,8 20,8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10,9 9,9 8,9"></polyline>
        </svg>
        Transcript
      </a>
      <a href="#diploma">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
          <path d="M2 17l10 5 10-5"></path>
          <path d="M2 12l10 5 10-5"></path>
        </svg>
        Diploma
      </a>
      <a href="#settings">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
        Settings
      </a>
      <a href="#help">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
        Help
      </a>
      <a href="./admin/index.html" target="_blank" class="admin-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
          <path d="M2 17l10 5 10-5"></path>
          <path d="M2 12l10 5 10-5"></path>
        </svg>
        Admin
      </a>
    </nav>
  </div>
</header>

<!-- Netlify hidden forms to enable Netlify Forms UI -->
<form name="log-entry" data-netlify="true" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" /><input type="text" name="student" /><input type="text" name="course" /><input type="text" name="subject" /><input type="text" name="date" /><input type="text" name="hours" /><input type="text" name="location" /><input type="text" name="notes" />
</form>
<form name="student" data-netlify="true" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" /><input type="text" name="name" /><input type="text" name="dob" /><input type="text" name="grade" /><input type="text" name="startYear" /><input type="text" name="notes" />
</form>
<form name="course" data-netlify="true" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" /><input type="text" name="title" /><input type="text" name="subject" /><input type="text" name="description" />
</form>
<form name="portfolio-upload" data-netlify="true" enctype="multipart/form-data" netlify-honeypot="bot-field" hidden>
  <input type="text" name="bot-field" /><input type="text" name="student" /><input type="text" name="course" /><input type="text" name="date" /><input type="text" name="title" /><input type="text" name="tags" /><input type="text" name="description" /><input type="file" name="file" />
</form>

<main class="wrap">
  <section id="view-dashboard" class="view">
    <div class="grid two">
      <div class="card">
        <div class="card-header">
          <h2>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="20" x2="18" y2="10"></line>
              <line x1="12" y1="20" x2="12" y2="4"></line>
              <line x1="6" y1="20" x2="6" y2="14"></line>
            </svg>
            Progress Overview
          </h2>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12,6 12,12 16,14"></polyline>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">Total Hours (1000)</div>
              <div class="stat-value" id="kpiTotal">0</div>
              <div class="stat-bar"><span id="barTotal" style="width:0%"></span></div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">Core (600)</div>
              <div class="stat-value" id="kpiCore">0</div>
              <div class="stat-bar"><span id="barCore" style="width:0%"></span></div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9,22 9,12 15,12 15,22"></polyline>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">Core @ Home (400)</div>
              <div class="stat-value" id="kpiHome">0</div>
              <div class="stat-bar"><span id="barHome" style="width:0%"></span></div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">Non-Core</div>
              <div class="stat-value" id="kpiNonCore">0</div>
              <div class="stat-bar"><span id="barNonCore" style="width:0%"></span></div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12,6 12,12 16,14"></polyline>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">Avg Daily Hours</div>
              <div class="stat-value" id="kpiAvgDaily">0</div>
              <div class="stat-bar"><span id="barAvgDaily" style="width:0%"></span></div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">Days Attended</div>
              <div class="stat-value" id="kpiDaysAttended">0</div>
              <div class="stat-bar"><span id="barDaysAttended" style="width:0%"></span></div>
            </div>
          </div>
        </div>
        <div class="filters-section">
          <div class="row">
            <div style="flex:1"><label>Student</label><select id="dashStudent"></select></div>
            <div style="flex:1"><label>Academic Year</label><select id="dashYear"></select></div>
          </div>
        </div>
        <div class="recent-activity">
          <h3>Recent Activity</h3>
          <table id="recentTable"><thead><tr><th>Date</th><th>Course</th><th class="right">Hours</th><th>Loc</th><th>Notes</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="admin-section">
          <button class="admin-button" onclick="window.open('./admin/index.html', '_blank')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
            Open Admin Panel
          </button>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h2>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            Quick Add Hours
          </h2>
        </div>
        <div class="quick-add-form">
          <div class="form-grid">
            <div class="form-group">
              <label>Student</label>
              <select id="qaStudent"></select>
            </div>
            <div class="form-group">
              <label>Course</label>
              <select id="qaCourse"></select>
            </div>
            <div class="form-group">
              <label>Date</label>
              <input type="date" id="qaDate">
            </div>
            <div class="form-group">
              <label>Hours</label>
              <input type="number" step="0.25" min="0" id="qaHours" placeholder="0.0">
            </div>
            <div class="form-group">
              <label>Location</label>
              <select id="qaLocation">
                <option value="home">🏠 Home</option>
                <option value="offsite">📍 Offsite</option>
              </select>
            </div>
            <div class="form-group">
              <label>Notes</label>
              <input id="qaNotes" placeholder="Lesson, lab, trip, activity…">
            </div>
          </div>
          <div class="form-actions">
            <button class="primary" id="qaAdd">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Add Hours
            </button>
            <button class="ghost" id="qaToday">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              Today
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="view-students" class="view hide">
    <div class="card"><h2>Students</h2>
      <div class="grid two">
        <div class="card">
          <div class="grid two">
            <div><label>Name</label><input id="stName"></div>
            <div><label>DOB</label><input type="date" id="stDob"></div>
            <div><label>Grade</label><input id="stGrade"></div>
            <div><label>Start Year</label><select id="stStart"></select></div>
          </div>
          <label>Notes</label><textarea id="stNotes" rows="3"></textarea>
          <div class="row" style="margin-top:.6rem"><button class="primary" id="stSave">Add Student</button><button class="ghost" id="stClear">Clear</button></div>
        </div>
        <div><table id="stTable"><thead><tr><th>Name</th><th>DOB</th><th>Grade</th><th>Start</th><th></th></tr></thead><tbody></tbody></table></div>
      </div>
    </div>
  </section>

  <section id="view-courses" class="view hide">
    <div class="card"><h2>Courses & Subjects</h2>
      <div class="grid two">
        <div class="card">
          <div class="grid two">
            <div><label>Course Title</label><input id="coTitle"></div>
            <div><label>Subject</label>
              <select id="coSubject">
                <option>Language Arts</option><option>Reading</option><option>Mathematics</option><option>Science</option><option>Social Studies</option><option>Elective</option>
              </select>
            </div>
          </div>
          <label>Description</label><textarea id="coDesc" rows="3" placeholder="Objectives, materials… (plan book)"></textarea>
          <div class="row" style="margin-top:.6rem"><button class="primary" id="coSave">Add Course</button><button class="ghost" id="coClear">Clear</button></div>
        </div>
        <div><table id="coTable"><thead><tr><th>Course</th><th>Subject</th><th>Description</th><th></th></tr></thead><tbody></tbody></table></div>
      </div>
      <div class="muted">Core subjects (Missouri): Reading, Language Arts, Mathematics, Science, Social Studies.</div>
    </div>
  </section>

  <section id="view-log" class="view hide">
    <div class="card"><h2>Daily Log</h2>
      <div class="grid three">
        <div><label>Student</label><select id="lgStudent"></select></div>
        <div><label>Course</label><select id="lgCourse"></select></div>
        <div><label>Date</label><input type="date" id="lgDate"></div>
        <div><label>Hours</label><input type="number" step="0.25" min="0" id="lgHours"></div>
        <div><label>Location</label><select id="lgLocation"><option value="home">Home</option><option value="offsite">Offsite</option></select></div>
        <div><label>Notes</label><input id="lgNotes" placeholder="Activity details"></div>
      </div>
      <div class="row" style="margin-top:.6rem"><button class="primary" id="lgAdd">Add Entry</button><button class="ghost" id="lgToday2">Today</button></div>

      <div class="row" style="margin-top:1rem">
        <div style="flex:1"><label>Filter Year</label><select id="lgYearFilter"></select></div>
        <div style="flex:1"><label>Filter Student</label><select id="lgStudentFilter"></select></div>
        <div style="flex:1"><label>Filter Subject</label>
          <select id="lgSubjectFilter">
            <option value="">All</option><option>Language Arts</option><option>Reading</option><option>Mathematics</option><option>Science</option><option>Social Studies</option><option>Elective</option>
          </select>
        </div>
        <div class="row"><button id="exportCSV">Export CSV</button><button id="exportJSON">Backup (JSON)</button><label class="pill muted">Import JSON <input id="importJSON" type="file" accept="application/json" style="display:none"></label></div>
      </div>
      <table id="lgTable"><thead><tr><th>Date</th><th>Student</th><th>Course</th><th>Subject</th><th class="right">Hours</th><th>Loc</th><th>Notes</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="view-portfolio" class="view hide">
    <div class="card"><h2>Portfolio: Work Samples</h2>
      <div class="grid two">
        <div class="card">
          <div class="grid two">
            <div><label>Student</label><select id="pfStudent"></select></div>
            <div><label>Course</label><select id="pfCourse"></select></div>
            <div><label>Date</label><input type="date" id="pfDate"></div>
            <div><label>File</label><input type="file" id="pfFile" accept="image/*,application/pdf"></div>
            <div><label>Title</label><input id="pfTitle" placeholder="Essay, lab, test…"></div>
            <div><label>Tags</label><input id="pfTags" placeholder="draft, test, project"></div>
          </div>
          <label>Description</label><textarea id="pfDesc" rows="3"></textarea>
          <div class="row" style="margin-top:.6rem"><button class="primary" id="pfSave">Add to Portfolio</button><button class="ghost" id="pfClear">Clear</button></div>
          <div class="muted">Files stored locally; metadata also saved to Netlify Forms and Neon.</div>
        </div>
        <div>
          <div class="row">
            <div style="flex:1"><label>Filter Year</label><select id="pfYearFilter"></select></div>
            <div style="flex:1"><label>Filter Student</label><select id="pfStudentFilter"></select></div>
            <div style="flex:1"><label>Filter Subject</label><select id="pfSubjectFilter"><option value="">All</option><option>Language Arts</option><option>Reading</option><option>Mathematics</option><option>Science</option><option>Social Studies</option><option>Elective</option></select></div>
          </div>
          <div id="pfGallery" class="gallery" style="margin-top:12px"></div>
        </div>
      </div>
    </div>
  </section>

  <section id="view-reports" class="view hide">
    <div class="card"><h2>Annual Compliance Report</h2>
      <div class="grid three">
        <div><label>Student</label><select id="rpStudent"></select></div>
        <div><label>Academic Year</label><select id="rpYear"></select></div>
        <div><label>Group By</label><select id="rpGroupBy"><option value="subject">Subject</option><option value="course">Course</option><option value="month">Month</option></select></div>
      </div>
              <div id="rpSummary" class="grid four" style="margin-top:12px"></div>
      <table id="rpTable" style="margin-top:12px"><thead><tr><th>Group</th><th class="right">Hours</th><th class="right">Home (core)</th><th class="right">Non-Core</th></tr></thead><tbody></tbody></table>
      <div class="row" style="margin-top:12px"><button id="rpPrint">Print Report</button></div>
    </div>
  </section>

  <section id="view-transcript" class="view hide">
    <div class="card"><h2>High School Transcript (Printable)</h2>
      <div class="grid three">
        <div><label>Student</label><select id="trStudent"></select></div>
        <div><label>Include Years</label><select id="trYears" multiple size="4"></select></div>
        <div><label>Scale</label><select id="trScale"><option value="120">Carnegie (120 hrs = 1.0 credit)</option><option value="135">Block (135 hrs)</option></select></div>
      </div>
      <div class="grid two" style="margin-top:12px">
        <div><label>Administrator Name</label><input id="trAdmin" placeholder="Administrator / Parent"></div>
        <div><label>Issue Date</label><input type="date" id="trIssue"></div>
      </div>
      <div class="row" style="margin-top:12px"><button id="trBuild" class="primary">Build Transcript</button><button id="trPrint">Print Transcript</button></div>
      <div id="trOut" style="margin-top:16px"></div>
    </div>
  </section>

  <section id="view-diploma" class="view hide">
    <div class="card"><h2>Diploma Generator (Printable)</h2>
      <div class="grid two">
        <div><label>Student</label><select id="dpStudent"></select></div>
        <div><label>Graduation Date</label><input type="date" id="dpDate"></div>
        <div><label>City, State</label><input id="dpPlace" value="Kansas City, Missouri"></div>
        <div><label>Administrator Title</label><input id="dpTitleA" value="Administrator"></div>
        <div><label>Second Title</label><input id="dpTitleB" value="Parent/Guardian"></div>
      </div>
      <div class="row" style="margin-top:12px"><button id="dpPreview" class="primary">Preview</button><button id="dpPrint">Print Diploma</button></div>
      <div id="dpOut" style="margin-top:16px"></div>
    </div>
  </section>

  <section id="view-settings" class="view hide">
    <div class="card"><h2>Settings & Backups</h2>
      <div class="grid two">
        <div class="card">
          <div class="grid two">
            <div><label>School Name</label><input id="scName" value="Peaceful Academy of Kansas City, Missouri"></div>
            <div><label>Phone</label><input id="scPhone"></div>
            <div><label>Address</label><input id="scAddress" placeholder="Street, Kansas City, MO"></div>
            <div><label>Year Starts</label><select id="scYearStart"><option value="07-01" selected>July 1</option><option value="08-01">August 1</option><option value="09-01">September 1</option></select></div>
          </div>
          <div class="row" style="margin-top:.6rem"><button class="primary" id="scSave">Save</button><button class="ghost" id="scReset">Reset</button></div>
        </div>
        <div class="card">
          <h3 style="margin-top:0">Data</h3>
          <div class="row">
            <button id="scExportAll">Export ALL (JSON)</button>
            <label class="pill muted">Import ALL <input type="file" id="scImportAll" accept="application/json" style="display:none"></label>
            <button class="danger" id="scWipe">Erase Everything</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="view-help" class="view hide"><div class="card">
    <h2>Help & Missouri Notes</h2>
    <ul>
      <li>Track at least <strong>1,000</strong> hours per student, with <strong>600 core</strong> in Reading/Language Arts/Math/Social Studies/Science and <strong>400 core @ home</strong>.</li>
      <li>Maintain a plan book/diary (Daily Log), a portfolio of work (Portfolio), and evaluations/assessments (attach notes/files).</li>
      <li>School year defaults to <strong>July 1 – June 30</strong>. Adjust in Settings if needed.</li>
      <li>This app works offline (PWA), mirrors to Netlify Forms, and writes to Neon Postgres via Netlify Functions.</li>
    </ul>
  </div>  </section>
</main>

<footer class="footer">
  <div class="wrap">
    <div class="footer-content">
      <div class="footer-brand">
        <img src="./assets/icon.svg" alt="Peaceful Academy" class="footer-icon">
        <div>
          <h3>Peaceful Academy</h3>
          <p>Professional homeschool management for Missouri families</p>
        </div>
      </div>
      <div class="footer-links">
        <div class="footer-section">
          <h4>Features</h4>
          <ul>
            <li><a href="#dashboard">Dashboard</a></li>
            <li><a href="#students">Student Management</a></li>
            <li><a href="#courses">Course Tracking</a></li>
            <li><a href="#reports">Compliance Reports</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>Resources</h4>
          <ul>
            <li><a href="#help">Help & Support</a></li>
            <li><a href="#settings">Settings</a></li>
            <li><a href="./admin/index.html" target="_blank">Admin Panel</a></li>
            <li><a href="#portfolio">Portfolio</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>Legal</h4>
          <ul>
            <li><a href="#transcript">Transcripts</a></li>
            <li><a href="#diploma">Diplomas</a></li>
            <li><a href="#reports">Compliance</a></li>
            <li><a href="#settings">Data Export</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2024 Peaceful Academy. Missouri-compliant homeschool management system.</p>
      <div class="footer-badges">
        <span class="badge">PWA Ready</span>
        <span class="badge">Offline Support</span>
        <span class="badge">Secure</span>
      </div>
    </div>
  </div>
</footer>

<script>
if ('serviceWorker' in navigator) { window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js')); }

const $ = s=>document.querySelector(s), $$ = s=>Array.from(document.querySelectorAll(s));
const fmt = new Intl.NumberFormat(undefined,{maximumFractionDigits:2});

// Fix timezone handling for dates
const todayISO = ()=> {
  const now = new Date();
  // Use local timezone to avoid date shifting issues
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

// Enhanced date validation
const isValidDate = (dateString) => {
  if (!dateString) return false;
  const date = new Date(dateString);
  return !isNaN(date.getTime()) && date <= new Date();
};

const CORE = new Set(['Reading','Language Arts','Mathematics','Science','Social Studies']);

// Cache for object URLs to prevent memory leaks
const objectUrlCache = new Map();

// Input validation helpers
function validateHours(hours) {
  const num = Number(hours);
  return !isNaN(num) && num >= 0.25 && num <= 24;
}

function validateDate(date) {
  return isValidDate(date);
}

function validateRequired(value) {
  return value && value.trim().length > 0;
}

// Enhanced validation for student data
function validateStudentData(data) {
  const errors = [];
  if (!validateRequired(data.name)) errors.push('Student name is required');
  if (data.dob && !validateDate(data.dob)) errors.push('Invalid date of birth');
  if (data.dob) {
    const dob = new Date(data.dob);
    const today = new Date();
    const age = today.getFullYear() - dob.getFullYear();
    if (age < 3 || age > 25) errors.push('Student age seems unrealistic');
  }
  return errors;
}

/* Settings & year helpers */
function getSettings(){ return Object.assign({name:'Peaceful Academy of Kansas City, Missouri',phone:'',address:'',yearStart:'07-01'}, JSON.parse(localStorage.getItem('pa_settings')||'{}'));}
function setSettings(v){ localStorage.setItem('pa_settings', JSON.stringify(v)); renderSettings(); }
function yearForDate(d){ const [Y,M,D]=d.split('-').map(Number); const s=getSettings().yearStart; const anchor=new Date(Y, Number(s.slice(0,2))-1, Number(s.slice(3,5))); const dt=new Date(d+'T12:00:00'); return dt>=anchor?Y:Y-1; }
function yearLabel(y){ return y+'–'+(y+1); }
function currentAcademicStart(){ return yearForDate(todayISO()); }

/* IndexedDB */
let db; 
(function openDB(){ 
  const req=indexedDB.open('peacefulAcademyDB',2); 
  req.onupgradeneeded=e=>{
    const d=e.target.result; 
    // Create stores with better error handling
    if (!d.objectStoreNames.contains('students')) {
      d.createObjectStore('students',{keyPath:'id',autoIncrement:true}); 
    }
    if (!d.objectStoreNames.contains('courses')) {
      d.createObjectStore('courses',{keyPath:'id',autoIncrement:true}); 
    }
    if (!d.objectStoreNames.contains('logs')) {
      d.createObjectStore('logs',{keyPath:'id',autoIncrement:true}); 
    }
    if (!d.objectStoreNames.contains('portfolio')) {
      d.createObjectStore('portfolio',{keyPath:'id',autoIncrement:true}); 
    }
    if (!d.objectStoreNames.contains('files')) {
      d.createObjectStore('files',{keyPath:'id',autoIncrement:true}); 
    }
  }; 
  req.onsuccess=()=>{db=req.result; init();}; 
  req.onerror=(e)=>{console.error('IndexedDB error:', e); alert('Database error. Please refresh the page.');}; 
})();
function tx(names,mode='readonly'){ return db.transaction(names,mode); }
const DB={ 
  add:(s,o)=>new Promise((res,rej)=>{
    try {
      if(!db) {
        rej(new Error('Database not initialized'));
        return;
      }
      const r=tx([s],'readwrite').objectStore(s).add(o); 
      r.onsuccess=()=>res(r.result); 
      r.onerror=(e)=>{console.error('DB add error:', e); rej(r.error);}
    } catch(e) {
      console.error('DB add exception:', e);
      rej(e);
    }
  }), 
  put:(s,o)=>new Promise((res,rej)=>{
    try {
      if(!db) {
        rej(new Error('Database not initialized'));
        return;
      }
      const r=tx([s],'readwrite').objectStore(s).put(o); 
      r.onsuccess=()=>res(r.result); 
      r.onerror=(e)=>{console.error('DB put error:', e); rej(r.error);}
    } catch(e) {
      console.error('DB put exception:', e);
      rej(e);
    }
  }), 
  get:(s,k)=>new Promise((res,rej)=>{
    try {
      if(!db) {
        rej(new Error('Database not initialized'));
        return;
      }
      const r=tx([s]).objectStore(s).get(k); 
      r.onsuccess=()=>res(r.result); 
      r.onerror=(e)=>{console.error('DB get error:', e); rej(r.error);}
    } catch(e) {
      console.error('DB get exception:', e);
      rej(e);
    }
  }), 
  all:(s)=>new Promise((res,rej)=>{
    try {
      if(!db) {
        rej(new Error('Database not initialized'));
        return;
      }
      const r=tx([s]).objectStore(s).getAll(); 
      r.onsuccess=()=>res(r.result || []); 
      r.onerror=(e)=>{console.error('DB all error:', e); rej(r.error);}
    } catch(e) {
      console.error('DB all exception:', e);
      rej(e);
    }
  }), 
  del:(s,k)=>new Promise((res,rej)=>{
    try {
      if(!db) {
        rej(new Error('Database not initialized'));
        return;
      }
      const r=tx([s],'readwrite').objectStore(s).delete(k); 
      r.onsuccess=()=>res(); 
      r.onerror=(e)=>{console.error('DB delete error:', e); rej(r.error);}
    } catch(e) {
      console.error('DB delete exception:', e);
      rej(e);
    }
  }),
  clearAll:()=>new Promise((res,rej)=>{
    try {
      if(!db) {
        rej(new Error('Database not initialized'));
        return;
      }
      const transaction = db.transaction(['students','courses','logs','portfolio','files'], 'readwrite');
      Promise.all(['students','courses','logs','portfolio','files'].map(storeName => 
        new Promise((res, rej) => {
          const request = transaction.objectStore(storeName).clear();
          request.onsuccess = () => res();
          request.onerror = () => rej(request.error);
        })
      )).then(res).catch(rej);
    } catch(e) {
      console.error('DB clearAll exception:', e);
      rej(e);
    }
  })
};

// Clean up object URLs to prevent memory leaks
function cleanupObjectUrls() {
  for (const [key, url] of objectUrlCache.entries()) {
    URL.revokeObjectURL(url);
  }
  objectUrlCache.clear();
}

// Get or create object URL with caching
function getObjectUrl(fileId, blob) {
  if (objectUrlCache.has(fileId)) {
    return objectUrlCache.get(fileId);
  }
  const url = URL.createObjectURL(blob);
  objectUrlCache.set(fileId, url);
  return url;
}

/* Netlify forms */
function encode(data){ return Object.keys(data).map(k=> encodeURIComponent(k)+'='+encodeURIComponent(data[k])).join('&'); }
async function netlifySubmit(formName, data){ 
  try{ 
    await fetch('/', { 
      method:'POST', 
      headers:{'Content-Type':'application/x-www-form-urlencoded'}, 
      body: encode(Object.assign({'form-name': formName, 'bot-field':''}, data)) 
    }); 
  } catch(e){ 
    console.warn('Netlify submit failed', e);
  } 
}
async function netlifySubmitFormData(formName, fd){ 
  try{ 
    fd.append('form-name', formName); 
    fd.append('bot-field',''); 
    await fetch('/', { 
      method:'POST', 
      body:fd 
    }); 
  } catch(e){ 
    console.warn('Netlify file submit failed', e);
  } 
}

// Enhanced notification system
function showNotification(message, type = 'info') {

// Data validation functions
function validateDate(dateString) {
  if (!dateString) return false;
  const date = new Date(dateString);
  return !isNaN(date.getTime());
}

async function validateImportData(data) {
  const errors = [];
  
  if (!data || typeof data !== 'object') {
    errors.push('Invalid data format');
    return errors;
  }
  
  // Validate students
  if (data.students && !Array.isArray(data.students)) {
    errors.push('Students must be an array');
  } else if (data.students) {
    data.students.forEach((student, index) => {
      if (!student || typeof student !== 'object') {
        errors.push(`Student ${index + 1} is invalid`);
      } else if (!student.name || typeof student.name !== 'string') {
        errors.push(`Student ${index + 1} must have a valid name`);
      }
    });
  }
  
  // Validate courses
  if (data.courses && !Array.isArray(data.courses)) {
    errors.push('Courses must be an array');
  } else if (data.courses) {
    data.courses.forEach((course, index) => {
      if (!course || typeof course !== 'object') {
        errors.push(`Course ${index + 1} is invalid`);
      } else if (!course.title || typeof course.title !== 'string') {
        errors.push(`Course ${index + 1} must have a valid title`);
      }
    });
  }
  
  // Validate logs with reference integrity
  if (data.logs && !Array.isArray(data.logs)) {
    errors.push('Logs must be an array');
  } else if (data.logs) {
    const existingStudents = await listStudents();
    const existingCourses = await listCourses();
    const studentIds = new Set(existingStudents.map(s => s.id));
    const courseIds = new Set(existingCourses.map(c => c.id));
    
    data.logs.forEach((log, index) => {
      if (!log || typeof log !== 'object') {
        errors.push(`Log ${index + 1} is invalid`);
      } else if (!log.studentId || !log.courseId || !log.date) {
        errors.push(`Log ${index + 1} must have studentId, courseId, and date`);
      } else if (!validateDate(log.date)) {
        errors.push(`Log ${index + 1}: Invalid date format`);
      } else if (!studentIds.has(Number(log.studentId))) {
        errors.push(`Log ${index + 1}: Student with ID ${log.studentId} not found`);
      } else if (!courseIds.has(Number(log.courseId))) {
        errors.push(`Log ${index + 1}: Course with ID ${log.courseId} not found`);
      }
    });
  }
  
  // Validate portfolio with reference integrity
  if (data.portfolio && !Array.isArray(data.portfolio)) {
    errors.push('Portfolio must be an array');
  } else if (data.portfolio) {
    const existingStudents = await listStudents();
    const existingCourses = await listCourses();
    const studentIds = new Set(existingStudents.map(s => s.id));
    const courseIds = new Set(existingCourses.map(c => c.id));
    
    data.portfolio.forEach((item, index) => {
      if (!item || typeof item !== 'object') {
        errors.push(`Portfolio item ${index + 1} is invalid`);
      } else if (!item.studentId || !item.courseId || !item.date || !item.title) {
        errors.push(`Portfolio item ${index + 1} must have studentId, courseId, date, and title`);
      } else if (!validateDate(item.date)) {
        errors.push(`Portfolio item ${index + 1}: Invalid date format`);
      } else if (!studentIds.has(Number(item.studentId))) {
        errors.push(`Portfolio item ${index + 1}: Student with ID ${item.studentId} not found`);
      } else if (!courseIds.has(Number(item.courseId))) {
        errors.push(`Portfolio item ${index + 1}: Course with ID ${item.courseId} not found`);
      }
    });
  }
  
  return errors;
}
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 1000;
    animation: slideIn 0.3s ease-out;
    ${type === 'success' ? 'background: var(--ok);' : ''}
    ${type === 'error' ? 'background: var(--danger);' : ''}
    ${type === 'warning' ? 'background: #f59e0b;' : ''}
    ${type === 'info' ? 'background: var(--accent2);' : ''}
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Add notification animations
const notificationStyle = document.createElement('style');
notificationStyle.textContent = `
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(notificationStyle);

/* Neon helper */
async function saveToNeon(kind, data){ try{ await fetch('/.netlify/functions/db', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ action: kind + '.insert', data }) }); } catch(e){ console.warn('Neon save failed', e); }}

/* Lists & renders */
async function listStudents(){ return await DB.all('students'); }
async function listCourses(){ return await DB.all('courses'); }
async function listLogs(){ return await DB.all('logs'); }
async function listPortfolio(){ return await DB.all('portfolio'); }

function show(view){ $$('.view').forEach(v=>v.classList.add('hide')); $('#view-'+view).classList.remove('hide'); $$('#nav a').forEach(a=>a.classList.remove('active')); $(`#nav a[href="#${view}"]`)?.classList.add('active'); }
window.addEventListener('hashchange', ()=>{ const v=(location.hash||'#dashboard').slice(1); show(v); if(v==='dashboard') renderDashboard(); if(v==='students') renderStudents(); if(v==='courses') renderCourses(); if(v==='log') renderLogsTable(); if(v==='portfolio') renderPortfolio(); if(v==='reports') renderReports(); if(v==='settings') renderSettings(); });

async function renderStudents(){
  const students = await listStudents();
  const tb = $('#stTable tbody'); if(tb){ tb.innerHTML=''; students.forEach(s=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${s.name}</td><td>${s.dob||''}</td><td>${s.grade||''}</td><td>${s.startYear||''}</td><td class="right"><button class="stDel" data-id="${s.id}">Delete</button></td>`; tb.appendChild(tr); });}
  const opts = students.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  ['dashStudent','qaStudent','lgStudent','lgStudentFilter','pfStudent','pfStudentFilter','rpStudent','trStudent','dpStudent'].forEach(id=>{ const el=$('#'+id); if(!el) return; const prev=el.value; el.innerHTML=(id.endsWith('Filter')?'<option value="">All</option>':'')+opts; if(prev) el.value=prev; });
}
async function renderCourses(){
  const courses=await listCourses(); const tb=$('#coTable tbody'); if(tb){ tb.innerHTML=''; courses.forEach(c=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.title}</td><td>${c.subject}</td><td class="muted">${c.description||''}</td><td class="right"><button class="coDel" data-id="${c.id}">Delete</button></td>`; tb.appendChild(tr);});}
  const opts=courses.map(c=>`<option value="${c.id}">${c.title}</option>`).join(''); ['qaCourse','lgCourse','pfCourse'].forEach(id=>{ const el=$('#'+id); if(el){ const prev=el.value; el.innerHTML=opts; if(prev) el.value=prev; }});
}
function academicYears(logs){ const ys=new Set(logs.map(l=>yearForDate(l.date))); if(!ys.size) ys.add(currentAcademicStart()); return Array.from(ys).sort((a,b)=>b-a); }
async function renderYearSelectors(){
  const logs=await listLogs(); const years=academicYears(logs);
  const set=(id,all=false)=>{ const el=$('#'+id); if(!el) return; const prev=el.value; el.innerHTML=(all?'<option value="">All</option>':'')+years.map(y=>`<option value="${y}">${yearLabel(y)}</option>`).join(''); el.value=prev||years[0]; };
  set('dashYear'); set('lgYearFilter', true); set('pfYearFilter', true); set('rpYear'); const stStart=$('#stStart'); if(stStart){ stStart.innerHTML=years.slice().reverse().map(y=>`<option value="${y}">${yearLabel(y)}</option>`).join(''); } const trYears=$('#trYears'); if(trYears){ trYears.innerHTML=years.map(y=>`<option value="${y}" selected>${yearLabel(y)}</option>`).join(''); }
}
async function renderDashboard(){
  const [logs,courses,students]=await Promise.all([listLogs(), listCourses(), listStudents()]); await renderYearSelectors(); await renderStudents(); await renderCourses();
  const sId=Number($('#dashStudent').value || (students[0]?.id||0)); $('#dashStudent').value=sId||''; const yStart=Number($('#dashYear').value)||currentAcademicStart();
  const filtered=logs.filter(l=> l.studentId===sId && yearForDate(l.date)===yStart); const cMap=new Map(courses.map(c=>[c.id,c]));
  let total=0, core=0, home=0, nonCore=0; filtered.forEach(l=>{ const subj=cMap.get(l.courseId)?.subject; const hrs=Number(l.hours)||0; total+=hrs; if(CORE.has(subj)){ core+=hrs; if(l.location==='home') home+=hrs; } else { nonCore+=hrs; }});
  
  // Calculate average daily hours and days attended
  const uniqueDays = new Set(filtered.map(l => l.date));
  const daysAttended = uniqueDays.size;
  const avgDailyHours = daysAttended > 0 ? total / daysAttended : 0;
  
  $('#kpiTotal').textContent=fmt.format(total); $('#kpiCore').textContent=fmt.format(core); $('#kpiHome').textContent=fmt.format(home); $('#kpiNonCore').textContent=fmt.format(nonCore);
  $('#kpiAvgDaily').textContent=fmt.format(avgDailyHours); $('#kpiDaysAttended').textContent=daysAttended;
  
  $('#barTotal').style.width=Math.min(100,(total/1000)*100)+'%'; $('#barCore').style.width=Math.min(100,(core/600)*100)+'%'; $('#barHome').style.width=Math.min(100,(home/400)*100)+'%'; $('#barNonCore').style.width=Math.min(100,(nonCore/400)*100)+'%';
  $('#barAvgDaily').style.width=Math.min(100,(avgDailyHours/8)*100)+'%'; $('#barDaysAttended').style.width=Math.min(100,(daysAttended/180)*100)+'%';
  
  const recent = filtered.slice().sort((a,b)=>b.date.localeCompare(a.date)).slice(0,10); const tb=$('#recentTable tbody'); tb.innerHTML=''; recent.forEach(r=>{ const c=cMap.get(r.courseId); const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.date}</td><td>${c?.title||''}</td><td class="right">${fmt.format(r.hours)}</td><td>${r.location==='home'?'Home':'Offsite'}</td><td class="muted">${r.notes||''}</td>`; tb.appendChild(tr); });
  $('#qaStudent').value=sId||''; $('#qaCourse').value=courses[0]?.id||''; $('#qaDate').value=todayISO();
}
async function renderLogsTable(){
  const [logs,courses,students]=await Promise.all([listLogs(), listCourses(), listStudents()]);
  const subjF=$('#lgSubjectFilter').value; const y=$('#lgYearFilter').value; const s=$('#lgStudentFilter').value; const cMap=new Map(courses.map(c=>[c.id,c])); const sMap=new Map(students.map(x=>[x.id,x]));
  const filtered=logs.filter(l=> (!y||yearForDate(l.date)==Number(y)) && (!s||l.studentId==Number(s)) && (!subjF||cMap.get(l.courseId)?.subject===subjF)).sort((a,b)=>b.date.localeCompare(a.date));
  const tb=$('#lgTable tbody'); tb.innerHTML=''; filtered.forEach(l=>{ const c=cMap.get(l.courseId), st=sMap.get(l.studentId); const tr=document.createElement('tr'); tr.innerHTML=`<td>${l.date}</td><td>${st?.name||''}</td><td>${c?.title||''}</td><td>${c?.subject||''}</td><td class="right">${fmt.format(l.hours)}</td><td>${l.location==='home'?'Home':'Offsite'}</td><td class="muted">${l.notes||''}</td><td class="right"><button class="lgDel" data-id="${l.id}">Delete</button></td>`; tb.appendChild(tr); });
}
async function renderPortfolio(){
  // Clean up previous object URLs to prevent memory leaks
  cleanupObjectUrls();
  
  const [items,courses,students]=await Promise.all([listPortfolio(), listCourses(), listStudents()]); const y=$('#pfYearFilter').value, s=$('#pfStudentFilter').value, subj=$('#pfSubjectFilter').value; const cMap=new Map(courses.map(c=>[c.id,c])); const sMap=new Map(students.map(x=>[x.id,x]));
  const filtered=items.filter(p=> (!y||yearForDate(p.date)==Number(y)) && (!s||p.studentId==Number(s)) && (!subj||cMap.get(p.courseId)?.subject===subj)).sort((a,b)=>b.date.localeCompare(a.date));
  const gal=$('#pfGallery'); gal.innerHTML=''; for(const p of filtered){ const c=cMap.get(p.courseId), st=sMap.get(p.studentId); const file=p.fileId?await DB.get('files', p.fileId):null; const url=file?getObjectUrl(p.fileId, file.blob):''; const isImg = file && file.type.startsWith('image/'); const div=document.createElement('div'); div.className='tile'; div.innerHTML=`<div style="height:140px;display:flex;align-items:center;justify-content:center;background:#0a1123">${file?(isImg?`<img src="${url}" style="width:100%;height:140px;object-fit:cover">`:`<div class="muted">File: ${file.name||file.type}</div>`):'<div class="muted">No file</div>'}</div><div style="padding:.6rem"><div><strong>${p.title||'(untitled)'}</strong></div><div class="muted">${p.date} • ${st?.name||''} • ${c?.title||''}</div><div style="font-size:.92rem">${p.desc||''}</div><div class="row" style="margin-top:.5rem;justify-content:space-between"><div class="muted">${(p.tags||[]).join(', ')}</div><div class="row">${file?`<a download="${(p.title||'portfolio')}" href="${url}">Download</a>`:''}<button class="pfDel" data-id="${p.id}">Delete</button></div></div></div>`; gal.appendChild(div);} }
async function renderReports(){
  const [logs,courses]=await Promise.all([listLogs(), listCourses()]); const sId=Number($('#rpStudent').value); const yStart=Number($('#rpYear').value); const groupBy=$('#rpGroupBy').value; const cMap=new Map(courses.map(c=>[c.id,c])); const filtered=logs.filter(l=> l.studentId===sId && yearForDate(l.date)===yStart);
  const totals={total:0,core:0,home:0,nonCore:0}, groups=new Map(); function addG(k,hrs,home,nonCore){ const o=groups.get(k)||{hours:0,home:0,nonCore:0}; o.hours+=hrs; if(home) o.home+=hrs; if(nonCore) o.nonCore+=hrs; groups.set(k,o); }
  filtered.forEach(l=>{ const hrs=Number(l.hours)||0; const subj=cMap.get(l.courseId)?.subject; totals.total+=hrs; const isCore=CORE.has(subj); const home = isCore && l.location==='home'; const nonCore = !isCore; if(isCore) totals.core+=hrs; if(home) totals.home+=hrs; if(nonCore) totals.nonCore+=hrs; let key=''; if(groupBy==='subject') key=subj||'(none)'; else if(groupBy==='course') key=cMap.get(l.courseId)?.title||'(none)'; else key=l.date.slice(0,7); addG(key,hrs,home,nonCore); });
  const mk=(label,val,goal)=>`<div class="card"><div class="muted">${label} (goal ${goal})</div><div class="num">${fmt.format(val)}</div><div class="bar"><span style="width:${Math.min(100,(val/goal)*100)}%"></span></div></div>`;
  $('#rpSummary').innerHTML = mk('Total Hours',totals.total,1000)+mk('Core Hours',totals.core,600)+mk('Core @ Home',totals.home,400)+mk('Non-Core Hours',totals.nonCore,400);
  const tb=$('#rpTable tbody'); tb.innerHTML=''; Array.from(groups.entries()).sort((a,b)=>b[1].hours-a[1].hours).forEach(([k,v])=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${k}</td><td class="right">${fmt.format(v.hours)}</td><td class="right">${fmt.format(v.home)}</td><td class="right">${fmt.format(v.nonCore)}</td>`; tb.appendChild(tr); });
}

/* Events */
function renderSettings(){ const s=getSettings(); $('#scName').value=s.name; $('#scPhone').value=s.phone; $('#scAddress').value=s.address; $('#scYearStart').value=s.yearStart; $('#yearNow').textContent=new Date().getFullYear(); }
$('#scSave')?.addEventListener('click', ()=>{
  const settings = {
    name: $('#scName').value.trim(),
    phone: $('#scPhone').value.trim(),
    address: $('#scAddress').value.trim(),
    yearStart: $('#scYearStart').value
  };
  
  if (!settings.name) {
    showNotification('School name is required', 'error');
    return;
  }
  
  setSettings(settings);
  showNotification('Settings saved successfully!', 'success');
  renderDashboard(); 
  renderLogsTable(); 
  renderPortfolio(); 
  renderReports(); 
});
$('#scReset')?.addEventListener('click', ()=>{ if(confirm('Reset to defaults?')) setSettings({name:'Peaceful Academy of Kansas City, Missouri',phone:'',address:'',yearStart:'07-01'}); });
$('#scExportAll')?.addEventListener('click', async()=>{ const blob=new Blob([JSON.stringify({settings:getSettings(),students:await listStudents(),courses:await listCourses(),logs:await listLogs(),portfolio:await listPortfolio()},null,2)],{type:'application/json'}); const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:'peaceful-academy-backup.json'}); a.click(); });
$('#scImportAll')?.addEventListener('change', async(e)=>{ 
  try {
    const f=e.target.files?.[0]; 
    if(!f) return; 
    if(!confirm('Import will REPLACE existing data. Continue?')) return; 
    
    const data=JSON.parse(await f.text()); 
    
    // Validate data structure
    const validationErrors = await validateImportData(data);
    if(validationErrors.length > 0) {
      showNotification('Invalid file format: ' + validationErrors.join(', '), 'error');
      return;
    }
    
    // Clear all stores
    await DB.clearAll();
    
    // Import settings if present
    if(data.settings) setSettings(data.settings); 
    
    // Import data with validation and progress tracking
    let totalImported = 0;
    const totalItems = (data.students?.length || 0) + (data.courses?.length || 0) + (data.logs?.length || 0) + (data.portfolio?.length || 0);
    
    if(Array.isArray(data.students)) {
      for(const s of data.students) {
        if(s && typeof s === 'object') {
          await DB.add('students', s);
          totalImported++;
        }
      }
    }
    
    if(Array.isArray(data.courses)) {
      for(const c of data.courses) {
        if(c && typeof c === 'object') {
          await DB.add('courses', c);
          totalImported++;
        }
      }
    }
    
    if(Array.isArray(data.logs)) {
      for(const l of data.logs) {
        if(l && typeof l === 'object') {
          await DB.add('logs', l);
          totalImported++;
        }
      }
    }
    
    if(Array.isArray(data.portfolio)) {
      for(const p of data.portfolio) {
        if(p && typeof p === 'object') {
          await DB.add('portfolio', p);
          totalImported++;
        }
      }
    }
    
    showNotification(`Data imported successfully! ${totalImported} items imported.`, 'success'); 
    renderDashboard(); 
    renderStudents(); 
    renderCourses(); 
    renderLogsTable(); 
    renderPortfolio(); 
    renderReports(); 
  } catch(error) {
    console.error('Import error:', error);
    showNotification('Error importing data: ' + error.message, 'error');
  }
});
$('#scWipe')?.addEventListener('click', async()=>{ 
  try {
    if(!confirm('Erase ALL data?')) return; 
    
    // Clear all stores
    await DB.clearAll();
    
    showNotification('All data cleared successfully.', 'success'); 
    renderDashboard(); 
    renderStudents(); 
    renderCourses(); 
    renderLogsTable(); 
    renderPortfolio(); 
    renderReports(); 
  } catch(error) {
    console.error('Clear error:', error);
    showNotification('Error clearing data: ' + error.message, 'error');
  }
});

/* Students */
document.body.addEventListener('click', async(e)=>{ if(e.target.classList.contains('stDel')){ await DB.del('students', Number(e.target.dataset.id)); renderStudents(); renderDashboard(); renderLogsTable(); renderPortfolio(); renderReports(); } });
$('#stSave')?.addEventListener('click', async()=>{ 
  const obj={ 
    name:$('#stName').value.trim(), 
    dob:$('#stDob').value||'', 
    grade:$('#stGrade').value.trim(), 
    startYear:Number($('#stStart').value)||currentAcademicStart(), 
    notes:$('#stNotes').value.trim() 
  }; 
  
  // Enhanced validation
  const errors = validateStudentData(obj);
  if(errors.length > 0) {
    alert('Please fix the following errors:\n' + errors.join('\n'));
    return;
  }
  
  try {
    await DB.add('students', obj);
    await netlifySubmit('student', {name:obj.name, dob:obj.dob, grade:obj.grade, startYear:String(obj.startYear), notes:obj.notes});
    await saveToNeon('student', {name:obj.name, dob:obj.dob, grade:obj.grade, startYear:obj.startYear, notes:obj.notes});
    $('#stName').value=''; $('#stDob').value=''; $('#stGrade').value=''; $('#stNotes').value=''; 
    renderStudents(); renderYearSelectors(); renderDashboard(); 
  } catch(e) {
    console.error('Error saving student:', e);
    showNotification('Error saving student. Please try again.', 'error');
  }
});
$('#stClear')?.addEventListener('click', ()=>{$$('#view-students input, #view-students textarea').forEach(el=>el.value='')});

/* Courses */
document.body.addEventListener('click', async(e)=>{ if(e.target.classList.contains('coDel')){ await DB.del('courses', Number(e.target.dataset.id)); renderCourses(); renderLogsTable(); renderDashboard(); renderPortfolio(); renderReports(); } });
$('#coSave')?.addEventListener('click', async()=>{ 
  const obj={ 
    title:$('#coTitle').value.trim(), 
    subject:$('#coSubject').value, 
    description:$('#coDesc').value.trim() 
  }; 
  
  // Enhanced validation
  const errors = [];
  if(!validateRequired(obj.title)) errors.push('Course title is required');
  if(!validateRequired(obj.subject)) errors.push('Subject is required');
  if(obj.title.length > 100) errors.push('Course title is too long (max 100 characters)');
  
  if(errors.length > 0) {
    alert('Please fix the following errors:\n' + errors.join('\n'));
    return;
  }
  
  try {
    await DB.add('courses', obj);
    await netlifySubmit('course', obj);
    await saveToNeon('course', obj);
    $('#coTitle').value=''; $('#coDesc').value=''; 
    renderCourses(); renderDashboard(); 
  } catch(e) {
    console.error('Error saving course:', e);
    showNotification('Error saving course. Please try again.', 'error');
  }
});
$('#coClear')?.addEventListener('click', ()=>{$$('#view-courses input, #view-courses textarea').forEach(el=>el.value='')});

/* Logs */
$('#qaToday')?.addEventListener('click', ()=> $('#qaDate').value=todayISO());
$('#lgToday2')?.addEventListener('click', ()=> $('#lgDate').value=todayISO());
$('#qaAdd')?.addEventListener('click', async()=>{
  const obj={ 
    studentId:Number($('#qaStudent').value), 
    courseId:Number($('#qaCourse').value), 
    date:$('#qaDate').value||todayISO(), 
    hours:Number($('#qaHours').value), 
    location:$('#qaLocation').value, 
    notes:$('#qaNotes').value.trim() 
  };
  
  // Enhanced validation
  const errors = [];
  if(!obj.studentId){ errors.push('Please select a student'); }
  if(!obj.courseId){ errors.push('Please select a course'); }
  if(!validateHours(obj.hours)){ errors.push('Please enter valid hours (0.25 to 24)'); }
  if(!validateDate(obj.date)){ errors.push('Please enter a valid date'); }
  if(obj.notes.length > 500) { errors.push('Notes are too long (max 500 characters)'); }
  
  if(errors.length > 0) {
    alert('Please fix the following errors:\n' + errors.join('\n'));
    return;
  }
  
  try {
    await DB.add('logs', obj);
    const [courses,students]=await Promise.all([listCourses(), listStudents()]); 
    const c=courses.find(x=>x.id===obj.courseId), s=students.find(x=>x.id===obj.studentId);
    await netlifySubmit('log-entry', { student:s?.name||String(obj.studentId), course:c?.title||String(obj.courseId), subject:c?.subject||'', date:obj.date, hours:String(obj.hours), location:obj.location, notes:obj.notes });
    await saveToNeon('log', { studentId: obj.studentId, studentName: s?.name||String(obj.studentId), courseId: obj.courseId, courseTitle: c?.title||String(obj.courseId), subject: c?.subject||'', date: obj.date, hours: obj.hours, location: obj.location, notes: obj.notes });
    $('#qaHours').value=''; $('#qaNotes').value=''; 
    renderDashboard(); renderLogsTable(); renderReports();
    showNotification('Log entry added successfully!', 'success');
  } catch(e) {
    console.error('Error adding log entry:', e);
    showNotification('Error adding log entry. Please try again.', 'error');
  }
});
$('#lgAdd')?.addEventListener('click', async()=>{
  const obj={ 
    studentId:Number($('#lgStudent').value), 
    courseId:Number($('#lgCourse').value), 
    date:$('#lgDate').value||todayISO(), 
    hours:Number($('#lgHours').value), 
    location:$('#lgLocation').value, 
    notes:$('#lgNotes').value.trim() 
  };
  
  // Enhanced validation
  const errors = [];
  if(!obj.studentId){ errors.push('Please select a student'); }
  if(!obj.courseId){ errors.push('Please select a course'); }
  if(!validateHours(obj.hours)){ errors.push('Please enter valid hours (0.25 to 24)'); }
  if(!validateDate(obj.date)){ errors.push('Please enter a valid date'); }
  if(obj.notes.length > 500) { errors.push('Notes are too long (max 500 characters)'); }
  
  if(errors.length > 0) {
    alert('Please fix the following errors:\n' + errors.join('\n'));
    return;
  }
  
  try {
    await DB.add('logs', obj);
    const [courses,students]=await Promise.all([listCourses(), listStudents()]); 
    const c=courses.find(x=>x.id===obj.courseId), s=students.find(x=>x.id===obj.studentId);
    await netlifySubmit('log-entry', { student:s?.name||String(obj.studentId), course:c?.title||String(obj.courseId), subject:c?.subject||'', date:obj.date, hours:String(obj.hours), location:obj.location, notes:obj.notes });
    await saveToNeon('log', { studentId: obj.studentId, studentName: s?.name||String(obj.studentId), courseId: obj.courseId, courseTitle: c?.title||String(obj.courseId), subject: c?.subject||'', date: obj.date, hours: obj.hours, location: obj.location, notes: obj.notes });
    $('#lgHours').value=''; $('#lgNotes').value=''; 
    renderLogsTable(); renderDashboard(); renderReports();
    showNotification('Log entry added successfully!', 'success');
  } catch(e) {
    console.error('Error adding log entry:', e);
    showNotification('Error adding log entry. Please try again.', 'error');
  }
});
document.body.addEventListener('click', async(e)=>{ if(e.target.classList.contains('lgDel')){ await DB.del('logs', Number(e.target.dataset.id)); renderLogsTable(); renderDashboard(); renderReports(); } });
$('#exportCSV')?.addEventListener('click', async()=>{ const [logs,courses,students]=await Promise.all([listLogs(), listCourses(), listStudents()]); const cMap=new Map(courses.map(c=>[c.id,c])); const sMap=new Map(students.map(s=>[s.id,s])); const y=$('#lgYearFilter').value; const rows=[['date','student','course','subject','hours','location','notes']]; for(const l of logs){ if(y && yearForDate(l.date)!=Number(y)) continue; const c=cMap.get(l.courseId), st=sMap.get(l.studentId); rows.push([l.date, st?.name||'', c?.title||'', c?.subject||'', String(l.hours), l.location, (l.notes||'').replace(/\n/g,' ')]);} const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n'); const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([csv],{type:'text/csv'})),download:'logs.csv'}); a.click(); });
$('#exportJSON')?.addEventListener('click', async()=>{ const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([JSON.stringify({logs:await listLogs()},null,2)],{type:'application/json'})),download:'logs.json'}); a.click(); });
$('#importJSON')?.addEventListener('change', async(e)=>{ 
  try {
    const f=e.target.files?.[0]; 
    if(!f) return; 
    
    const data=JSON.parse(await f.text()); 
    
    // Validate data structure
    if(!data || typeof data !== 'object') {
      showNotification('Invalid file format. Please select a valid JSON file.', 'error');
      return;
    }
    
    if(!Array.isArray(data.logs)) {
      showNotification('Invalid file format. File must contain a "logs" array.', 'error');
      return;
    }
    
    // Validate log references before importing
    const existingStudents = await listStudents();
    const existingCourses = await listCourses();
    const studentIds = new Set(existingStudents.map(s => s.id));
    const courseIds = new Set(existingCourses.map(c => c.id));
    
    const invalidLogs = [];
    data.logs.forEach((log, index) => {
      if (!log || typeof log !== 'object') {
        invalidLogs.push(`Log ${index + 1} is invalid`);
      } else if (!log.studentId || !log.courseId || !log.date) {
        invalidLogs.push(`Log ${index + 1} must have studentId, courseId, and date`);
      } else if (!validateDate(log.date)) {
        invalidLogs.push(`Log ${index + 1}: Invalid date format`);
      } else if (!studentIds.has(Number(log.studentId))) {
        invalidLogs.push(`Log ${index + 1}: Student with ID ${log.studentId} not found`);
      } else if (!courseIds.has(Number(log.courseId))) {
        invalidLogs.push(`Log ${index + 1}: Course with ID ${log.courseId} not found`);
      }
    });
    
    if (invalidLogs.length > 0) {
      showNotification('Import validation failed: ' + invalidLogs.join(', '), 'error');
      return;
    }
    
    // Import logs with validation
    let importedCount = 0;
    for(const l of data.logs) {
      if(l && typeof l === 'object' && l.studentId && l.courseId && l.date) {
        await DB.add('logs', l);
        importedCount++;
      }
    }
    
    showNotification(`Successfully imported ${importedCount} log entries.`, 'success'); 
    renderLogsTable(); 
    renderDashboard(); 
    renderReports(); 
  } catch(error) {
    console.error('Import error:', error);
    showNotification('Error importing logs: ' + error.message, 'error');
  }
});

/* Portfolio */
async function fileToBlob(file){ return file.slice(0,file.size,file.type); }
$('#pfSave')?.addEventListener('click', async()=>{
  const file=$('#pfFile').files[0]||null; let fileId=null;
  if(file){ const blob=await fileToBlob(file); fileId=await DB.add('files', {blob, type:file.type, name:file.name, size:file.size}); }
  const obj={ 
    studentId:Number($('#pfStudent').value), 
    courseId:Number($('#pfCourse').value), 
    date:$('#pfDate').value||todayISO(), 
    title:$('#pfTitle').value.trim(), 
    desc:$('#pfDesc').value.trim(), 
    tags:$('#pfTags').value.split(',').map(t=>t.trim()).filter(Boolean), 
    fileId 
  };
  
  // Enhanced validation
  if(!obj.studentId){ alert('Please select a student'); return; }
  if(!obj.courseId){ alert('Please select a course'); return; }
  if(!validateDate(obj.date)){ alert('Please enter a valid date'); return; }
  
  await DB.add('portfolio', obj);
  const [courses,students]=await Promise.all([listCourses(), listStudents()]); const c=courses.find(x=>x.id===obj.courseId), s=students.find(x=>x.id===obj.studentId);
  const fd=new FormData(); fd.append('student', s?.name||String(obj.studentId)); fd.append('course', c?.title||String(obj.courseId)); fd.append('date', obj.date); fd.append('title', obj.title); fd.append('tags', (obj.tags||[]).join(', ')); fd.append('description', obj.desc); if(file) fd.append('file', file, file.name); await netlifySubmitFormData('portfolio-upload', fd);
  await saveToNeon('portfolio', { studentId: obj.studentId, studentName: s?.name||String(obj.studentId), courseId: obj.courseId, courseTitle: c?.title||String(obj.courseId), subject: c?.subject||'', date: obj.date, title: obj.title, tags: obj.tags, description: obj.desc, fileName: (file? file.name : null), fileType: (file? file.type : null), fileSize: (file? file.size : null) });
  ['pfTitle','pfDesc','pfTags'].forEach(id=>$('#'+id).value=''); $('#pfFile').value=''; renderPortfolio();
});
$('#pfClear')?.addEventListener('click', ()=>{ ['pfTitle','pfDesc','pfTags','pfFile'].forEach(id=>$('#'+id).value=''); });
document.body.addEventListener('click', async(e)=>{ if(e.target.classList.contains('pfDel')){ const id=Number(e.target.dataset.id); const item=await DB.get('portfolio', id); if(item?.fileId) await DB.del('files', item.fileId); await DB.del('portfolio', id); renderPortfolio(); } });

/* Transcript */
function gradePoint(letter){ 
  const map={'A+':4,'A':4,'A-':3.7,'B+':3.3,'B':3,'B-':2.7,'C+':2.3,'C':2,'C-':1.7,'D+':1.3,'D':1,'F':0}; 
  return map[letter?.toUpperCase()] ?? null; 
}
function getTranscriptOverrides(){ return JSON.parse(localStorage.getItem('pa_transcript')||'{}'); }
function setTranscriptOverrides(v){ localStorage.setItem('pa_transcript', JSON.stringify(v)); }

// Enhanced transcript validation
function validateGrade(grade) {
  if (!grade) return true; // Empty grade is valid
  const validGrades = ['A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D', 'F'];
  return validGrades.includes(grade.toUpperCase());
}
async function buildTranscript(){
  const [logs,courses,students]=await Promise.all([listLogs(), listCourses(), listStudents()]); const sId=Number($('#trStudent').value); if(!sId){ alert('Choose a student'); return; } const years=Array.from($('#trYears').selectedOptions).map(o=>Number(o.value)); const scale=Number($('#trScale').value)||120; const cMap=new Map(courses.map(c=>[c.id,c])); const st=students.find(s=>s.id===sId); const filtered=logs.filter(l=> l.studentId===sId && years.includes(yearForDate(l.date)));
  const by=new Map(); filtered.forEach(l=>{ const y=yearForDate(l.date), key=l.courseId+'|'+y; const c=cMap.get(l.courseId); const o=by.get(key)||{hours:0, subject:c?.subject, title:c?.title, year:y}; o.hours+=Number(l.hours)||0; by.set(key,o); });
  const rows=Array.from(by.values()).sort((a,b)=> (a.year-b.year)||a.title.localeCompare(b.title)); const ov=getTranscriptOverrides(); ov[sId]=ov[sId]||{};
  let html=`<div class="card" style="background:white;color:#111827"><div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:1.5rem;font-weight:800">Peaceful Academy • Kansas City, MO</div><div class="muted">Official High School Transcript</div></div><div class="muted">Issued: ${$('#trIssue').value||todayISO()}</div></div><hr><div class="grid three"><div><strong>Student</strong><div>${st?.name||''}</div></div><div><strong>DOB</strong><div>${st?.dob||''}</div></div><div><strong>Address</strong><div>${getSettings().address||'On file'}</div></div></div><table style="width:100%;border-collapse:collapse;margin-top:10px"><thead><tr><th style="text-align:left">Year</th><th style="text-align:left">Course</th><th style="text-align:left">Subject</th><th class="right">Hours</th><th class="right">Credits</th><th class="right">Grade</th><th class="right">Pts</th></tr></thead><tbody>`;
  let totalCredits=0, totalPts=0, gradedCredits=0;
  for(const r of rows){ const key=r.year+'|'+r.title; const rec=ov[sId][key] || {credit:(r.hours/scale).toFixed(2), grade:''}; ov[sId][key]=rec; const gp=gradePoint(rec.grade); const pts=gp!=null? gp*Number(rec.credit) : ''; if(gp!=null){ totalPts+=gp*Number(rec.credit); gradedCredits+=Number(rec.credit);} totalCredits+=Number(rec.credit);
    html += `<tr><td>${yearLabel(r.year)}</td><td>${r.title}</td><td>${r.subject||''}</td><td class="right">${fmt.format(r.hours)}</td><td class="right" contenteditable="true" data-tr-key="${key}" data-tr-field="credit">${rec.credit}</td><td class="right" contenteditable="true" data-tr-key="${key}" data-tr-field="grade">${rec.grade||''}</td><td class="right">${pts===''?'':fmt.format(pts)}</td></tr>`; }
  const gpa=gradedCredits? (totalPts/gradedCredits).toFixed(2) : '—';
  html += `</tbody></table><div class="row" style="justify-content:flex-end;margin-top:8px"><div class="card" style="background:#f1f5f9;color:#111827"><div><strong>Total Credits:</strong> ${fmt.format(totalCredits)}</div><div><strong>Cumulative GPA:</strong> ${gpa}</div></div></div><div class="row" style="margin-top:16px;justify-content:space-between"><div>Administrator: ${$('#trAdmin').value||''}</div><div>Signature: _____________________________</div></div></div>`;
  $('#trOut').innerHTML=html;
  
  // Fix the event listener issue by removing the {once:true} option and properly managing listeners
  const trOut = $('#trOut');
  trOut.removeEventListener('blur', handleTranscriptEdit);
  trOut.addEventListener('blur', handleTranscriptEdit);
}

// Separate function for transcript edit handling
function handleTranscriptEdit(e) {
  const td = e.target.closest('[contenteditable]');
  if (!td) return;
  
  const key = td.getAttribute('data-tr-key');
  const field = td.getAttribute('data-tr-field');
  const value = td.textContent.trim();
  const ov = getTranscriptOverrides();
  const sId = Number($('#trStudent').value);
  
  // Validate input based on field type
  if (field === 'grade' && value && !validateGrade(value)) {
    alert('Invalid grade. Please use A+, A, A-, B+, B, B-, C+, C, C-, D+, D, or F');
    buildTranscript(); // Rebuild to reset the invalid value
    return;
  }
  
  if (field === 'credit' && value) {
    const credit = Number(value);
    if (isNaN(credit) || credit < 0 || credit > 10) {
      alert('Invalid credit value. Please enter a number between 0 and 10');
      buildTranscript(); // Rebuild to reset the invalid value
      return;
    }
  }
  
  ov[sId] = ov[sId] || {};
  ov[sId][key] = ov[sId][key] || {};
  ov[sId][key][field] = value;
  setTranscriptOverrides(ov);
  buildTranscript();
}

$('#trBuild')?.addEventListener('click', buildTranscript);
$('#trPrint')?.addEventListener('click', ()=>window.print());

/* Diploma */
async function buildDiploma(){ const stId=Number($('#dpStudent').value); if(!stId){ alert('Choose a student'); return; } const st=(await listStudents()).find(s=>s.id===stId); const school=getSettings().name; const date=$('#dpDate').value||todayISO(); const place=$('#dpPlace').value||'Kansas City, Missouri'; const tA=$('#dpTitleA').value||'Administrator'; const tB=$('#dpTitleB').value||'Parent/Guardian'; const html=`<div class="diploma-page"><div class="watermark"></div><div style="text-align:center;font-family:Georgia,serif"><div style="font-size:2rem;font-weight:700">${school}</div><div style="margin-top:8px;font-size:1rem;letter-spacing:.08em">Kansas City, Missouri</div><div style="margin-top:24px;font-size:1.4rem">Diploma of High School Graduation</div><div style="margin-top:24px">This certifies that</div><div style="margin-top:6px;font-size:2.2rem;font-weight:800">${st?.name||''}</div><div style="margin-top:6px">has satisfactorily completed a course of study prescribed for graduation and is hereby awarded this diploma.</div><div style="margin-top:6px">Given at ${place}, this ${date}.</div></div><div class="row" style="margin-top:48px;justify-content:space-between"><div style="text-align:center;flex:1"><div style="height:48px;border-bottom:1px solid #1f2937;margin:0 24px"></div><div class="muted">${tA}</div></div><div style="text-align:center;flex:1"><div style="height:48px;border-bottom:1px solid #1f2937;margin:0 24px"></div><div class="muted">${tB}</div></div></div></div>`; $('#dpOut').innerHTML=html; }
$('#dpPreview')?.addEventListener('click', buildDiploma);
$('#dpPrint')?.addEventListener('click', ()=>window.print());

/* Filters & misc */
['dashStudent','dashYear','lgYearFilter','lgStudentFilter','lgSubjectFilter'].forEach(id=>{ document.getElementById(id)?.addEventListener('change', ()=>{ if(id.startsWith('dash')) renderDashboard(); else renderLogsTable(); }); });
['pfYearFilter','pfStudentFilter','pfSubjectFilter'].forEach(id=>{ document.getElementById(id)?.addEventListener('change', renderPortfolio); });
['rpStudent','rpYear','rpGroupBy'].forEach(id=>{ document.getElementById(id)?.addEventListener('change', renderReports); });
$('#rpPrint')?.addEventListener('click', ()=>window.print());

// Clean up object URLs when page unloads
window.addEventListener('beforeunload', cleanupObjectUrls);

// Hamburger menu functionality
function initHamburgerMenu() {
  const hamburger = $('#hamburger');
  const nav = $('#nav');
  
  hamburger?.addEventListener('click', () => {
    hamburger.classList.toggle('active');
    nav.classList.toggle('active');
  });
  
  // Close menu when clicking on a nav link
  nav?.addEventListener('click', (e) => {
    if (e.target.tagName === 'A') {
      hamburger.classList.remove('active');
      nav.classList.remove('active');
    }
  });
  
  // Close menu when clicking outside
  document.addEventListener('click', (e) => {
    if (!hamburger.contains(e.target) && !nav.contains(e.target)) {
      hamburger.classList.remove('active');
      nav.classList.remove('active');
    }
  });
  
  // Close menu on window resize if screen becomes larger
  window.addEventListener('resize', () => {
    if (window.innerWidth > 768) {
      hamburger.classList.remove('active');
      nav.classList.remove('active');
    }
  });
}

// Enhanced initialization with error handling
async function init(){
  try {
    if (!location.hash) location.hash = '#dashboard';
    $('#qaDate').value=todayISO(); 
    $('#lgDate').value=todayISO(); 
    $('#pfDate').value=todayISO();
    $('#trIssue').value=todayISO();
    $('#dpDate').value=todayISO();
    
    await renderStudents(); 
    await renderCourses(); 
    await renderYearSelectors(); 
    await renderDashboard();
    
    // Initialize hamburger menu
    initHamburgerMenu();
    
    // Add loading states
    document.body.classList.add('loaded');
  } catch(e) {
    console.error('Initialization error:', e);
    alert('Error initializing application. Please refresh the page.');
  }
}

// Add loading indicator styles
const style = document.createElement('style');
style.textContent = `
  body:not(.loaded) { opacity: 0.7; }
  .loading { opacity: 0.5; pointer-events: none; }
  .error { color: var(--danger); }
  .success { color: var(--ok); }
  .warning { color: #f59e0b; }
  
  /* Enhanced form validation styles */
  input:invalid, select:invalid, textarea:invalid {
    border-color: var(--danger);
  }
  
  /* Better focus states */
  input:focus, select:focus, textarea:focus, button:focus {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  
  /* Improved button states */
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  /* Enhanced table hover effects */
  tr:hover {
    background: rgba(34, 197, 94, 0.05) !important;
  }
  
  /* Hamburger menu improvements */
  .hamburger:hover span {
    background: var(--accent);
  }
  
  .hamburger:focus {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  
  /* Smooth transitions for menu items */
  nav a:hover {
    background: rgba(34, 197, 94, 0.1);
    border-color: var(--accent);
  }
  
  /* Better mobile menu styling */
  @media(max-width:768px) {
    nav a:hover {
      background: rgba(34, 197, 94, 0.15);
    }
    
    .topbar .wrap h1 {
      font-size: 1.2rem;
    }
  }
`;
document.head.appendChild(style);
</script>
</body>
</html>
